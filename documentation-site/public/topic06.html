<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)</title>
    <!-- Tailwind CSS via CDN for simplicity and reliability -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            onclick="toggleSidebar()"
            class="lg:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <a
            href="index.html"
            class="ml-3 lg:ml-0 text-xl font-bold text-gray-900 tracking-tight"
          >
            <span class="text-indigo-600">Spring Boot</span> for Frontend Devs
          </a>
        </div>
        <!-- Optional Top Links -->
        <div class="hidden md:flex space-x-4">
          <a
            href="https://github.com/simplesoft-duongdt3/chu-duong-courses"
            target="_blank"
            class="text-gray-500 hover:text-gray-900 transition font-medium"
            >GitHub</a
          >
        </div>
      </div>
    </header>

    <div class="flex-1 max-w-7xl w-full mx-auto flex items-start">
      <!-- Sidebar Navigation -->
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="fixed inset-0 z-50 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-0 lg:w-64 lg:h-[calc(100vh-4rem)] lg:bg-transparent lg:border-r lg:border-gray-200 lg:sticky lg:top-16 overflow-y-auto"
      >
        <div class="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 mb-2">
            <span class="font-bold text-gray-900">Menu</span>
            <button onclick="toggleSidebar()" class="p-2 -mr-2 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-1">
          <div class="mb-4">
            <p
              class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
            >
              Ch∆∞∆°ng tr√¨nh h·ªçc
            </p>
            <a href="index.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot for Frontend Devs
        </a>
<a href="topic01.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain
        </a>
<a href="topic02.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)
        </a>
<a href="topic03.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate
        </a>
<a href="topic04.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch
        </a>
<a href="topic05.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling
        </a>
<a href="topic06.html" class="block px-2 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)
        </a>
<a href="topic07.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator)
        </a>
<a href="topic08.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration
        </a>
<a href="topic09.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading
        </a>
<a href="topic10.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database
        </a>
<a href="topic11.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 11: External API Call & Backend For Frontend (BFF)
        </a>
<a href="topic_black_holes.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging
        </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-4 sm:p-6 lg:padding-8">
        <div class="max-w-4xl mx-auto">
          <article
            class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-indigo-600 hover:prose-a:text-indigo-500 prose-img:rounded-xl shadow-none"
          >
            <h1>Ch·ªß ƒë·ªÅ 6: Spring Security &amp; JWT (Stateless Authentication)</h1>
<p>Trong Spring Boot 3, Spring Security ƒë√£ thay ƒë·ªïi ho√†n to√†n c√°ch c·∫•u h√¨nh (chuy·ªÉn sang d·∫°ng Lambda). Ch√∫ng ta s·∫Ω t·∫≠p trung v√†o c∆° ch·∫ø <strong>Stateless</strong> (kh√¥ng l∆∞u Session tr√™n server), v·ªën l√† ti√™u chu·∫©n cho c√°c ·ª©ng d·ª•ng Web/App hi·ªán ƒë·∫°i.</p>
<h3>1. L√Ω thuy·∫øt: Quy tr√¨nh &quot;Soi chi·∫øu&quot; c·ªßa Security Filter Chain</h3>
<p>Spring Security kh√¥ng ph·∫£i l√† m·ªôt ƒëo·∫°n code n·∫±m trong Controller. N√≥ l√† m·ªôt <strong>chu·ªói c√°c b·ªô l·ªçc (Filter Chain)</strong> ƒë·ª©ng ch·∫Øn tr∆∞·ªõc <code>DispatcherServlet</code>.</p>
<ol>
<li><strong>Request t·ªõi:</strong> Mang theo Header <code>Authorization: Bearer &lt;token&gt;</code>.</li>
<li><strong>JwtFilter:</strong> ƒê√¢y l√† ch·ªët ch·∫∑n quan tr·ªçng nh·∫•t b·∫°n ph·∫£i t·ª± vi·∫øt. N√≥ b√≥c t√°ch Token, ki·ªÉm tra ch·ªØ k√Ω (Signature) v√† th·ªùi h·∫°n (Expiration).</li>
<li><strong>SecurityContextHolder:</strong> N·∫øu Token h·ª£p l·ªá, Filter s·∫Ω &quot;ƒë√≥ng d·∫•u&quot; v√† l∆∞u th√¥ng tin User v√†o ƒë√¢y. C√°c t·∫ßng sau (Service/Controller) ch·ªâ c·∫ßn nh√¨n v√†o d·∫•u n√†y l√† bi·∫øt User l√† ai.</li>
<li><strong>Authorization:</strong> Ki·ªÉm tra xem User ƒë√≥ c√≥ quy·ªÅn (Role) v√†o API n√†y kh√¥ng.</li>
</ol>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh (Spring Boot 3 style)</h3>
<h4>A. JwtUtils (L·ªõp ti·ªán √≠ch ƒë·ªÉ t·∫°o v√† gi·∫£i m√£ Token)</h4>
<p>S·ª≠ d·ª•ng th∆∞ vi·ªán <code>jjwt</code>.</p>
<pre><code class="language-java">@Component
public class JwtUtils {
    private String secretKey = &quot;chuoi_bi_mat_cuc_ky_dai_va_an_toan_nay_nhe&quot;;

    public String generateToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + 86400000)) // 1 ng√†y
                .signWith(SignatureAlgorithm.HS256, secretKey)
                .compact();
    }

    public String getUsernameFromToken(String token) {
        return Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token).getBody().getSubject();
    }
}
</code></pre>
<h4>B. JwtAuthenticationFilter (Ch·ªët ch·∫∑n c·ª≠a kh·∫©u)</h4>
<p>M·ªói request ƒë·ªÅu ph·∫£i ƒëi qua ƒë√¢y.</p>
<pre><code class="language-java">public class JwtFilter extends OncePerRequestFilter {
    @Autowired private JwtUtils jwtUtils;
    @Autowired private UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) 
            throws ServletException, IOException {
        
        String authHeader = request.getHeader(&quot;Authorization&quot;);
        if (authHeader != null &amp;&amp; authHeader.startsWith(&quot;Bearer &quot;)) {
            String token = authHeader.substring(7);
            String username = jwtUtils.getUsernameFromToken(token);

            if (username != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                // &quot;ƒê√≥ng d·∫•u&quot; h·ª£p l·ªá v√†o Context
                UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities());
                SecurityContextHolder.getContext().setAuthentication(auth);
            }
        }
        chain.doFilter(request, response);
    }
}
</code></pre>
<h4>C. C·∫•u h√¨nh Security (SecurityConfig)</h4>
<p>ƒê√¢y l√† n∆°i b·∫°n ph√¢n lu·ªìng: API n√†o c√¥ng khai, API n√†o c·∫ßn ƒëƒÉng nh·∫≠p.</p>
<pre><code class="language-java">@Configuration
@EnableWebSecurity
@EnableMethodSecurity // Cho ph√©p d√πng @PreAuthorize ·ªü Controller
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -&gt; csrf.disable()) // T·∫Øt CSRF v√¨ d√πng JWT
            .sessionManagement(session -&gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -&gt; auth
                .requestMatchers(&quot;/api/auth/**&quot;).permitAll() // API ƒëƒÉng nh·∫≠p cho ph√©p t·∫•t c·∫£
                .anyRequest().authenticated() // C√≤n l·∫°i ph·∫£i c√≥ Token
            );
        
        // Th√™m JwtFilter v√†o tr∆∞·ªõc b·ªô l·ªçc UsernamePassword c·ªßa Spring
        http.addFilterBefore(jwtFilter(), UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Public vs Private API</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n l√†m trang th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠. Trang &quot;Danh s√°ch s·∫£n ph·∫©m&quot; ai c≈©ng xem ƒë∆∞·ª£c, nh∆∞ng &quot;Th√™m v√†o gi·ªè h√†ng&quot; th√¨ ph·∫£i ƒëƒÉng nh·∫≠p.</li>
<li><strong>Gi·∫£i ph√°p:</strong> C·∫•u h√¨nh <code>requestMatchers(&quot;/api/products/**&quot;).permitAll()</code> trong SecurityConfig. L√∫c n√†y, n·∫øu kh√°ch v√£ng lai v√†o xem, <code>JwtFilter</code> s·∫Ω ch·∫°y nh∆∞ng kh√¥ng t√¨m th·∫•y Token, <code>SecurityContext</code> tr·ªëng, nh∆∞ng Spring v·∫´n cho qua v√¨ URL n√†y n·∫±m trong danh s√°ch <code>permitAll</code>.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Ph√¢n quy·ªÅn theo Role (Admin/User)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën ch·ªâ Admin m·ªõi c√≥ quy·ªÅn x√≥a s·∫£n ph·∫©m.</li>
<li><strong>Gi·∫£i ph√°p:</strong> S·ª≠ d·ª•ng Annotation ngay t·∫°i Controller:</li>
</ul>
<pre><code class="language-java">@DeleteMapping(&quot;/{id}&quot;)
@PreAuthorize(&quot;hasRole(&#39;ADMIN&#39;)&quot;)
public void delete(@PathVariable Long id) { ... }
</code></pre>
<p>N·∫øu m·ªôt User th∆∞·ªùng c·ªë t√¨nh g·ªçi API n√†y b·∫±ng Postman, Spring s·∫Ω tr·∫£ v·ªÅ m√£ <code>403 Forbidden</code> ngay l·∫≠p t·ª©c.</p>
<p><strong>T√¨nh hu·ªëng 3: Token h·∫øt h·∫°n (Token Expiration/Refresh)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Token ch·ªâ c√≥ h·∫°n 1 ti·∫øng ƒë·ªÉ b·∫£o m·∫≠t. Frontend l√†m th·∫ø n√†o ƒë·ªÉ user kh√¥ng ph·∫£i ƒëƒÉng nh·∫≠p l·∫°i li√™n t·ª•c?</li>
<li><strong>Gi·∫£i ph√°p:</strong> Khi <code>JwtFilter</code> th·∫•y Token h·∫øt h·∫°n, n√≥ tr·∫£ v·ªÅ <code>401 Unauthorized</code>. Frontend (Axios Interceptor) b·∫Øt m√£ 401 n√†y, g·ªçi API <code>/api/auth/refresh</code> (d√πng <strong>Refresh Token</strong> l∆∞u trong HttpOnly Cookie) ƒë·ªÉ l·∫•y Access Token m·ªõi r·ªìi t·ª± ƒë·ªông th·ª±c hi·ªán l·∫°i request c≈©. Ng∆∞·ªùi d√πng s·∫Ω kh√¥ng c·∫£m th·∫•y g√¨ c·∫£ (Silent Refresh).</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh cho Dev Frontend</h3>
<table>
<thead>
<tr>
<th>Kh√°i ni·ªám</th>
<th>Frontend</th>
<th>Backend (Spring Security)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Authentication</strong></td>
<td>G·ª≠i Username/Password</td>
<td>X√°c th·ª±c v√† tr·∫£ v·ªÅ JWT</td>
</tr>
<tr>
<td><strong>Authorization</strong></td>
<td>·∫®n/Hi·ªán n√∫t tr√™n UI</td>
<td>Ch·∫∑n API t·ª´ t·∫ßng Filter (403)</td>
</tr>
<tr>
<td><strong>Tr·∫°ng th√°i (State)</strong></td>
<td>Gi·ªØ Token trong Memory/Storage</td>
<td>Kh√¥ng gi·ªØ g√¨ (Stateless), gi·∫£i m√£ Token m·ªói request</td>
</tr>
<tr>
<td><strong>B·∫£o m·∫≠t</strong></td>
<td>Ch·ªëng XSS (LocalStorage)</td>
<td>Ch·ªëng SQL Injection, CORS, Brute force</td>
</tr>
</tbody></table>
<hr>
<p><strong>L·ªùi khuy√™n t·ª´ &quot;h·∫≠u ph∆∞∆°ng&quot;:</strong> ƒê·ª´ng bao gi·ªù l∆∞u th√¥ng tin nh·∫°y c·∫£m (nh∆∞ quy·ªÅn h·∫°n hay s·ªë d∆∞) v√†o Payload c·ªßa JWT m√† kh√¥ng c√≥ c∆° ch·∫ø ki·ªÉm tra l·∫°i ·ªü DB. JWT c√≥ th·ªÉ b·ªã gi·∫£i m√£ (Decode) c·ª±c d·ªÖ d√†ng b·ªüi c√°c c√¥ng c·ª• online, n√≥ ch·ªâ an to√†n v√¨ c√≥ ph·∫ßn <strong>Signature</strong> ƒë·ªÉ Backend bi·∫øt n√≥ c√≥ b·ªã s·ª≠a ƒë·ªïi hay kh√¥ng th√¥i.</p>
<hr>
<p>Ch√†o b·∫°n! Vi·ªác hi·ªÉu r√µ <strong>Refresh Token Flow</strong> l√† ƒëi·ªÉm ph√¢n bi·ªát gi·ªØa m·ªôt h·ªá th·ªëng &quot;ch·∫°y ƒë∆∞·ª£c&quot; v√† m·ªôt h·ªá th·ªëng &quot;ch·∫°y an to√†n, chuy√™n nghi·ªáp&quot;.</p>
<p>N·∫øu Access Token (AT) gi·ªëng nh∆∞ m·ªôt c√°i <strong>v√© xem phim</strong> (ng·∫Øn h·∫°n, d√πng ƒë·ªÉ v√†o c·ª≠a), th√¨ Refresh Token (RT) gi·ªëng nh∆∞ c√°i <strong>ch·ª©ng minh th∆∞</strong> (d√†i h·∫°n, d√πng ƒë·ªÉ xin c·∫•p l·∫°i v√© m·ªõi m√† kh√¥ng c·∫ßn check-in l·∫°i t·ª´ ƒë·∫ßu).</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 6.1: Refresh Token Flow - Duy tr√¨ phi√™n ƒëƒÉng nh·∫≠p an to√†n</h1>
<h3>1. L√Ω thuy·∫øt: T·∫°i sao kh√¥ng d√πng Access Token v√¥ h·∫°n?</h3>
<p>N·∫øu b·∫°n ƒë·ªÉ AT c√≥ h·∫°n d√πng 1 nƒÉm, khi user b·ªã l·ªô Token, k·∫ª x·∫•u s·∫Ω c√≥ to√†n quy·ªÅn truy c·∫≠p trong 1 nƒÉm ƒë√≥ m√† b·∫°n kh√¥ng c√≥ c√°ch n√†o ngƒÉn ch·∫∑n (v√¨ JWT l√† stateless).<br><strong>Gi·∫£i ph√°p:</strong></p>
<ul>
<li><strong>Access Token (AT):</strong> S·ªëng c·ª±c ng·∫Øn (15 - 30 ph√∫t). N·∫øu m·∫•t, thi·ªát h·∫°i nh·ªè.</li>
<li><strong>Refresh Token (RT):</strong> S·ªëng d√†i (7 - 30 ng√†y). Ch·ªâ d√πng ƒë·ªÉ ƒë·ªïi l·∫•y AT m·ªõi. RT th∆∞·ªùng ƒë∆∞·ª£c Backend l∆∞u v√†o Database ƒë·ªÉ c√≥ th·ªÉ <strong>thu h·ªìi (Revoke)</strong> khi c·∫ßn.</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. Refresh Token Entity (L∆∞u v√†o DB)</h4>
<p>Kh√°c v·ªõi AT (kh√¥ng l∆∞u DB), RT c·∫ßn ƒë∆∞·ª£c l∆∞u l·∫°i ƒë·ªÉ ch√∫ng ta c√≥ th·ªÉ &quot;h·ªßy&quot; quy·ªÅn truy c·∫≠p c·ªßa User n·∫øu ph√°t hi·ªán nghi v·∫•n.</p>
<pre><code class="language-java">@Entity
@Getter @Setter
public class RefreshToken {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true)
    private String token;

    @Column(nullable = false)
    private Instant expiryDate;

    @OneToOne
    @JoinColumn(name = &quot;user_id&quot;, referencedColumnName = &quot;id&quot;)
    private User user;
}
</code></pre>
<h4>B. Refresh Service (X·ª≠ l√Ω logic ƒë·ªïi v√©)</h4>
<pre><code class="language-java">@Service
public class RefreshTokenService {
    @Autowired private RefreshTokenRepository refreshTokenRepository;
    @Autowired private JwtUtils jwtUtils;

    public String createRefreshToken(User user) {
        RefreshToken rt = new RefreshToken();
        rt.setUser(user);
        rt.setToken(UUID.randomUUID().toString());
        rt.setExpiryDate(Instant.now().plusSeconds(86400 * 7)); // 7 ng√†y
        return refreshTokenRepository.save(rt).getToken();
    }

    @Transactional
    public String refreshAccessToken(String requestToken) {
        return refreshTokenRepository.findByToken(requestToken)
            .filter(rt -&gt; rt.getExpiryDate().isAfter(Instant.now())) // Check h·∫øt h·∫°n
            .map(rt -&gt; jwtUtils.generateAccessToken(rt.getUser().getUsername())) // T·∫°o AT m·ªõi
            .orElseThrow(() -&gt; new AppException(ErrorCode.TOKEN_EXPIRED));
    }
}
</code></pre>
<h4>C. C·∫•u h√¨nh HttpOnly Cookie (B·∫£o m·∫≠t t·ªëi th∆∞·ª£ng)</h4>
<p>Thay v√¨ tr·∫£ RT v·ªÅ JSON cho Frontend l∆∞u v√†o LocalStorage (d·ªÖ b·ªã XSS), Backend n√™n tr·∫£ v·ªÅ qua <strong>HttpOnly Cookie</strong>. Tr√¨nh duy·ªát s·∫Ω t·ª± gi·ªØ v√† g·ª≠i l√™n, Javascript kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c.</p>
<pre><code class="language-java">// Trong AuthController
ResponseCookie cookie = ResponseCookie.from(&quot;refreshToken&quot;, refreshToken)
    .httpOnly(true)
    .secure(true) // Ch·ªâ g·ª≠i qua HTTPS
    .path(&quot;/api/auth/refresh&quot;) // Ch·ªâ g·ª≠i cookie khi g·ªçi ƒë√∫ng API n√†y
    .maxAge(7 * 24 * 60 * 60)
    .build();

return ResponseEntity.ok()
    .header(HttpHeaders.SET_COOKIE, cookie.toString())
    .body(new JwtResponse(accessToken));
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Ch·ª©c nƒÉng &quot;ƒêƒÉng xu·∫•t kh·ªèi t·∫•t c·∫£ thi·∫øt b·ªã&quot;</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User b·ªã m·∫•t ƒëi·ªán tho·∫°i v√† mu·ªën ƒëƒÉng xu·∫•t t√†i kho·∫£n t·ª´ xa.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Backend ch·ªâ c·∫ßn ch·∫°y l·ªánh <code>DELETE FROM refresh_tokens WHERE user_id = :id</code>. Khi ƒë√≥, d√π k·∫ª x·∫•u c√≥ gi·ªØ Access Token th√¨ c≈©ng ch·ªâ d√πng ƒë∆∞·ª£c t·ªëi ƒëa v√†i ph√∫t n·ªØa. Khi AT h·∫øt h·∫°n, ch√∫ng kh√¥ng th·ªÉ d√πng RT ƒë·ªÉ l·∫•y c√°i m·ªõi v√¨ RT ƒë√£ b·ªã x√≥a kh·ªèi DB.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Refresh Token Rotation (Xoay v√≤ng Token)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> ƒê·ªÉ tƒÉng b·∫£o m·∫≠t, m·ªói l·∫ßn User d√πng RT ƒë·ªÉ l·∫•y AT m·ªõi, Backend s·∫Ω x√≥a lu√¥n RT c≈© v√† c·∫•p m·ªôt RT m·ªõi tinh.</li>
<li><strong>L·ª£i √≠ch:</strong> N·∫øu k·∫ª x·∫•u l·∫•y tr·ªôm ƒë∆∞·ª£c RT v√† d√πng n√≥ tr∆∞·ªõc User, khi User th·∫≠t d√πng l·∫°i RT c≈© ƒë√≥, Backend th·∫•y RT n√†y ƒë√£ ƒë∆∞·ª£c d√πng r·ªìi -&gt; C·∫£nh b√°o h·ªá th·ªëng b·ªã x√¢m nh·∫≠p v√† v√¥ hi·ªáu h√≥a to√†n b·ªô phi√™n l√†m vi·ªác c·ªßa User ƒë√≥ ngay l·∫≠p t·ª©c.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Silent Refresh ph√≠a Frontend</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n kh√¥ng mu·ªën tr·∫£i nghi·ªám c·ªßa User b·ªã gi√°n ƒëo·∫°n (hi·ªán loading) khi ƒëang cu·ªôn trang m√† Token h·∫øt h·∫°n.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Frontend c√†i ƒë·∫∑t m·ªôt <code>Axios Interceptor</code>. Khi nh·∫≠n m√£ <code>401</code>, n√≥ s·∫Ω t·∫°m d·ª´ng c√°c request kh√°c, g·ªçi ng·∫ßm API <code>/refresh</code>. Sau khi c√≥ AT m·ªõi, n√≥ t·ª± ƒë·ªông th·ª±c hi·ªán l·∫°i c√°c request c≈©. User v·∫´n th·∫•y trang web ch·∫°y m∆∞·ª£t m√† d√π th·ª±c t·∫ø ƒë√£ ƒë∆∞·ª£c c·∫•p &quot;v√©&quot; m·ªõi.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh cho Dev Frontend</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>Access Token</th>
<th>Refresh Token</th>
</tr>
</thead>
<tbody><tr>
<td><strong>N∆°i l∆∞u (Khuy√™n d√πng)</strong></td>
<td>Memory (Bi·∫øn trong JS)</td>
<td><strong>HttpOnly Cookie</strong></td>
</tr>
<tr>
<td><strong>Th·ªùi gian s·ªëng</strong></td>
<td>Ng·∫Øn (15 ph√∫t)</td>
<td>D√†i (Nhi·ªÅu ng√†y)</td>
</tr>
<tr>
<td><strong>L∆∞u ·ªü Backend?</strong></td>
<td>Kh√¥ng (Stateless)</td>
<td><strong>C√≥ (ƒê·ªÉ ki·ªÉm so√°t/h·ªßy)</strong></td>
</tr>
<tr>
<td><strong>K√≠ch th∆∞·ªõc</strong></td>
<td>L·ªõn (Ch·ª©a nhi·ªÅu Claim)</td>
<td>Nh·ªè (Th∆∞·ªùng l√† m·ªôt chu·ªói UUID)</td>
</tr>
</tbody></table>
<hr>
<p><strong>Ghi ch√∫ quan tr·ªçng:</strong> V·ªõi Spring Boot 3, khi d√πng <code>Cookie</code>, b·∫°n c·∫ßn ch√∫ √Ω c·∫•u h√¨nh <strong>CORS</strong> <code>allowCredentials(true)</code> ƒë·ªÉ tr√¨nh duy·ªát cho ph√©p g·ª≠i Cookie ƒëi c√πng request API.</p>

          </article>

          <!-- Navigation Footer (Next/Prev) -->
          <div class="mt-12 pt-8 border-t border-gray-200 flex justify-between">
            <a href="topic05.html" class="text-indigo-600 font-medium hover:text-indigo-800">‚Üê Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling</a><a href="topic07.html" class="text-indigo-600 font-medium hover:text-indigo-800">Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator) ‚Üí</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div
      onclick="toggleSidebar()"
      id="overlay"
      class="fixed inset-0 bg-black/50 z-10 lg:hidden hidden"
      style="display: none"
    ></div>
    <script>
      // Simple overlay logic
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      // Sync overlay with sidebar state check if needed, but for "simplest" just toggle visibility in CSS or JS.
      // Actually, let's keep it simple.
    </script>
  </body>
</html>
