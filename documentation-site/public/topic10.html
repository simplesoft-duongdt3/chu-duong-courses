<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database</title>
    <!-- Tailwind CSS via CDN for simplicity and reliability -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            onclick="toggleSidebar()"
            class="lg:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <a
            href="index.html"
            class="ml-3 lg:ml-0 text-xl font-bold text-gray-900 tracking-tight"
          >
            <span class="text-indigo-600">Spring Boot</span> for Frontend Devs
          </a>
        </div>
        <!-- Optional Top Links -->
        <div class="hidden md:flex space-x-4">
          <a
            href="https://github.com/simplesoft-duongdt3/chu-duong-courses"
            target="_blank"
            class="text-gray-500 hover:text-gray-900 transition font-medium"
            >GitHub</a
          >
        </div>
      </div>
    </header>

    <div class="flex-1 max-w-7xl w-full mx-auto flex items-start">
      <!-- Sidebar Navigation -->
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="fixed inset-0 z-50 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-0 lg:w-64 lg:h-[calc(100vh-4rem)] lg:bg-transparent lg:border-r lg:border-gray-200 lg:sticky lg:top-16 overflow-y-auto"
      >
        <div class="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 mb-2">
            <span class="font-bold text-gray-900">Menu</span>
            <button onclick="toggleSidebar()" class="p-2 -mr-2 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-1">
          <div class="mb-4">
            <p
              class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
            >
              Ch∆∞∆°ng tr√¨nh h·ªçc
            </p>
            <a href="index.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot for Frontend Devs
        </a>
<a href="topic01.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain
        </a>
<a href="topic02.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)
        </a>
<a href="topic03.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate
        </a>
<a href="topic04.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch
        </a>
<a href="topic05.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling
        </a>
<a href="topic06.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)
        </a>
<a href="topic07.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator)
        </a>
<a href="topic08.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration
        </a>
<a href="topic09.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading
        </a>
<a href="topic10.html" class="block px-2 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database
        </a>
<a href="topic_black_holes.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging
        </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-4 sm:p-6 lg:padding-8">
        <div class="max-w-4xl mx-auto">
          <article
            class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-indigo-600 hover:prose-a:text-indigo-500 prose-img:rounded-xl shadow-none"
          >
            <h1>Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database</h1>
<hr>
<p>Ch√†o b·∫°n! ƒê√¢y l√† m·ªôt ch·ªß ƒë·ªÅ c·ª±c k·ª≥ quan tr·ªçng trong c√°c d·ª± √°n th·ª±c t·∫ø. N·∫øu ·ªü Frontend, b·∫°n c√≥ &quot;Undo/Redo&quot; ho·∫∑c &quot;History&quot; trong b·ªô nh·ªõ t·∫°m, th√¨ ·ªü Backend, <strong>Audit Log</strong> gi·ªëng nh∆∞ m·ªôt chi·∫øc camera an ninh 24/7. N√≥ ghi l·∫°i m·ªçi bi·∫øn ƒë·ªông c·ªßa d·ªØ li·ªáu: &quot;Ai ƒë√£ t·∫°o?&quot;, &quot;Khi n√†o s·ª≠a?&quot;, v√† &quot;Tr∆∞·ªõc khi s·ª≠a n√≥ tr√¥ng th·∫ø n√†o?&quot;.</p>
<p>Trong Spring Boot 3, ch√∫ng ta chia Audit Log l√†m 2 c·∫•p ƒë·ªô:</p>
<ol>
<li><strong>Basic Auditing:</strong> Ch·ªâ ghi l·∫°i d·∫•u m·ªëc (Ng√†y t·∫°o, ng√†y s·ª≠a, ng∆∞·ªùi t·∫°o, ng∆∞·ªùi s·ª≠a).</li>
<li><strong>Full Auditing (Versioning):</strong> Ghi l·∫°i to√†n b·ªô l·ªãch s·ª≠ thay ƒë·ªïi c·ªßa t·ª´ng tr∆∞·ªùng d·ªØ li·ªáu (D√πng Hibernate Envers).</li>
</ol>
<h3>1. L√Ω thuy·∫øt: C∆° ch·∫ø &quot;L·∫Øng nghe&quot; (Entity Listeners)</h3>
<p>Thay v√¨ b·∫°n ph·∫£i vi·∫øt tay <code>product.setCreatedAt(new Date())</code> trong m·ªçi h√†m Service, Spring Data JPA s·ª≠ d·ª•ng c√°c <strong>Listeners</strong>. Khi m·ªôt Entity chu·∫©n b·ªã ƒë∆∞·ª£c l∆∞u xu·ªëng DB, Spring s·∫Ω t·ª± ƒë·ªông &quot;nh·∫£y v√†o&quot; ƒë·ªÉ ƒëi·ªÅn c√°c th√¥ng tin n√†y.</p>
<ul>
<li><strong>@CreatedDate / @LastModifiedDate:</strong> T·ª± ƒë·ªông l·∫•y th·ªùi gian h·ªá th·ªëng.</li>
<li><strong>@CreatedBy / @LastModifiedBy:</strong> L·∫•y th√¥ng tin User hi·ªán t·∫°i t·ª´ <code>SecurityContext</code> (Spring Security).</li>
<li><strong>Hibernate Envers:</strong> T·∫°o ra c√°c b·∫£ng ph·ª• (c√≥ ƒëu√¥i <code>_AUD</code>) ƒë·ªÉ l∆∞u l·∫°i t·ª´ng phi√™n b·∫£n c·ªßa d·ªØ li·ªáu m·ªói khi c√≥ l·ªánh <code>UPDATE</code> ho·∫∑c <code>DELETE</code>.</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. C·∫•u h√¨nh c∆° b·∫£n</h4>
<p>ƒê·∫ßu ti√™n, b·∫°n c·∫ßn b·∫≠t t√≠nh nƒÉng Auditing trong App.</p>
<pre><code class="language-java">@Configuration
@EnableJpaAuditing(auditorAwareRef = &quot;auditorProvider&quot;)
public class AuditConfig {
    @Bean
    public AuditorAware&lt;String&gt; auditorProvider() {
        // Tr·∫£ v·ªÅ username t·ª´ Spring Security
        return () -&gt; Optional.ofNullable(SecurityContextHolder.getContext().getAuthentication())
                .map(Authentication::getName);
    }
}
</code></pre>
<h4>B. T·∫°o Base Entity (D√πng chung cho m·ªçi b·∫£ng)</h4>
<p>B·∫°n kh√¥ng mu·ªën copy-paste 4 tr∆∞·ªùng n√†y v√†o t·∫•t c·∫£ c√°c Class. H√£y d√πng <code>@MappedSuperclass</code>.</p>
<pre><code class="language-java">@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
@Getter @Setter
public abstract class BaseEntity {
    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;

    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String updatedBy;
}
</code></pre>
<h4>C. Full Audit v·ªõi Hibernate Envers</h4>
<p>ƒê·ªÉ ghi l·∫°i l·ªãch s·ª≠ &quot;tr∆∞·ªõc v√† sau&quot;, b·∫°n ch·ªâ c·∫ßn th√™m th∆∞ vi·ªán <code>hibernate-envers</code> v√† d√πng Annotation <code>@Audited</code>.</p>
<pre><code class="language-java">@Entity
@Audited // &lt;--- Ph√©p m√†u ·ªü ƒë√¢y: M·ªçi thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o b·∫£ng product_aud
public class Product extends BaseEntity {
    @Id @GeneratedValue
    private Long id;
    private String name;
    private Double price;
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Gi·∫£i quy·∫øt tranh ch·∫•p &quot;Ai ƒë√£ ƒë·ªïi gi√°?&quot;</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Gi√° s·∫£n ph·∫©m b·ªóng d∆∞ng gi·∫£m t·ª´ 10tr xu·ªëng 1tr khi·∫øn c√¥ng ty l·ªó n·∫∑ng. Nh√¢n vi√™n A ƒë·ªï l·ªói cho nh√¢n vi√™n B.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Nh·ªù <strong>Full Audit</strong>, b·∫°n truy v·∫•n b·∫£ng <code>product_aud</code>. B·∫°n th·∫•y r√µ r√†ng v√†o l√∫c 2:00 s√°ng, Account c·ªßa nh√¢n vi√™n A ƒë√£ th·ª±c hi·ªán l·ªánh Update. B·∫°n th·∫≠m ch√≠ th·∫•y ƒë∆∞·ª£c gi√° c≈© l√† 10tr v√† gi√° m·ªõi l√† 1tr.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Ch·ª©c nƒÉng &quot;Kh√¥i ph·ª•c d·ªØ li·ªáu ƒë√£ x√≥a&quot; (Restore)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User l·ª° tay x√≥a m·ªôt b√†i vi·∫øt quan tr·ªçng.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Hibernate Envers kh√¥ng ch·ªâ l∆∞u thay ƒë·ªïi m√† l∆∞u c·∫£ b·∫£n ghi tr∆∞·ªõc khi b·ªã x√≥a. B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng l·∫•y l·∫°i d·ªØ li·ªáu t·ª´ &quot;qu√° kh·ª©&quot; v√† l∆∞u ng∆∞·ª£c l·∫°i v√†o b·∫£ng ch√≠nh m√† kh√¥ng c·∫ßn l·ª•c t√¨m b·∫£n backup DB.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Hi·ªÉn th·ªã &quot;L·ªãch s·ª≠ c·∫≠p nh·∫≠t&quot; cho ng∆∞·ªùi d√πng</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Trong c√°c ·ª©ng d·ª•ng nh∆∞ Google Docs hay Jira, user mu·ªën xem danh s√°ch c√°c l·∫ßn ch·ªânh s·ª≠a.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Thay v√¨ t·ª± thi·∫øt k·∫ø b·∫£ng l·ªãch s·ª≠ ph·ª©c t·∫°p, b·∫°n d√πng <code>AuditReader</code> c·ªßa Envers ƒë·ªÉ l·∫•y ra danh s√°ch c√°c <code>Revision</code>. M·ªói Revision s·∫Ω cho bi·∫øt ai ƒë√£ s·ª≠a tr∆∞·ªùng n√†o v√†o l√∫c n√†o ƒë·ªÉ hi·ªÉn th·ªã l√™n UI cho Frontend.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh cho &quot;D√¢n App/Frontend&quot;</h3>
<table>
<thead>
<tr>
<th>Ti√™u ch√≠</th>
<th>Manual Coding (T·ª± code)</th>
<th>JPA Auditing &amp; Envers</th>
</tr>
</thead>
<tbody><tr>
<td><strong>C√¥ng s·ª©c</strong></td>
<td>Ph·∫£i nh·ªõ set Date/User ·ªü m·ªçi n∆°i</td>
<td>C·∫•u h√¨nh 1 l·∫ßn, ch·∫°y m√£i m√£i</td>
</tr>
<tr>
<td><strong>ƒê·ªô ch√≠nh x√°c</strong></td>
<td>D·ªÖ qu√™n, d·ªÖ sai l·ªách m√∫i gi·ªù</td>
<td>ƒê·ªìng b·ªô ho√†n to√†n ·ªü t·∫ßng Persistence</td>
</tr>
<tr>
<td><strong>D·ªØ li·ªáu l·ªãch s·ª≠</strong></td>
<td>Th∆∞·ªùng ch·ªâ l∆∞u b·∫£n cu·ªëi c√πng</td>
<td>L∆∞u t·∫•t c·∫£ c√°c version (Time Travel)</td>
</tr>
<tr>
<td><strong>Hi·ªáu nƒÉng</strong></td>
<td>Kh√¥ng ·∫£nh h∆∞·ªüng ƒë√°ng k·ªÉ</td>
<td>T·ªën th√™m dung l∆∞·ª£ng DB (do b·∫£ng Audit)</td>
</tr>
</tbody></table>
<hr>
<h3>‚ö†Ô∏è L∆∞u √Ω cho b·∫°n:</h3>
<p>Vi·ªác d√πng <strong>Full Audit</strong> (Envers) s·∫Ω khi·∫øn Database c·ªßa b·∫°n ph√¨nh to r·∫•t nhanh v√¨ m·ªói l·∫ßn s·ª≠a 1 d·∫•u ph·∫©y n√≥ c≈©ng t·∫°o ra 1 d√≤ng m·ªõi trong b·∫£ng <code>_AUD</code>.</p>
<ul>
<li><strong>M·∫πo:</strong> Ch·ªâ d√πng <code>@Audited</code> cho nh·ªØng b·∫£ng th·ª±c s·ª± quan tr·ªçng (Giao d·ªãch, User, C·∫•u h√¨nh h·ªá th·ªëng). ƒê·ª´ng d√πng cho nh·ªØng b·∫£ng ch·ª©a log r√°c ho·∫∑c d·ªØ li·ªáu thay ƒë·ªïi theo t·ª´ng gi√¢y.</li>
</ul>
<hr>
<p>N·∫øu ·ªü Frontend b·∫°n d√πng <code>git</code> ƒë·ªÉ qu·∫£n l√Ω phi√™n b·∫£n code, th√¨ ·ªü Backend, ch√∫ng ta d√πng <strong>Database Migration</strong> (Flyway ho·∫∑c Liquibase) ƒë·ªÉ qu·∫£n l√Ω phi√™n b·∫£n c·ªßa c·∫•u tr√∫c b·∫£ng (Schema).</p>
<p>Tuy·ªát ƒë·ªëi kh√¥ng n√™n ƒë·ªÉ Hibernate t·ª± t·∫°o b·∫£ng b·∫±ng <code>ddl-auto: update</code> ·ªü m√¥i tr∆∞·ªùng th·ª±c t·∫ø. D∆∞·ªõi ƒë√¢y l√† c√°ch b·∫°n thi·∫øt k·∫ø c√°c file Migration (SQL) ƒë·ªÉ h·ªó tr·ª£ t√≠nh nƒÉng <strong>Audit Log</strong> ƒë√£ th·∫£o lu·∫≠n.</p>
<hr>
<h1>Database Migration cho Audit Log (Flyway/SQL style)</h1>
<h3>1. Migration cho Basic Auditing (Created/Updated)</h3>
<p>Khi b·∫°n d√πng <code>@CreatedDate</code>, <code>@LastModifiedBy</code>, c√°c c·ªôt n√†y ph·∫£i <strong>n·∫±m tr·ª±c ti·∫øp</strong> trong b·∫£ng ch√≠nh c·ªßa b·∫°n.</p>
<p>**File: <code>V1__create_product_table.sql**</code></p>
<pre><code class="language-sql">CREATE TABLE products (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DOUBLE NOT NULL,
    
    -- C√°c c·ªôt ph·ª•c v·ª• Basic Audit
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(50),
    updated_by VARCHAR(50)
);
</code></pre>
<hr>
<h3>2. Migration cho Full Audit (Hibernate Envers)</h3>
<p>Khi b·∫°n th√™m Annotation <code>@Audited</code>, Hibernate Envers y√™u c·∫ßu 2 lo·∫°i b·∫£ng:</p>
<h4>A. B·∫£ng th√¥ng tin phi√™n b·∫£n chung (<code>REVINFO</code>)</h4>
<p>ƒê√¢y l√† b·∫£ng &quot;t·ªïng&quot;, ghi l·∫°i m·ªói khi c√≥ m·ªôt giao d·ªãch (transaction) b·∫•t k·ª≥ l√†m thay ƒë·ªïi d·ªØ li·ªáu. M·ªôt h√†ng trong b·∫£ng n√†y ƒë·∫°i di·ªán cho m·ªôt l·∫ßn nh·∫•n n√∫t &quot;Save&quot; c·ªßa user.</p>
<p>**File: <code>V2__create_envers_revinfo.sql**</code></p>
<pre><code class="language-sql">CREATE TABLE revinfo (
    rev INTEGER NOT NULL AUTO_INCREMENT, -- ID c·ªßa phi√™n b·∫£n (Revision ID)
    revtstmp BIGINT,                     -- Th·ªùi gian x·∫£y ra thay ƒë·ªïi (Unix Timestamp)
    PRIMARY KEY (rev)
);
</code></pre>
<h4>B. B·∫£ng l·ªãch s·ª≠ th·ª±c th·ªÉ (<code>{table_name}_AUD</code>)</h4>
<p>M·ªói b·∫£ng c·∫ßn Audit s·∫Ω c√≥ m·ªôt b·∫£ng &quot;b√≥ng ma&quot; ƒëi k√®m. N√≥ l∆∞u l·∫°i tr·∫°ng th√°i c·ªßa d·ªØ li·ªáu t·∫°i th·ªùi ƒëi·ªÉm ƒë√≥.</p>
<p>**File: <code>V3__create_product_audit_table.sql**</code></p>
<pre><code class="language-sql">CREATE TABLE products_aud (
    id BIGINT NOT NULL,    -- ID c·ªßa product
    rev INTEGER NOT NULL,  -- ID phi√™n b·∫£n (kh√≥a ngo·∫°i sang b·∫£ng revinfo)
    revtype TINYINT,       -- Lo·∫°i thay ƒë·ªïi: 0 (Add), 1 (Update), 2 (Delete)
    
    -- Copy l·∫°i c√°c c·ªôt c·∫ßn theo d√µi l·ªãch s·ª≠ t·ª´ b·∫£ng ch√≠nh
    name VARCHAR(255),
    price DOUBLE,
    
    PRIMARY KEY (id, rev),
    CONSTRAINT fk_product_aud_revinfo FOREIGN KEY (rev) REFERENCES revinfo (rev)
);
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø &amp; C√°ch Migration v·∫≠n h√†nh</h3>
<p><strong>T√¨nh hu·ªëng 1: Th√™m Audit v√†o m·ªôt b·∫£ng ƒë√£ c√≥ s·∫µn d·ªØ li·ªáu</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫£ng <code>users</code> ƒë√£ ch·∫°y 1 nƒÉm, gi·ªù s·∫øp m·ªõi y√™u c·∫ßu th√™m c·ªôt <code>created_at</code>.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·∫°n t·∫°o m·ªôt file migration m·ªõi. L∆∞u √Ω ph·∫£i set gi√° tr·ªã m·∫∑c ƒë·ªãnh cho d·ªØ li·ªáu c≈©, n·∫øu kh√¥ng DB s·∫Ω b√°o l·ªói <code>NOT NULL</code>.</li>
</ul>
<pre><code class="language-sql">ALTER TABLE users ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
</code></pre>
<p><strong>T√¨nh hu·ªëng 2: Schema thay ƒë·ªïi (Th√™m c·ªôt m·ªõi)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n th√™m c·ªôt <code>description</code> v√†o b·∫£ng <code>Product</code>.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·∫°n ph·∫£i th√™m c·ªôt n√†y v√†o <strong>c·∫£ 2 n∆°i</strong>: b·∫£ng <code>products</code> v√† b·∫£ng <code>products_aud</code>. N·∫øu qu√™n th√™m ·ªü b·∫£ng <code>_aud</code>, Hibernate Envers s·∫Ω n√©m l·ªói ngay khi b·∫°n c·ªë g·∫Øng update d·ªØ li·ªáu.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Qu·∫£n l√Ω Revision l·ªìng nhau</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> M·ªôt l·∫ßn thanh to√°n (1 Revision) l√†m thay ƒë·ªïi c·∫£ b·∫£ng <code>Order</code> v√† b·∫£ng <code>Wallet</code>.</li>
<li><strong>C∆° ch·∫ø:</strong> C·∫£ 2 b·∫£ng <code>orders_aud</code> v√† <code>wallets_aud</code> s·∫Ω c√πng tr·ªè chung v·ªÅ m·ªôt <code>rev</code> duy nh·∫•t trong b·∫£ng <code>revinfo</code>. Khi truy v·∫•n, b·∫°n ch·ªâ c·∫ßn t√¨m theo <code>rev</code> ƒë√≥ l√† th·∫•y to√†n b·ªô &quot;hi·ªán tr∆∞·ªùng&quot; c·ªßa v·ª• thanh to√°n ƒë√≥.</li>
</ul>
<hr>
<h3>B·∫£ng t√≥m t·∫Øt Checklist cho Dev</h3>
<table>
<thead>
<tr>
<th>Lo·∫°i Audit</th>
<th>C·∫ßn l√†m g√¨ trong Migration?</th>
<th>L∆∞u √Ω</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Basic</strong></td>
<td>Th√™m 4 c·ªôt v√†o b·∫£ng hi·ªán t·∫°i.</td>
<td><code>created_at</code>, <code>updated_at</code>, <code>created_by</code>, <code>updated_by</code>.</td>
</tr>
<tr>
<td><strong>Envers (Global)</strong></td>
<td>T·∫°o b·∫£ng <code>revinfo</code>.</td>
<td>Ch·ªâ c·∫ßn t·∫°o 1 l·∫ßn duy nh·∫•t cho c·∫£ d·ª± √°n.</td>
</tr>
<tr>
<td><strong>Envers (Entity)</strong></td>
<td>T·∫°o b·∫£ng <code>{table}_aud</code>.</td>
<td>Ph·∫£i c√≥ c·ªôt <code>rev</code> v√† <code>revtype</code>.</td>
</tr>
</tbody></table>
<hr>
<h3>T·∫°i sao Dev Frontend n√™n quan t√¢m c√°i n√†y?</h3>
<p>V√¨ khi b·∫°n mu·ªën l√†m ch·ª©c nƒÉng <strong>&quot;L·ªãch s·ª≠ ch·ªânh s·ª≠a&quot;</strong> tr√™n giao di·ªán, b·∫°n s·∫Ω ph·∫£i h·ªèi Backend: &quot;√îng l·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng ch√≠nh hay b·∫£ng <code>_aud</code>?&quot;.</p>
<ul>
<li>N·∫øu l·∫•y t·ª´ b·∫£ng ch√≠nh: Ch·ªâ hi·ªán ƒë∆∞·ª£c ng∆∞·ªùi s·ª≠a cu·ªëi c√πng.</li>
<li>N·∫øu l·∫•y t·ª´ b·∫£ng <code>_aud</code>: B·∫°n c√≥ th·ªÉ v·∫Ω ƒë∆∞·ª£c m·ªôt bi·ªÉu ƒë·ªì ho·∫∑c b·∫£ng so s√°nh <em>Version 1</em> kh√°c g√¨ <em>Version 2</em>.</li>
</ul>
<hr>
<p>Vi·ªác t·ª´ b·ªè <strong>Hibernate Envers</strong> l√† m·ªôt quy·∫øt ƒë·ªãnh kh√° ph·ªï bi·∫øn khi d·ª± √°n y√™u c·∫ßu s·ª± linh ho·∫°t cao h∆°n ho·∫∑c b·∫°n kh√¥ng mu·ªën l√†m &quot;r√°c&quot; Database v·ªõi h√†ng ch·ª•c b·∫£ng <code>_AUD</code>.</p>
<p>Khi kh√¥ng d√πng Envers, ch√∫ng ta c√≥ 2 h∆∞·ªõng ƒëi ch√≠nh: M·ªôt l√† d√πng &quot;h√†ng hi·ªáu&quot; chuy√™n d·ª•ng (<strong>JaVers</strong>), hai l√† t·ª± x√¢y d·ª±ng m·ªôt h·ªá th·ªëng <strong>JSON-based Audit</strong> (l∆∞u m·ªçi thay ƒë·ªïi v√†o 1 b·∫£ng duy nh·∫•t d∆∞·ªõi d·∫°ng JSON).</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 10.1: Full Audit Log - Thay th·∫ø Hibernate Envers</h1>
<h3>C√°ch 1: S·ª≠ d·ª•ng JaVers (Open Source &quot;v√¥ ƒë·ªëi&quot; cho Auditing)</h3>
<p><strong>JaVers</strong> gi·ªëng nh∆∞ Git d√†nh cho d·ªØ li·ªáu. Thay v√¨ l∆∞u theo b·∫£ng, n√≥ l∆∞u theo &quot;Snapshot&quot; (·∫£nh ch·ª•p th·ª±c th·ªÉ) v√† c√≥ kh·∫£ nƒÉng so s√°nh (Diff) c·ª±c m·∫°nh.</p>
<ul>
<li><strong>∆Øu ƒëi·ªÉm:</strong> H·ªó tr·ª£ c·ª±c t·ªët cho Spring Boot, query d·ªØ li·ªáu l·ªãch s·ª≠ r·∫•t d·ªÖ, kh√¥ng c·∫ßn t·∫°o nhi·ªÅu b·∫£ng ph·ª•.</li>
<li><strong>C·∫•u h√¨nh:</strong> Ch·ªâ c·∫ßn th√™m th∆∞ vi·ªán <code>javers-spring-boot-starter-sql</code>.</li>
</ul>
<h4>Code v√≠ d·ª•:</h4>
<p>B·∫°n ch·ªâ c·∫ßn ƒë√°nh d·∫•u Repository, JaVers s·∫Ω lo ph·∫ßn c√≤n l·∫°i.</p>
<pre><code class="language-java">@JaversSpringDataAuditable
public interface ProductRepository extends JpaRepository&lt;Product, Long&gt; {
    // M·ªçi thao t√°c save/delete qua ƒë√¢y ƒë·ªÅu ƒë∆∞·ª£c t·ª± ƒë·ªông ghi Log
}
</code></pre>
<h4>Migration Tables cho JaVers:</h4>
<p>JaVers s·∫Ω t·ª± t·∫°o c√°c b·∫£ng sau (ho·∫∑c b·∫°n c√≥ th·ªÉ t·∫°o th·ªß c√¥ng):</p>
<ul>
<li><code>jv_snapshots</code>: L∆∞u tr·ªØ tr·∫°ng th√°i c·ªßa object d∆∞·ªõi d·∫°ng JSON.</li>
<li><code>jv_commit</code>: L∆∞u th√¥ng tin v·ªÅ ng∆∞·ªùi th·ª±c hi·ªán, th·ªùi gian.</li>
<li><code>jv_global_id</code>: L∆∞u ƒë·ªãnh danh c·ªßa th·ª±c th·ªÉ.</li>
</ul>
<hr>
<h3>C√°ch 2: T·ª± Custom (JSON-based Audit Log)</h3>
<p>ƒê√¢y l√† c√°ch &quot;thu·∫ßn khi·∫øt&quot; nh·∫•t. Ch√∫ng ta s·∫Ω gom t·∫•t c·∫£ l·ªãch s·ª≠ c·ªßa to√†n b·ªô h·ªá th·ªëng v√†o <strong>m·ªôt b·∫£ng duy nh·∫•t</strong> g·ªçi l√† <code>audit_logs</code>.</p>
<h4>1. L√Ω thuy·∫øt: C∆° ch·∫ø Diffing</h4>
<p>Ch√∫ng ta s·∫Ω b·∫Øt s·ª± ki·ªán tr∆∞·ªõc khi l∆∞u, so s√°nh Object c≈© v√† Object m·ªõi, sau ƒë√≥ l∆∞u ph·∫ßn kh√°c bi·ªát v√†o b·∫£ng Log d∆∞·ªõi d·∫°ng JSON.</p>
<h4>2. Migration Table cho Custom Audit</h4>
<pre><code class="language-sql">CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    entity_name VARCHAR(100) NOT NULL, -- V√≠ d·ª•: &#39;Product&#39;, &#39;User&#39;
    entity_id VARCHAR(50) NOT NULL,
    action VARCHAR(20) NOT NULL,       -- &#39;CREATE&#39;, &#39;UPDATE&#39;, &#39;DELETE&#39;
    old_value JSON,                    -- D·ªØ li·ªáu c≈© (JSON)
    new_value JSON,                    -- D·ªØ li·ªáu m·ªõi (JSON)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100)
);
</code></pre>
<h4>3. Code v√≠ d·ª•: Entity Listener</h4>
<p>Ch√∫ng ta s·ª≠ d·ª•ng <code>@PostUpdate</code> ƒë·ªÉ ghi log sau khi d·ªØ li·ªáu ƒë√£ thay ƒë·ªïi th√†nh c√¥ng.</p>
<pre><code class="language-java">@Component
@Slf4j
public class CustomAuditListener {

    @PostUpdate
    public void onPostUpdate(Object entity) {
        // Logic: 
        // 1. L·∫•y d·ªØ li·ªáu c≈© t·ª´ Database (tr∆∞·ªõc khi transaction commit)
        // 2. So s√°nh v·ªõi &#39;entity&#39; (d·ªØ li·ªáu m·ªõi)
        // 3. N·∫øu c√≥ kh√°c bi·ªát, insert v√†o b·∫£ng audit_logs
        log.info(&quot;Ghi log thay ƒë·ªïi cho th·ª±c th·ªÉ: {}&quot;, entity.getClass().getSimpleName());
    }
}
</code></pre>
<blockquote>
<p><strong>M·∫πo:</strong> ƒê·ªÉ th·ª±c hi·ªán vi·ªác so s√°nh (Diff) nhanh nh·∫•t, b·∫°n n√™n d√πng th∆∞ vi·ªán <strong>Jackson</strong> ho·∫∑c <strong>Google Gson</strong> ƒë·ªÉ convert Object sang Map r·ªìi so s√°nh c√°c Key.</p>
</blockquote>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Ki·ªÉm tra &quot;Ai ƒë√£ ƒë·ªïi s·ªë ƒëi·ªán tho·∫°i?&quot;</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Trong b·∫£ng <code>audit_logs</code>, b·∫°n search theo <code>entity_name = &#39;User&#39;</code> v√† <code>entity_id = &#39;123&#39;</code>.</li>
<li><strong>K·∫øt qu·∫£:</strong> B·∫°n th·∫•y m·ªôt d√≤ng <code>UPDATE</code>. C·ªôt <code>old_value</code> l√† <code>{&quot;phone&quot;: &quot;0912...&quot;}</code>, c·ªôt <code>new_value</code> l√† <code>{&quot;phone&quot;: &quot;0988...&quot;}</code>.</li>
<li><strong>L·ª£i √≠ch:</strong> B·∫°n bi·∫øt ch√≠nh x√°c thu·ªôc t√≠nh n√†o b·ªã ƒë·ªïi m√† kh√¥ng c·∫ßn xem to√†n b·ªô object.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Ph√¢n t√≠ch hi·ªáu nƒÉng ghi Log</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> N·∫øu b·∫£ng <code>audit_logs</code> l√™n t·ªõi h√†ng tri·ªáu d√≤ng, vi·ªác ghi log ƒë·ªìng b·ªô s·∫Ω l√†m API b·ªã ch·∫≠m.</li>
<li><strong>Gi·∫£i ph√°p:</strong> K·∫øt h·ª£p v·ªõi <strong>Ch·ªß ƒë·ªÅ 8 (@Async)</strong>. Khi c√≥ thay ƒë·ªïi, b·∫°n b·∫Øn m·ªôt Event (Spring Events), sau ƒë√≥ m·ªôt lu·ªìng ng·∫ßm s·∫Ω x·ª≠ l√Ω vi·ªác ghi v√†o b·∫£ng <code>audit_logs</code>. API tr·∫£ k·∫øt qu·∫£ v·ªÅ cho Frontend ngay l·∫≠p t·ª©c.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Hi·ªÉn th·ªã &quot;Timeline&quot; thay ƒë·ªïi d·ªØ li·ªáu</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Frontend mu·ªën v·∫Ω m·ªôt Timeline nh∆∞ Facebook Activity Log.</li>
<li><strong>Gi·∫£i ph√°p:</strong> V√¨ d·ªØ li·ªáu n·∫±m trong 1 b·∫£ng duy nh·∫•t, b·∫°n ch·ªâ c·∫ßn 1 API <code>GET /api/audit?entityId=123</code>. B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng map JSON th√†nh c√°c c√¢u th√¥ng b√°o th√¢n thi·ªán: &quot;Nguy·ªÖn VƒÉn A ƒë√£ c·∫≠p nh·∫≠t gi√° t·ª´ 100k th√†nh 120k&quot;.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh 3 c√°ch ti·∫øp c·∫≠n</h3>
<table>
<thead>
<tr>
<th>Ti√™u ch√≠</th>
<th>Hibernate Envers</th>
<th>JaVers (Open Source)</th>
<th>Custom JSON Audit</th>
</tr>
</thead>
<tbody><tr>
<td><strong>S·ªë l∆∞·ª£ng b·∫£ng</strong></td>
<td>R·∫•t nhi·ªÅu (<code>_AUD</code>)</td>
<td>C·ªë ƒë·ªãnh (4 b·∫£ng jv_*)</td>
<td><strong>Duy nh·∫•t 1 b·∫£ng</strong></td>
</tr>
<tr>
<td><strong>D·ªÖ Query</strong></td>
<td>Kh√≥ (ph·∫£i Join nhi·ªÅu)</td>
<td>R·∫•t d·ªÖ (c√≥ API ri√™ng)</td>
<td>Trung b√¨nh (D√πng JSON query)</td>
</tr>
<tr>
<td><strong>Linh ho·∫°t</strong></td>
<td>Th·∫•p (g·∫Øn ch·∫∑t JPA)</td>
<td>Cao (SQL/NoSQL)</td>
<td><strong>T·ªëi ƒëa (T·ª± ch·ªß ho√†n to√†n)</strong></td>
</tr>
<tr>
<td><strong>Ph√π h·ª£p cho</strong></td>
<td>D·ª± √°n truy·ªÅn th·ªëng</td>
<td>D·ª± √°n c·∫ßn Time-travel</td>
<td>D·ª± √°n Microservices / High-flex</td>
</tr>
</tbody></table>
<hr>
<p><strong>L·ªùi khuy√™n t·ª´ &quot;h·∫≠u ph∆∞∆°ng&quot;:</strong> N·∫øu d·ª± √°n c·ªßa b·∫°n c√≥ quy m√¥ v·ª´a v√† l·ªõn, h√£y d√πng <strong>JaVers</strong>. ƒê·ª´ng t·ª± code l·∫°i c√°i b√°nh xe v√¨ vi·ªác x·ª≠ l√Ω so s√°nh c√°c Object l·ªìng nhau (Nested Objects) c·ª±c k·ª≥ ph·ª©c t·∫°p v√† d·ªÖ g√¢y bug.</p>
<hr>
<p>Vi·ªác l·ª±a ch·ªçn <strong>JaVers</strong> l√† m·ªôt b∆∞·ªõc ƒëi r·∫•t th√¥ng minh. JaVers kh√¥ng ch·ªâ l√† m·ªôt th∆∞ vi·ªán ghi log, n√≥ l√† m·ªôt h·ªá th·ªëng &quot;Time Travel&quot; (du h√†nh th·ªùi gian) cho d·ªØ li·ªáu. Thay v√¨ t·∫°o ra h√†ng ch·ª•c b·∫£ng ph·ª• nh∆∞ Envers, JaVers qu·∫£n l√Ω m·ªçi th·ª© trong 4 b·∫£ng c·ªë ƒë·ªãnh, l∆∞u tr·ªØ d∆∞·ªõi d·∫°ng JSON, c·ª±c k·ª≥ linh ho·∫°t v√† d·ªÖ m·ªü r·ªông.</p>
<p>D∆∞·ªõi ƒë√¢y l√† chi ti·∫øt v·ªÅ Migration v√† Code th·ª±c t·∫ø ƒë·ªÉ tri·ªÉn khai JaVers trong d·ª± √°n Spring Boot 3 c·ªßa b·∫°n.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 10.2: Tri·ªÉn khai JaVers Audit Log (SQL-based)</h1>
<h3>1. L√Ω thuy·∫øt: C∆° ch·∫ø Snapshots &amp; Shadows</h3>
<p>JaVers kh√¥ng l∆∞u &quot;d√≤ng d·ªØ li·ªáu&quot;, n√≥ l∆∞u <strong>Snapshots</strong> (·∫£nh ch·ª•p).</p>
<ul>
<li><strong>Snapshot:</strong> L√† m·ªôt b·∫£n ghi JSON ch·ª©a tr·∫°ng th√°i c·ªßa ƒë·ªëi t∆∞·ª£ng t·∫°i m·ªôt th·ªùi ƒëi·ªÉm.</li>
<li><strong>Shadow:</strong> L√† m·ªôt ƒë·ªëi t∆∞·ª£ng Java &quot;h·ªìi sinh&quot; t·ª´ Snapshot. B·∫°n c√≥ th·ªÉ y√™u c·∫ßu JaVers: &quot;H√£y cho t√¥i xem ƒë·ªëi t∆∞·ª£ng Product ID = 1 tr√¥ng nh∆∞ th·∫ø n√†o v√†o ng√†y h√¥m kia&quot;. JaVers s·∫Ω t·ª± ƒë·ªông t·∫°o l·∫°i Object ƒë√≥ cho b·∫°n.</li>
</ul>
<hr>
<h3>2. Migration Tables (SQL)</h3>
<p>M·∫∑c d√π JaVers c√≥ th·ªÉ t·ª± t·∫°o b·∫£ng, nh∆∞ng trong m√¥i tr∆∞·ªùng chuy√™n nghi·ªáp, b·∫°n n√™n d√πng SQL Migration (Flyway/Liquibase). D∆∞·ªõi ƒë√¢y l√† c·∫•u tr√∫c b·∫£ng chu·∫©n cho MySQL/PostgreSQL.</p>
<p>**File: <code>V1__create_javers_tables.sql**</code></p>
<pre><code class="language-sql">-- 1. L∆∞u danh t√≠nh duy nh·∫•t c·ªßa c√°c Object (Global ID)
CREATE TABLE jv_global_id (
    global_id_pk BIGINT AUTO_INCREMENT PRIMARY KEY,
    local_id VARCHAR(255),
    fragment VARCHAR(255),
    owner_id_fk BIGINT,
    type_name VARCHAR(255),
    CONSTRAINT jv_global_id_owner_id_fk FOREIGN KEY (owner_id_fk) REFERENCES jv_global_id (global_id_pk)
);

-- 2. L∆∞u th√¥ng tin v·ªÅ l·∫ßn Commit (Ai s·ª≠a, l√∫c n√†o s·ª≠a)
CREATE TABLE jv_commit (
    commit_pk BIGINT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(200),
    commit_date TIMESTAMP,
    commit_date_instant VARCHAR(30),
    commit_id DECIMAL(12, 2)
);

-- 3. L∆∞u c√°c thu·ªôc t√≠nh t√πy ch·ªânh c·ªßa Commit (v√≠ d·ª•: IP, User-Agent)
CREATE TABLE jv_commit_property (
    property_key VARCHAR(255) NOT NULL,
    property_value VARCHAR(600),
    commit_fk BIGINT NOT NULL,
    PRIMARY KEY (commit_fk, property_key),
    CONSTRAINT jv_commit_property_commit_fk FOREIGN KEY (commit_fk) REFERENCES jv_commit (commit_pk)
);

-- 4. L∆∞u d·ªØ li·ªáu th·ª±c t·∫ø (·∫¢nh ch·ª•p tr·∫°ng th√°i d∆∞·ªõi d·∫°ng JSON)
CREATE TABLE jv_snapshot (
    snapshot_pk BIGINT AUTO_INCREMENT PRIMARY KEY,
    type VARCHAR(200),
    version BIGINT,
    state JSON, -- L∆∞u to√†n b·ªô Object d∆∞·ªõi d·∫°ng JSON
    changed_properties TEXT,
    managed_type VARCHAR(200),
    global_id_fk BIGINT,
    commit_fk BIGINT,
    CONSTRAINT jv_snapshot_global_id_fk FOREIGN KEY (global_id_fk) REFERENCES jv_global_id (global_id_pk),
    CONSTRAINT jv_snapshot_commit_fk FOREIGN KEY (commit_fk) REFERENCES jv_commit (commit_pk)
);
</code></pre>
<hr>
<h3>3. V√≠ d·ª• Code th·ª±c t·∫ø</h3>
<h4>A. Khai b√°o Dependency (pom.xml)</h4>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.javers&lt;/groupId&gt;
    &lt;artifactId&gt;javers-spring-boot-starter-sql&lt;/artifactId&gt;
    &lt;version&gt;7.4.1&lt;/version&gt; &lt;/dependency&gt;
</code></pre>
<h4>B. ƒê√°nh d·∫•u Repository</h4>
<p>B·∫°n ch·ªâ c·∫ßn th√™m m·ªôt Annotation, JaVers s·∫Ω t·ª± ƒë·ªông &quot;nghe ng√≥ng&quot; m·ªçi thay ƒë·ªïi.</p>
<pre><code class="language-java">@Repository
@JaversSpringDataAuditable // &lt;--- K√≠ch ho·∫°t t·ª± ƒë·ªông ghi log cho m·ªçi h√†m save()
public interface ProductRepository extends JpaRepository&lt;Product, Long&gt; {
}
</code></pre>
<h4>C. Truy v·∫•n l·ªãch s·ª≠ (Shadows)</h4>
<p>ƒê√¢y l√† ph·∫ßn &quot;ƒÉn ti·ªÅn&quot; nh·∫•t. Frontend c√≥ th·ªÉ y√™u c·∫ßu xem l·ªãch s·ª≠ thay ƒë·ªïi c·ªßa m·ªôt s·∫£n ph·∫©m.</p>
<pre><code class="language-java">@Service
@RequiredArgsConstructor
public class AuditService {
    private final Javers javers;

    public List&lt;Shadow&lt;Product&gt;&gt; getProductHistory(Long productId) {
        JqlQuery jqlQuery = QueryBuilder.byInstanceId(productId, Product.class)
                .withChildValueObjects() // L·∫•y c·∫£ c√°c object con l·ªìng b√™n trong
                .build();

        // Tr·∫£ v·ªÅ danh s√°ch c√°c &quot;b√≥ng ma&quot; - c√°c tr·∫°ng th√°i trong qu√° kh·ª©
        return javers.findShadows(jqlQuery);
    }
}
</code></pre>
<hr>
<h3>4. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: So s√°nh hai phi√™n b·∫£n (Diffing)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User mu·ªën bi·∫øt b·∫£n s·ª≠a l√∫c 9h s√°ng v√† b·∫£n s·ª≠a l√∫c 10h s√°ng kh√°c nhau ·ªü nh·ªØng tr∆∞·ªùng n√†o.</li>
<li><strong>Gi·∫£i ph√°p:</strong> JaVers cung c·∫•p h√†m <code>compare</code>. B·∫°n l·∫•y 2 Snapshot ra v√† JaVers s·∫Ω tr·∫£ v·ªÅ ch√≠nh x√°c: <code>Property &#39;price&#39; changed from 100 to 120</code>. B·∫°n ch·ªâ c·∫ßn g·ª≠i list thay ƒë·ªïi n√†y v·ªÅ cho Frontend.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Ph·ª•c h·ªìi d·ªØ li·ªáu b·ªã l·ªói (Object Recovery)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Nh√¢n vi√™n c·∫≠p nh·∫≠t sai th√¥ng tin h√†ng lo·∫°t s·∫£n ph·∫©m.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Nh·ªù c∆° ch·∫ø <strong>Shadow</strong>, b·∫°n c√≥ th·ªÉ l·∫•y l·∫°i Object c·ªßa 1 ti·∫øng tr∆∞·ªõc:</li>
</ul>
<pre><code class="language-java">List&lt;Shadow&lt;Product&gt;&gt; shadows = javers.findShadows(query);
Product oldVersion = shadows.get(1).get(); // L·∫•y b·∫£n ghi c≈©
productRepository.save(oldVersion); // Ghi ƒë√® l·∫°i v√†o b·∫£ng ch√≠nh
</code></pre>
<p><strong>T√¨nh hu·ªëng 3: Ki·ªÉm so√°t &quot;D·∫•u ch√¢n&quot; User (Author Tracking)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën ghi log kh√¥ng ch·ªâ Username m√† c·∫£ <strong>IP Address</strong> c·ªßa ng∆∞·ªùi th·ª±c hi·ªán thay ƒë·ªïi.</li>
<li><strong>Gi·∫£i ph√°p:</strong> JaVers cho ph√©p ƒë√≠nh k√®m &quot;Commit Properties&quot;. B·∫°n c√≥ th·ªÉ vi·∫øt m·ªôt <code>AuthorProvider</code> ƒë·ªÉ t·ª± ƒë·ªông l·∫•y IP t·ª´ Request v√† g·∫Øn v√†o m·ªói l·∫ßn ghi log. D·ªØ li·ªáu n√†y s·∫Ω n·∫±m trong b·∫£ng <code>jv_commit_property</code>.</li>
</ul>
<hr>
<h3>B·∫£ng t√≥m t·∫Øt cho Dev Frontend chuy·ªÉn h·ªá</h3>
<table>
<thead>
<tr>
<th>T√≠nh nƒÉng</th>
<th>JaVers</th>
<th>T·∫°i sao Frontend s·∫Ω th√≠ch?</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Format d·ªØ li·ªáu</strong></td>
<td>JSON</td>
<td>R·∫•t d·ªÖ ƒë·ªÉ map v√†o c√°c Component hi·ªÉn th·ªã l·ªãch s·ª≠.</td>
</tr>
<tr>
<td><strong>C·∫•u tr√∫c b·∫£ng</strong></td>
<td>C·ªë ƒë·ªãnh (4 b·∫£ng)</td>
<td>Kh√¥ng l√†m r·ªëi s∆° ƒë·ªì ERD c·ªßa Database ch√≠nh.</td>
</tr>
<tr>
<td><strong>Kh·∫£ nƒÉng Diff</strong></td>
<td>C√≥ s·∫µn</td>
<td>Gi√∫p b·∫°n l√†m t√≠nh nƒÉng &quot;Show changes&quot; (nh∆∞ Git) c·ª±c nhanh.</td>
</tr>
<tr>
<td><strong>Dung l∆∞·ª£ng</strong></td>
<td>T·ªëi ∆∞u</td>
<td>Ch·ªâ l∆∞u nh·ªØng g√¨ thay ƒë·ªïi, kh√¥ng copy nguy√™n c·∫£ h√†ng d·ªØ li·ªáu th·ª´a.</td>
</tr>
</tbody></table>
<hr>
<p><strong>G·ª£i √Ω cu·ªëi c√πng cho b·∫°n:</strong> JaVers ho·∫°t ƒë·ªông c·ª±c k·ª≥ m∆∞·ª£t m√† v·ªõi <strong>Spring Security</strong>. N√≥ s·∫Ω t·ª± ƒë·ªông l·∫•y th√¥ng tin t·ª´ <code>SecurityContextHolder</code> ƒë·ªÉ ƒëi·ªÅn v√†o c·ªôt <code>author</code> trong b·∫£ng <code>jv_commit</code>.</p>
<hr>
<p>JaVers c√≤n &quot;h·∫°nh ph√∫c&quot; h∆°n khi l√†m vi·ªác v·ªõi NoSQL (ƒë·∫∑c bi·ªát l√† MongoDB) so v·ªõi SQL truy·ªÅn th·ªëng.</p>
<p>L√Ω do l√† v√¨ JaVers b·∫£n ch·∫•t l∆∞u tr·ªØ d·ªØ li·ªáu d∆∞·ªõi d·∫°ng <strong>JSON</strong>. Trong SQL, n√≥ ph·∫£i t√¨m c√°ch &quot;nh√©t&quot; JSON v√†o c√°c c·ªôt Text ho·∫∑c JSONB, c√≤n trong NoSQL, n√≥ ƒë∆∞·ª£c s·ªëng ƒë√∫ng v·ªõi b·∫£n ng√£ c·ªßa m√¨nh.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 10.3: JaVers v·ªõi NoSQL (MongoDB)</h1>
<p>Khi s·ª≠ d·ª•ng v·ªõi MongoDB, JaVers s·∫Ω kh√¥ng t·∫°o ra 4 b·∫£ng nh∆∞ SQL m√† s·∫Ω t·∫°o ra c√°c <strong>Collections</strong> (t∆∞∆°ng ƒë∆∞∆°ng v·ªõi Table trong NoSQL).</p>
<h3>1. T·∫°i sao NoSQL + JaVers l√† &quot;c·∫∑p b√†i tr√πng&quot;?</h3>
<ol>
<li><strong>Schema-less:</strong> N·∫øu b·∫°n th√™m m·ªôt field m·ªõi v√†o Entity, JaVers NoSQL t·ª± ƒë·ªông nh·∫≠n v√† l∆∞u v√†o JSON m√† kh√¥ng c·∫ßn ch·∫°y Script <code>ALTER TABLE</code> ph·ª©c t·∫°p.</li>
<li><strong>Performance:</strong> Vi·ªác ghi v√† ƒë·ªçc JSON trong MongoDB nhanh h∆°n ƒë√°ng k·ªÉ so v·ªõi vi·ªác x·ª≠ l√Ω c√°c c·ªôt JSON trong RDBMS.</li>
<li><strong>Nested Objects:</strong> NoSQL h·ªó tr·ª£ l∆∞u tr·ªØ c√°c ƒë·ªëi t∆∞·ª£ng l·ªìng nhau (Embedded Objects) r·∫•t t·ªët, v√† JaVers t·∫≠n d·ª•ng ƒëi·ªÅu n√†y ƒë·ªÉ ch·ª•p ·∫£nh (Snapshot) to√†n b·ªô c√¢y d·ªØ li·ªáu c·ªßa b·∫°n.</li>
</ol>
<hr>
<h3>2. C√°ch s·ª≠ d·ª•ng (Spring Boot 3 + MongoDB)</h3>
<h4>A. Khai b√°o Dependency</h4>
<p>Thay v√¨ b·∫£n <code>sql</code>, b·∫°n h√£y d√πng b·∫£n <code>mongo</code>.</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.javers&lt;/groupId&gt;
    &lt;artifactId&gt;javers-spring-boot-starter-mongo&lt;/artifactId&gt;
    &lt;version&gt;7.4.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h4>B. C·∫•u h√¨nh (application.yml)</h4>
<p>B·∫°n kh√¥ng c·∫ßn t·∫°o Migration Table v√¨ MongoDB s·∫Ω t·ª± ƒë·ªông t·∫°o Collections khi c√≥ d·ªØ li·ªáu ƒë·∫ßu ti√™n.</p>
<pre><code class="language-yaml">spring:
  data:
    mongodb:
      uri: mongodb://localhost:27017/audit_db
      
javers:
  mappingStyle: FIELD
  algorithm: LEVENSHTEIN_DISTANCE # Thu·∫≠t to√°n so s√°nh s·ª± kh√°c bi·ªát gi·ªØa c√°c chu·ªói
</code></pre>
<h4>C. Code th·ª±c t·∫ø</h4>
<p>V·∫´n l√† nh·ªØng Annotation quen thu·ªôc, gi√∫p b·∫°n chuy·ªÉn ƒë·ªïi t·ª´ SQL sang NoSQL m√† g·∫ßn nh∆∞ kh√¥ng ph·∫£i s·ª≠a code logic.</p>
<pre><code class="language-java">// 1. Entity c·ªßa b·∫°n
@Document(collection = &quot;customers&quot;)
@Getter @Setter
public class Customer {
    @Id
    private String id;
    private String name;
    private Address address; // Object l·ªìng nhau
}

// 2. Repository
@JaversSpringDataAuditable
public interface CustomerRepository extends MongoRepository&lt;Customer, String&gt; {
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: L∆∞u v·∫øt thay ƒë·ªïi c·ªßa c√°c Document ph·ª©c t·∫°p</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n c√≥ m·ªôt Document <code>Order</code> ch·ª©a m·∫£ng <code>List&lt;Item&gt;</code>. M·ªói Item l·∫°i c√≥ <code>Price</code>.</li>
<li><strong>Gi·∫£i ph√°p:</strong> JaVers NoSQL l∆∞u to√†n b·ªô c·∫•u tr√∫c n√†y. Khi b·∫°n ƒë·ªïi gi√° c·ªßa m·ªôt Item ·ªü s√¢u b√™n trong, JaVers v·∫´n ph√°t hi·ªán ra v√† ghi l·∫°i: <code>items[2].price changed from 50 to 60</code>. Vi·ªác n√†y trong SQL truy·ªÅn th·ªëng l√† c·ª±c k·ª≥ kh√≥ khƒÉn.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: H·ªá th·ªëng ƒëa qu·ªëc gia (Global Scale)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n d√πng MongoDB Atlas (Cloud) ƒë·ªÉ ch·∫°y app to√†n c·∫ßu.</li>
<li><strong>Gi·∫£i ph√°p:</strong> JaVers h·ªó tr·ª£ c·∫•u h√¨nh <code>MongoJaversCache</code>. D√π d·ªØ li·ªáu c·ªßa b·∫°n n·∫±m ·ªü nhi·ªÅu Node kh√°c nhau tr√™n th·∫ø gi·ªõi, JaVers v·∫´n ƒë·∫£m b·∫£o vi·ªác ghi log ƒë∆∞·ª£c ƒë·ªìng b·ªô v√† kh√¥ng l√†m ngh·∫Ωn h·ªá th·ªëng nh·ªù c∆° ch·∫ø ghi kh√¥ng ƒë·ªìng b·ªô (n·∫øu c·∫•u h√¨nh th√™m).</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Ki·ªÉm tra l·ªãch s·ª≠ (Time-travel) ngay tr√™n giao di·ªán App</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> App c·ªßa b·∫°n c√≥ t√≠nh nƒÉng &quot;Xem l·ªãch s·ª≠ thay ƒë·ªïi&quot; gi·ªëng nh∆∞ Google Docs.</li>
<li><strong>Gi·∫£i ph√°p:</strong> V·ªõi NoSQL, JaVers tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng BSON/JSON. B·∫°n ch·ªâ c·∫ßn vi·∫øt m·ªôt API ƒë∆°n gi·∫£n ƒë·ªÉ tr·∫£ th·∫≥ng c·ª•c JSON n√†y v·ªÅ cho Frontend (React/Vue/App). Frontend ch·ªâ vi·ªác map v√† hi·ªÉn th·ªã, kh√¥ng c·∫ßn chuy·ªÉn ƒë·ªïi ph·ª©c t·∫°p.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh JaVers: SQL vs NoSQL</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>JaVers SQL (MySQL/Postgre)</th>
<th>JaVers NoSQL (MongoDB)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>L∆∞u tr·ªØ</strong></td>
<td>4 b·∫£ng c·ªë ƒë·ªãnh</td>
<td>2 collections ch√≠nh (<code>jv_snapshots</code>, <code>jv_head_id</code>)</td>
</tr>
<tr>
<td><strong>Migration</strong></td>
<td>C·∫ßn file <code>.sql</code> (Flyway/Liquibase)</td>
<td><strong>Kh√¥ng c·∫ßn</strong> (Auto-create)</td>
</tr>
<tr>
<td><strong>C·∫•u tr√∫c ph·ª©c t·∫°p</strong></td>
<td>Kh√≥ x·ª≠ l√Ω n·∫øu l·ªìng nhau qu√° s√¢u</td>
<td><strong>X·ª≠ l√Ω c·ª±c t·ªët</strong> c√°c c·∫•u tr√∫c l·ªìng nhau</td>
</tr>
<tr>
<td><strong>T·ªëc ƒë·ªô ghi</strong></td>
<td>Trung b√¨nh (ph·ª• thu·ªôc Transaction)</td>
<td><strong>R·∫•t nhanh</strong></td>
</tr>
</tbody></table>
<hr>
<h3>‚ö†Ô∏è M·ªôt l∆∞u √Ω nh·ªè:</h3>
<p>M·∫∑c d√π NoSQL kh√¥ng c·∫ßn Migration, nh∆∞ng b·∫°n v·∫´n n√™n qu·∫£n l√Ω Index cho c√°c Collection c·ªßa JaVers (nh∆∞ <code>global_id_fk</code> hay <code>commit_date</code>) ƒë·ªÉ ƒë·∫£m b·∫£o khi d·ªØ li·ªáu log l√™n t·ªõi h√†ng tri·ªáu b·∫£n ghi, vi·ªác truy v·∫•n l·ªãch s·ª≠ v·∫´n m∆∞·ª£t m√†.</p>
<hr>
<p>Khi s·ª≠ d·ª•ng <strong>JaVers</strong> v·ªõi <strong>MongoDB</strong>, c·∫•u h√¨nh th·ª±c t·∫ø kh√° ƒë∆°n gi·∫£n v√¨ Spring Boot Starter c·ªßa JaVers s·∫Ω t·ª± ƒë·ªông t√¨m ki·∫øm Bean <code>MongoDatabase</code> ho·∫∑c c√°c th√¥ng s·ªë k·∫øt n·ªëi t·ª´ <code>spring.data.mongodb</code>.</p>
<p>D∆∞·ªõi ƒë√¢y l√† chi ti·∫øt c·∫•u h√¨nh ƒë·ªÉ k·∫øt n·ªëi v√† v·∫≠n h√†nh JaVers trong h·ªá sinh th√°i NoSQL.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 10.4: C·∫•u h√¨nh k·∫øt n·ªëi JaVers v·ªõi MongoDB</h1>
<h3>1. L√Ω thuy·∫øt: C∆° ch·∫ø k·∫øt n·ªëi</h3>
<p>JaVers s·ª≠ d·ª•ng m·ªôt Bean c√≥ t√™n l√† <code>JaversSqlRepository</code> cho SQL v√† <code>MongoRepository</code> cho NoSQL. Khi b·∫°n th√™m starter <code>javers-spring-boot-starter-mongo</code>, JaVers s·∫Ω t·ª± ƒë·ªông c·∫•u h√¨nh m·ªôt <code>Javers</code> bean b·∫±ng c√°ch s·ª≠ d·ª•ng k·∫øt n·ªëi MongoDB hi·ªán c√≥ c·ªßa ·ª©ng d·ª•ng.</p>
<p>N·∫øu b·∫°n ƒë√£ c√≥ c·∫•u h√¨nh <code>spring.data.mongodb</code> ƒë·ªÉ ·ª©ng d·ª•ng ch·∫°y, JaVers s·∫Ω &quot;m∆∞·ª£n&quot; k·∫øt n·ªëi ƒë√≥ ƒë·ªÉ t·∫°o c√°c Collection c·ªßa n√≥.</p>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. C·∫•u h√¨nh trong <code>application.yml</code></h4>
<p>ƒê√¢y l√† c√°ch ƒë∆°n gi·∫£n nh·∫•t. JaVers s·∫Ω t·ª± ƒë·ªông ƒëi theo c·∫•u h√¨nh n√†y.</p>
<pre><code class="language-yaml">spring:
  data:
    mongodb:
      uri: mongodb://admin:password@localhost:27017/my_audit_db
      # Ho·∫∑c c·∫•u h√¨nh t√°ch r·ªùi:
      # host: localhost
      # port: 27017
      # database: my_audit_db

javers:
  # C·∫•u h√¨nh t√™n Collection n·∫øu mu·ªën kh√°c m·∫∑c ƒë·ªãnh (jv_snapshots, jv_head_id)
  snapshotsCacheSize: 1000
  mappingStyle: FIELD
  algorithm: LEVENSHTEIN_DISTANCE
  # T·∫Øt t·ª± ƒë·ªông t·∫°o b·∫£ng n·∫øu b·∫°n mu·ªën qu·∫£n l√Ω th·ªß c√¥ng (√≠t d√πng v·ªõi Mongo)
  # sqlSchemaManagementEnabled: false 
</code></pre>
<h4>B. C·∫•u h√¨nh b·∫±ng Java (N·∫øu c·∫ßn t√πy ch·ªânh s√¢u)</h4>
<p>Trong tr∆∞·ªùng h·ª£p b·∫°n d√πng nhi·ªÅu Database Mongo ho·∫∑c mu·ªën t√°ch bi·ªát Database d√†nh ri√™ng cho Audit Log, b·∫°n c·∫ßn ƒë·ªãnh nghƒ©a Bean th·ªß c√¥ng:</p>
<pre><code class="language-java">@Configuration
public class JaversMongoConfig {

    @Bean
    public Javers javers(MongoDatabase mongoDatabase) {
        // mongoDatabase n√†y ƒë∆∞·ª£c Spring t·ª± ƒë·ªông inject t·ª´ k·∫øt n·ªëi ch√≠nh
        MongoRepository javersRepository = new MongoRepository(mongoDatabase);

        return JaversBuilder.javers()
                .registerJaversRepository(javersRepository)
                .build();
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: T√°ch bi·ªát Database Audit (Audit Isolation)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën d·ªØ li·ªáu ch√≠nh n·∫±m ·ªü DB <code>app_data</code>, nh∆∞ng to√†n b·ªô Log c·ªßa JaVers ph·∫£i n·∫±m ·ªü DB <code>app_audit</code> ƒë·ªÉ tr√°nh l√†m ch·∫≠m c√°c truy v·∫•n nghi·ªáp v·ª•.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·∫°n t·∫°o 2 Mongo Client. M·ªôt c√°i d√πng cho ·ª©ng d·ª•ng ch√≠nh, m·ªôt c√°i d√πng ƒë·ªÉ kh·ªüi t·∫°o <code>MongoRepository</code> cho JaVers nh∆∞ v√≠ d·ª• Java Config ·ªü tr√™n. ƒêi·ªÅu n√†y gi√∫p b·∫°n d·ªÖ d√†ng backup ho·∫∑c d·ªçn d·∫πp log m√† kh√¥ng ·∫£nh h∆∞·ªüng t·ªõi d·ªØ li·ªáu kh√°ch h√†ng.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Qu·∫£n l√Ω &quot;H·∫øt h·∫°n&quot; d·ªØ li·ªáu Log (TTL Index)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> D·ªØ li·ªáu Audit Log trong MongoDB ng√†y c√†ng l·ªõn v√† b·∫°n ch·ªâ mu·ªën gi·ªØ l·∫°i log trong v√≤ng 2 nƒÉm.</li>
<li><strong>Gi·∫£i ph√°p:</strong> V√¨ MongoDB h·ªó tr·ª£ <strong>TTL Index</strong>, b·∫°n c√≥ th·ªÉ t·∫°o m·ªôt index tr√™n tr∆∞·ªùng <code>commitDate</code> trong collection <code>jv_snapshots</code> c·ªßa JaVers.</li>
</ul>
<pre><code class="language-javascript">// Ch·∫°y l·ªánh n√†y trong Mongo Shell
db.jv_snapshots.createIndex({ &quot;commitDate&quot;: 1 }, { expireAfterSeconds: 63072000 })
</code></pre>
<p>MongoDB s·∫Ω t·ª± ƒë·ªông x√≥a c√°c log c≈©, gi√∫p h·ªá th·ªëng lu√¥n g·ªçn nh·∫π m√† kh√¥ng c·∫ßn vi·∫øt code x√≥a th·ªß c√¥ng.</p>
<p><strong>T√¨nh hu·ªëng 3: Tracking User th√¥ng qua JWT</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> JaVers c·∫ßn bi·∫øt ai l√† ng∆∞·ªùi th·ª±c hi·ªán thay ƒë·ªïi ƒë·ªÉ ghi v√†o c·ªôt <code>author</code>.</li>
<li><strong>Gi·∫£i ph√°p:</strong> T√≠ch h·ª£p v·ªõi <code>AuthorProvider</code>. Khi User t·ª´ App/Frontend g·ª≠i request k√®m JWT, Spring Security gi·∫£i m√£ ra Username, JaVers s·∫Ω g·ªçi h√†m n√†y ƒë·ªÉ l·∫•y t√™n ghi v√†o log.</li>
</ul>
<pre><code class="language-java">@Component
public class SpringSecurityAuthorProvider implements AuthorProvider {
    @Override
    public String provide() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth == null || !auth.isAuthenticated()) {
            return &quot;system_user&quot;;
        }
        return auth.getName();
    }
}
</code></pre>
<hr>
<h3>T√≥m t·∫Øt cho Dev chuy·ªÉn h·ªá:</h3>
<p>Vi·ªác d√πng JaVers v·ªõi Mongo gi·ªëng nh∆∞ b·∫°n ƒëang d√πng m·ªôt th∆∞ vi·ªán &quot;Auto-save history&quot; cho c√°c JSON Object.</p>
<ul>
<li><strong>Frontend:</strong> Kh√¥ng c·∫ßn quan t√¢m Backend l∆∞u th·∫ø n√†o, ch·ªâ c·∫ßn g·ªçi API <code>GET /history</code> v√† nh·∫≠n v·ªÅ danh s√°ch JSON c√°c thay ƒë·ªïi.</li>
<li><strong>Backend:</strong> Ch·ªâ c·∫ßn quan t√¢m ƒë·∫øn vi·ªác c·∫•u h√¨nh ƒë√∫ng <code>uri</code> c·ªßa Mongo v√† ƒë·∫£m b·∫£o <code>AuthorProvider</code> l·∫•y ƒë∆∞·ª£c t√™n User.</li>
</ul>

          </article>

          <!-- Navigation Footer (Next/Prev) -->
          <div class="mt-12 pt-8 border-t border-gray-200 flex justify-between">
            <a href="topic09.html" class="text-indigo-600 font-medium hover:text-indigo-800">‚Üê Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading</a><a href="topic_black_holes.html" class="text-indigo-600 font-medium hover:text-indigo-800">üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging ‚Üí</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div
      onclick="toggleSidebar()"
      id="overlay"
      class="fixed inset-0 bg-black/50 z-10 lg:hidden hidden"
      style="display: none"
    ></div>
    <script>
      // Simple overlay logic
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      // Sync overlay with sidebar state check if needed, but for "simplest" just toggle visibility in CSS or JS.
      // Actually, let's keep it simple.
    </script>
  </body>
</html>
