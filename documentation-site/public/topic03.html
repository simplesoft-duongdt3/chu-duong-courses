<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate</title>
    <!-- Tailwind CSS via CDN for simplicity and reliability -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            onclick="toggleSidebar()"
            class="lg:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <a
            href="index.html"
            class="ml-3 lg:ml-0 text-xl font-bold text-gray-900 tracking-tight"
          >
            <span class="text-indigo-600">Spring Boot</span> for Frontend Devs
          </a>
        </div>
        <!-- Optional Top Links -->
        <div class="hidden md:flex space-x-4">
          <a
            href="https://github.com/simplesoft-duongdt3/chu-duong-courses"
            target="_blank"
            class="text-gray-500 hover:text-gray-900 transition font-medium"
            >GitHub</a
          >
        </div>
      </div>
    </header>

    <div class="flex-1 max-w-7xl w-full mx-auto flex items-start">
      <!-- Sidebar Navigation -->
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="fixed inset-0 z-50 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-0 lg:w-64 lg:h-[calc(100vh-4rem)] lg:bg-transparent lg:border-r lg:border-gray-200 lg:sticky lg:top-16 overflow-y-auto"
      >
        <div class="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 mb-2">
            <span class="font-bold text-gray-900">Menu</span>
            <button onclick="toggleSidebar()" class="p-2 -mr-2 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-1">
          <div class="mb-4">
            <p
              class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
            >
              Ch∆∞∆°ng tr√¨nh h·ªçc
            </p>
            <a href="index.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot for Frontend Devs
        </a>
<a href="topic01.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain
        </a>
<a href="topic02.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)
        </a>
<a href="topic03.html" class="block px-2 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate
        </a>
<a href="topic04.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch
        </a>
<a href="topic05.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling
        </a>
<a href="topic06.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)
        </a>
<a href="topic07.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator)
        </a>
<a href="topic08.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration
        </a>
<a href="topic09.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading
        </a>
<a href="topic10.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database
        </a>
<a href="topic_black_holes.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging
        </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-4 sm:p-6 lg:padding-8">
        <div class="max-w-4xl mx-auto">
          <article
            class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-indigo-600 hover:prose-a:text-indigo-500 prose-img:rounded-xl shadow-none"
          >
            <h1>Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA &amp; Hibernate</h1>
<p>Trong Frontend, d·ªØ li·ªáu th∆∞·ªùng l√† c√°c JSON Object l·ªìng nhau. Trong Database quan h·ªá (SQL), d·ªØ li·ªáu ƒë∆∞·ª£c chia nh·ªè th√†nh c√°c h√†ng v√† c·ªôt. <strong>JPA (Java Persistence API)</strong> ch√≠nh l√† &quot;ng∆∞·ªùi phi√™n d·ªãch&quot; gi√∫p bi·∫øn c√°c h√†ng ƒë√≥ th√†nh Java Object v√† ng∆∞·ª£c l·∫°i.</p>
<h3>1. L√Ω thuy·∫øt: Nh·ªØng kh√°i ni·ªám &quot;ph·∫£i n·∫±m l√≤ng&quot;</h3>
<ul>
<li><strong>Entity:</strong> L√† m·ªôt class Java ƒë·∫°i di·ªán cho m·ªôt b·∫£ng trong DB. M·ªói instance c·ªßa class n√†y t∆∞∆°ng ·ª©ng v·ªõi m·ªôt h√†ng (row).</li>
<li><strong>Hibernate:</strong> L√† &quot;th·ª£ m√°y&quot; th·ª±c hi·ªán vi·ªác chuy·ªÉn ƒë·ªïi. JPA ch·ªâ l√† &quot;b·∫£n thi·∫øt k·∫ø&quot; (specification).</li>
<li><strong>Persistence Context (First-level Cache):</strong> H√£y t∆∞·ªüng t∆∞·ª£ng ƒë√¢y l√† m·ªôt &quot;v√πng ƒë·ªám&quot;. Khi b·∫°n l·∫•y m·ªôt Entity ra, n√≥ n·∫±m trong v√πng n√†y. N·∫øu b·∫°n s·ª≠a n√≥, Hibernate s·∫Ω t·ª± ƒë·ªông nh·∫≠n bi·∫øt v√† c·∫≠p nh·∫≠t xu·ªëng DB khi k·∫øt th√∫c giao d·ªãch (Transaction) m√† kh√¥ng c·∫ßn b·∫°n g·ªçi h√†m <code>save</code>.</li>
<li><strong>Derived Queries:</strong> Spring Data JPA cho ph√©p b·∫°n t·∫°o truy v·∫•n ch·ªâ b·∫±ng c√°ch ƒë·∫∑t t√™n h√†m. V√≠ d·ª•: <code>findByEmail(String email)</code> s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c d·ªãch th√†nh <code>SELECT * FROM users WHERE email = ?</code>.</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. C·∫•u h√¨nh Database (<code>application.yml</code>)</h4>
<p>Thay v√¨ vi·∫øt code k·∫øt n·ªëi lo·∫±ng ngo·∫±ng, b·∫°n ch·ªâ c·∫ßn khai b√°o:</p>
<pre><code class="language-yaml">spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/mydb
    username: admin
    password: password
  jpa:
    hibernate:
      ddl-auto: update # T·ª± ƒë·ªông t·∫°o/s·ª≠a b·∫£ng d·ª±a tr√™n class Java
    show-sql: true    # Hi·ªán c√¢u l·ªánh SQL ·ªü console ƒë·ªÉ debug
    properties:
      hibernate:
        format_sql: true
</code></pre>
<h4>B. ƒê·ªãnh nghƒ©a Entity &amp; Repository</h4>
<pre><code class="language-java">@Entity
@Table(name = &quot;products&quot;)
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private Double price;

    // Getters/Setters
}

// Ch·ªâ c·∫ßn khai b√°o Interface, Spring s·∫Ω t·ª± vi·∫øt code tri·ªÉn khai!
public interface ProductRepository extends JpaRepository&lt;Product, Long&gt; {
    List&lt;Product&gt; findByPriceGreaterThan(Double price);
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: M·ªëi quan h·ªá Cha-Con (One-to-Many)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> M·ªôt <code>Category</code> c√≥ nhi·ªÅu <code>Product</code>. Frontend mu·ªën khi l·∫•y Category th√¨ th·∫•y lu√¥n danh s√°ch Product.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D√πng <code>@OneToMany</code> v·ªõi <code>fetch = FetchType.LAZY</code>.</li>
<li><strong>L∆∞u √Ω:</strong> Dev Frontend th∆∞·ªùng mu·ªën l·∫•y h·∫øt m·ªôt l·∫ßn, nh∆∞ng trong DB, n·∫øu danh s√°ch con qu√° l·ªõn (tri·ªáu h√†ng), vi·ªác l·∫•y h·∫øt s·∫Ω l√†m s·∫≠p server. ƒê√¢y l√† l√Ω do ta ph·∫£i d√πng <strong>Pagination</strong> (ph√¢n trang).</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: L·ªói kinh ƒëi·ªÉn  Query (Performance)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën l·∫•y 10 b√†i vi·∫øt, v√† v·ªõi m·ªói b√†i vi·∫øt b·∫°n l·∫°i l·∫•y t√™n t√°c gi·∫£.</li>
<li><strong>H·∫≠u qu·∫£:</strong> Hibernate s·∫Ω ch·∫°y 1 c√¢u SELECT l·∫•y 10 b√†i vi·∫øt, sau ƒë√≥ ch·∫°y th√™m 10 c√¢u SELECT n·ªØa ƒë·ªÉ l·∫•y t√°c gi·∫£ c·ªßa t·ª´ng b√†i. T·ªïng c·ªông  c√¢u l·ªánh (trong khi ch·ªâ c·∫ßn 1 c√¢u <code>JOIN</code> l√† ƒë·ªß).</li>
<li><strong>Gi·∫£i ph√°p:</strong> S·ª≠ d·ª•ng <code>@EntityGraph</code> ho·∫∑c <code>JOIN FETCH</code> trong c√¢u truy v·∫•n ƒë·ªÉ √©p Hibernate l·∫•y d·ªØ li·ªáu trong 1 l·∫ßn duy nh·∫•t.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Entity vs. DTO (Data Transfer Object)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Entity c·ªßa b·∫°n c√≥ tr∆∞·ªùng <code>passwordHash</code> ho·∫∑c <code>internalNote</code>. N·∫øu b·∫°n tr·∫£ tr·ª±c ti·∫øp Entity v·ªÅ Frontend, b·∫°n ƒëang h·ªü l·ªó h·ªïng b·∫£o m·∫≠t.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Lu√¥n chuy·ªÉn ƒë·ªïi Entity sang m·ªôt class trung gian g·ªçi l√† <strong>DTO</strong> tr∆∞·ªõc khi g·ª≠i v·ªÅ cho Frontend. ƒêi·ªÅu n√†y gi√∫p b·∫°n ki·ªÉm so√°t ch√≠nh x√°c nh·ªØng g√¨ Frontend ƒë∆∞·ª£c th·∫•y v√† b·∫£o v·ªá c·∫•u tr√∫c DB b√™n d∆∞·ªõi.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh &quot;T∆∞ duy d·ªØ li·ªáu&quot;</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>Frontend (JSON)</th>
<th>Backend (JPA/SQL)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Li√™n k·∫øt</strong></td>
<td>Nesting (Object trong Object)</td>
<td>Foreign Key (ID tham chi·∫øu)</td>
</tr>
<tr>
<td><strong>ƒê·ªãnh danh</strong></td>
<td>T√πy ch·ªçn (ID ho·∫∑c kh√¥ng)</td>
<td>B·∫Øt bu·ªôc ph·∫£i c√≥ <code>@Id</code> (Primary Key)</td>
</tr>
<tr>
<td><strong>Thay ƒë·ªïi</strong></td>
<td>G√°n gi√° tr·ªã m·ªõi (<code>obj.a = 1</code>)</td>
<td>Ph·∫£i n·∫±m trong <code>@Transactional</code> ƒë·ªÉ l∆∞u</td>
</tr>
<tr>
<td><strong>S·ªë l∆∞·ª£ng</strong></td>
<td>Th∆∞·ªùng x·ª≠ l√Ω t·∫≠p d·ªØ li·ªáu nh·ªè</td>
<td>Ph·∫£i x·ª≠ l√Ω h√†ng tri·ªáu h√†ng (Limit/Offset)</td>
</tr>
</tbody></table>
<hr>
<h3>M·∫πo nh·ªè cho b·∫°n:</h3>
<p>ƒê·ª´ng bao gi·ªù tin v√†o <code>ddl-auto: update</code> ·ªü m√¥i tr∆∞·ªùng Production. N√≥ c√≥ th·ªÉ x√≥a c·ªôt ho·∫∑c thay ƒë·ªïi ki·ªÉu d·ªØ li·ªáu c·ªßa b·∫°n ch·ªâ v√¨ m·ªôt l·ªói nh·ªè trong code. H√£y d√πng c√°c c√¥ng c·ª• qu·∫£n l√Ω version DB nh∆∞ <strong>Liquibase</strong> ho·∫∑c <strong>Flyway</strong> (ch√∫ng ta c√≥ th·ªÉ th·∫£o lu·∫≠n ·ªü ch·ªß ƒë·ªÅ sau).</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 3.1: No-DB Service &amp; Multi-DB Configuration</h1>
<h3>1. Service kh√¥ng c√≥ Database (No-DB Service)</h3>
<p>Trong Frontend, b·∫°n g·ªçi l√† &quot;Proxy&quot; ho·∫∑c &quot;BFF&quot; (Backend For Frontend). ·ªû Spring Boot, ƒë√¢y l√† nh·ªØng Service ch·ªâ l√†m nhi·ªám v·ª• logic, t√≠nh to√°n, ho·∫∑c ƒëi·ªÅu h∆∞·ªõng request.</p>
<p><strong>L√Ω thuy·∫øt:</strong></p>
<ul>
<li><strong>Lo·∫°i b·ªè Dependency:</strong> N·∫øu d·ª± √°n ho√†n to√†n kh√¥ng d√πng DB, ƒë∆°n gi·∫£n l√† ƒë·ª´ng khai b√°o <code>spring-boot-starter-data-jpa</code> trong file <code>pom.xml</code> ho·∫∑c <code>build.gradle</code>.</li>
<li><strong>Lo·∫°i b·ªè Auto-Configuration:</strong> N·∫øu b·∫°n l·ª° c√†i th∆∞ vi·ªán JPA nh∆∞ng ch∆∞a mu·ªën c·∫•u h√¨nh DB ngay, Spring Boot s·∫Ω b√°o l·ªói &quot;Failed to configure a DataSource&quot;. B·∫°n ph·∫£i ch·ªß ƒë·ªông t·∫Øt n√≥ ƒëi.</li>
</ul>
<p><strong>C·∫•u h√¨nh &amp; Code m·∫´u:</strong></p>
<pre><code class="language-java">// T·∫Øt t·ª± ƒë·ªông c·∫•u h√¨nh Database trong class Main
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class })
public class ProxyServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProxyServiceApplication.class, args);
    }
}
</code></pre>
<hr>
<h3>2. Service d√πng nhi·ªÅu Database (Multi-DB Service)</h3>
<p>ƒê√¢y l√† k·ªãch b·∫£n ph·ª©c t·∫°p h∆°n. M·∫∑c ƒë·ªãnh Spring Boot ch·ªâ mong ƒë·ª£i <strong>m·ªôt</strong> DataSource. ƒê·ªÉ d√πng hai c√°i, b·∫°n ph·∫£i t·ª± tay &quot;ƒë·∫°o di·ªÖn&quot; vi·ªác kh·ªüi t·∫°o c√°c Bean.</p>
<p><strong>L√Ω thuy·∫øt:</strong><br>ƒê·ªÉ d√πng 2 DB (v√≠ d·ª• MySQL v√† PostgreSQL), b·∫°n c·∫ßn chia d·ª± √°n th√†nh c√°c Package ri√™ng bi·ªát:</p>
<ol>
<li><strong>DB1 (Primary):</strong> Ch·ª©a Entity v√† Repository c·ªßa MySQL.</li>
<li><strong>DB2 (Secondary):</strong> Ch·ª©a Entity v√† Repository c·ªßa PostgreSQL.<br>Spring s·∫Ω d·ª±a v√†o ƒë∆∞·ªùng d·∫´n Package ƒë·ªÉ bi·∫øt &quot;th·∫±ng Repository n√†y th√¨ d√πng k·∫øt n·ªëi c·ªßa DB n√†o&quot;.</li>
</ol>
<p><strong>C·∫•u h√¨nh (<code>application.yml</code>):</strong></p>
<pre><code class="language-yaml">spring:
  datasource:
    primary:
      jdbc-url: jdbc:mysql://localhost:3306/db_chinh
      username: root
      password: 123
      driver-class-name: com.mysql.cj.jdbc.Driver
    secondary:
      jdbc-url: jdbc:postgresql://localhost:5432/db_phu
      username: postgres
      password: 123
      driver-class-name: org.postgresql.Driver
</code></pre>
<p><strong>Code v√≠ d·ª• cho c·∫•u h√¨nh DB th·ª© hai:</strong></p>
<pre><code class="language-java">@Configuration
@EnableJpaRepositories(
    basePackages = &quot;com.example.repository.secondary&quot;, // Ch·ªâ ƒë·ªãnh repository d√πng DB n√†y
    entityManagerFactoryRef = &quot;secondaryEntityManagerFactory&quot;,
    transactionManagerRef = &quot;secondaryTransactionManager&quot;
)
public class SecondaryDbConfig {

    @Bean
    @ConfigurationProperties(&quot;spring.datasource.secondary&quot;)
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }

    @Bean
    public LocalContainerEntityManagerFactoryBean secondaryEntityManagerFactory(
            EntityManagerFactoryBuilder builder) {
        return builder
                .dataSource(secondaryDataSource())
                .packages(&quot;com.example.entity.secondary&quot;) // Ch·ªâ ƒë·ªãnh Entity d√πng DB n√†y
                .build();
    }
    // ... C·∫ßn th√™m TransactionManager t∆∞∆°ng ·ª©ng
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: API Gateway / Aggregator (No-DB)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n c√≥ 10 Microservices kh√°c nhau. Frontend kh√¥ng mu·ªën g·ªçi 10 l·∫ßn. B·∫°n c·∫ßn 1 Service trung gian g·ªçi c·∫£ 10 c√°i ƒë√≥, g·ªôp d·ªØ li·ªáu l·∫°i th√†nh 1 JSON duy nh·∫•t r·ªìi tr·∫£ v·ªÅ.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D√πng Spring Boot v·ªõi <code>WebClient</code> (non-blocking). Service n√†y kh√¥ng c√≥ DB ri√™ng, n√≥ ch·ªâ d√πng RAM ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu t·∫°m th·ªùi. N√≥ ƒë√≥ng vai tr√≤ nh∆∞ m·ªôt &quot;nh√† ƒëi·ªÅu ph·ªëi&quot;.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: T√°ch bi·ªát Read/Write (Multi-DB)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> H·ªá th·ªëng c·ªßa b·∫°n c√≥ l∆∞·ª£ng truy v·∫•n (Read) c·ª±c l·ªõn. B·∫°n mu·ªën c√°c thao t√°c ghi (Write) v√†o DB ch√≠nh (MySQL), c√≤n c√°c thao t√°c ƒë·ªçc b√°o c√°o th√¨ l·∫•y t·ª´ m·ªôt DB b·∫£n sao (Read-Replica) ƒë·ªÉ gi·∫£m t·∫£i.</li>
<li><strong>Gi·∫£i ph√°p:</strong> C·∫•u h√¨nh 2 DataSource. Trong code, c√°c Service l√†m nhi·ªám v·ª• b√°o c√°o s·∫Ω ƒë∆∞·ª£c &quot;ti√™m&quot; (Inject) Repository thu·ªôc v·ªÅ DB Read-only.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: ƒê·ªìng b·ªô d·ªØ li·ªáu c≈© v√† m·ªõi (Migration Service)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> C√¥ng ty ƒëang chuy·ªÉn t·ª´ SQL Server c≈© sang PostgreSQL m·ªõi. B·∫°n c·∫ßn vi·∫øt m·ªôt c√¥ng c·ª• ch·∫°y ng·∫ßm ƒë·ªÉ ƒë·ªçc t·ª´ng d√≤ng t·ª´ SQL Server, x·ª≠ l√Ω logic, r·ªìi ghi v√†o PostgreSQL.</li>
<li><strong>Gi·∫£i ph√°p:</strong> ƒê√¢y l√† l√∫c Multi-DB t·ªèa s√°ng. B·∫°n m·ªü ƒë·ªìng th·ªùi 2 k·∫øt n·ªëi. D√πng m·ªôt <code>Scheduler</code> (h·∫πn gi·ªù) ƒë·ªÉ qu√©t DB1 v√† <code>save</code> sang DB2.</li>
</ul>
<hr>
<h3>T√≥m t·∫Øt cho Dev Frontend chuy·ªÉn h·ªá</h3>
<ul>
<li><strong>No-DB:</strong> Gi·ªëng nh∆∞ b·∫°n vi·∫øt m·ªôt con bot Telegram ho·∫∑c m·ªôt c√°i Proxy b·∫±ng Node.js m√† kh√¥ng d√πng MongoDB/SQL. C·ª±c nh·∫π v√† nhanh.</li>
<li><strong>Multi-DB:</strong> ƒê·ª´ng coi Backend l√† m·ªôt &quot;c·ª•c&quot; duy nh·∫•t n·ªØa. H√£y coi n√≥ l√† m·ªôt <strong>hub k·∫øt n·ªëi</strong>. B·∫°n c√≥ th·ªÉ c·∫Øm bao nhi√™u &quot;·ªï ƒëi·ªán&quot; (Database) t√πy th√≠ch, mi·ªÖn l√† b·∫°n khai b√°o r√µ r√†ng &quot;d√¢y n√†o c·∫Øm v√†o ·ªï n√†o&quot; th√¥ng qua c·∫•u h√¨nh Java Config.</li>
</ul>
<hr>
<h1>Ch·ªß ƒë·ªÅ 3.2: Multi-tenancy - ƒêi·ªÅu h∆∞·ªõng Database ƒë·ªông - Dynamic Routing DataSource</h1>
<h3>1. L√Ω thuy·∫øt: C∆° ch·∫ø &quot;Ph·ªÖu ƒëi·ªÅu h∆∞·ªõng&quot;</h3>
<p>Thay v√¨ tr·∫£ v·ªÅ m·ªôt k·∫øt n·ªëi c·ªë ƒë·ªãnh, Spring s·ª≠ d·ª•ng m·ªôt l·ªõp trung gian g·ªçi l√† <code>AbstractRoutingDataSource</code>.</p>
<ol>
<li><strong>Request t·ªõi:</strong> M·ªôt <strong>Filter</strong> ho·∫∑c <strong>Interceptor</strong> s·∫Ω soi v√†o Header (v√≠ d·ª•: <code>X-Tenant-ID</code>), JWT, ho·∫∑c Domain ƒë·ªÉ bi·∫øt Request n√†y thu·ªôc v·ªÅ kh√°ch h√†ng n√†o.</li>
<li><strong>L∆∞u tr·ªØ ID:</strong> ID c·ªßa kh√°ch h√†ng (Tenant ID) ƒë∆∞·ª£c l∆∞u v√†o m·ªôt bi·∫øn <strong>ThreadLocal</strong> (bi·∫øn n√†y t·ªìn t·∫°i xuy√™n su·ªët lu·ªìng x·ª≠ l√Ω c·ªßa request ƒë√≥).</li>
<li><strong>L·∫•y Connection:</strong> Khi Repository c·∫ßn g·ªçi DB, n√≥ h·ªèi <code>RoutingDataSource</code>. Th·∫±ng n√†y s·∫Ω li·∫øc v√†o <code>ThreadLocal</code>, l·∫•y c√°i ID ra v√† &quot;b·ªëc&quot; ƒë√∫ng k·∫øt n·ªëi c·ªßa DB t∆∞∆°ng ·ª©ng ƒë·ªÉ ƒë∆∞a cho Repository.</li>
</ol>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. N∆°i l∆∞u tr·ªØ Tenant ID (ThreadLocal)</h4>
<p>V√¨ Backend x·ª≠ l√Ω ƒëa lu·ªìng, ta d√πng <code>ThreadLocal</code> ƒë·ªÉ ƒë·∫£m b·∫£o ID c·ªßa kh√°ch h√†ng A kh√¥ng b·ªã l·∫´n sang kh√°ch h√†ng B.</p>
<pre><code class="language-java">public class TenantContext {
    private static final ThreadLocal&lt;String&gt; CURRENT_TENANT = new ThreadLocal&lt;&gt;();

    public static void setCurrentTenant(String tenantId) {
        CURRENT_TENANT.set(tenantId);
    }

    public static String getCurrentTenant() {
        return CURRENT_TENANT.get();
    }

    public static void clear() {
        CURRENT_TENANT.remove();
    }
}
</code></pre>
<h4>B. Tri·ªÉn khai Routing Logic</h4>
<p>ƒê√¢y l√† n∆°i Spring &quot;h·ªèi&quot; b·∫°n: &quot;Gi·ªù d√πng DB n√†o?&quot;</p>
<pre><code class="language-java">public class TransactionRoutingDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        // Tr·∫£ v·ªÅ ID c·ªßa Tenant hi·ªán t·∫°i
        return TenantContext.getCurrentTenant();
    }
}
</code></pre>
<h4>C. Filter b√≥c t√°ch Tenant ID t·ª´ Request</h4>
<p>Gi·ªëng nh∆∞ nh√¢n vi√™n l·ªÖ t√¢n h·ªèi &quot;Anh t·ª´ c√¥ng ty n√†o ƒë·∫øn?&quot;</p>
<pre><code class="language-java">@Component
public class TenantFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
        HttpServletRequest req = (HttpServletRequest) request;
        String tenantId = req.getHeader(&quot;X-Tenant-ID&quot;); // L·∫•y ID t·ª´ Header
        
        if (tenantId != null) {
            TenantContext.setCurrentTenant(tenantId);
        }
        
        try {
            chain.doFilter(request, response);
        } finally {
            TenantContext.clear(); // Quan tr·ªçng: Ph·∫£i x√≥a ƒë·ªÉ tr√°nh memory leak
        }
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: M√¥ h√¨nh SaaS (Software as a Service)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n b√°n ph·∫ßn m·ªÅm k·∫ø to√°n cho 100 c√¥ng ty. Theo lu·∫≠t, d·ªØ li·ªáu c·ªßa C√¥ng ty A kh√¥ng ƒë∆∞·ª£c n·∫±m chung b·∫£ng v·ªõi C√¥ng ty B ƒë·ªÉ ƒë·∫£m b·∫£o b·∫£o m·∫≠t tuy·ªát ƒë·ªëi.</li>
<li><strong>Gi·∫£i ph√°p:</strong> M·ªói c√¥ng ty c√≥ 1 Database ri√™ng (Physical Isolation). Khi nh√¢n vi√™n C√¥ng ty A ƒëƒÉng nh·∫≠p, h·ªá th·ªëng t·ª± ƒë·ªông l√°i m·ªçi c√¢u l·ªánh SQL v·ªÅ ph√≠a Server DB c·ªßa c√¥ng ty ƒë√≥.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: White-labeling (T√πy bi·∫øn th∆∞∆°ng hi·ªáu)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n l√†m m·ªôt App ƒë·∫∑t ƒë·ªì ƒÉn. Kh√°ch h√†ng <code>foody.com</code> d√πng DB t·∫°i Singapore, kh√°ch h√†ng <code>delivery.vn</code> d√πng DB t·∫°i Vi·ªát Nam.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D·ª±a v√†o <strong>Domain name</strong> c·ªßa request g·ª≠i ƒë·∫øn ƒë·ªÉ quy·∫øt ƒë·ªãnh DB. N·∫øu domain k·∫øt th√∫c b·∫±ng <code>.vn</code>, RoutingDataSource s·∫Ω b·ªëc k·∫øt n·ªëi t·ª´ c·ª•m Server Vi·ªát Nam ƒë·ªÉ gi·∫£m latency.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: D√πng chung DB nh∆∞ng kh√°c Schema</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën ti·∫øt ki·ªám ti·ªÅn, ch·ªâ mua 1 Instance DB l·ªõn tr√™n AWS (nh∆∞ PostgreSQL), nh∆∞ng m·ªói kh√°ch h√†ng n·∫±m ·ªü 1 <strong>Schema</strong> kh√°c nhau.</li>
<li><strong>Gi·∫£i ph√°p:</strong> L√∫c n√†y thay v√¨ ƒë·ªïi <code>DataSource</code>, b·∫°n s·∫Ω g·ª≠i m·ªôt c√¢u l·ªánh <code>SET search_path TO tenant_id</code> ngay khi k·∫øt n·ªëi v·ª´a ƒë∆∞·ª£c thi·∫øt l·∫≠p.</li>
</ul>
<hr>
<h3>T√≥m t·∫Øt cho &quot;D√¢n Frontend&quot;</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>C√°ch l√†m th·ªß c√¥ng (D·ªÖ sai)</th>
<th>C√°ch l√†m c·ªßa Spring (Multi-tenancy)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Logic ch·ªçn DB</strong></td>
<td>Vi·∫øt <code>if/else</code> trong t·ª´ng h√†m Service</td>
<td>Vi·∫øt 1 l·∫ßn duy nh·∫•t ·ªü t·∫ßng Configuration</td>
</tr>
<tr>
<td><strong>Truy·ªÅn tham s·ªë</strong></td>
<td>Ph·∫£i truy·ªÅn <code>tenantId</code> v√†o m·ªçi h√†m</td>
<td>T·ª± ƒë·ªông l·∫•y t·ª´ &quot;Ng·ªØ c·∫£nh&quot; (Context)</td>
</tr>
<tr>
<td><strong>B·∫£o m·∫≠t</strong></td>
<td>D·ªÖ qu√™n <code>WHERE tenant_id = ...</code></td>
<td>C√°ch ly ho√†n to√†n ·ªü t·∫ßng k·∫øt n·ªëi, kh√¥ng th·ªÉ ƒë·ªçc nh·∫ßm</td>
</tr>
</tbody></table>
<hr>
<p><strong>C·∫£nh b√°o nh·∫π:</strong> Vi·ªác qu·∫£n l√Ω nhi·ªÅu DB r·∫•t t·ªën t√†i nguy√™n (Connection Pool). N·∫øu b·∫°n c√≥ 1000 kh√°ch h√†ng m√† m·ªói kh√°ch h√†ng m·ªü 10 k·∫øt n·ªëi th√¨ server s·∫Ω &quot;ng·∫•t&quot; ngay. Ng∆∞·ªùi ta th∆∞·ªùng d√πng k·∫øt h·ª£p v·ªõi <strong>Dynamic DataSource Loading</strong> (ch·ªâ n·∫°p DB khi c√≥ request v√† gi·∫£i ph√≥ng khi kh√¥ng d√πng).</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 3.1: C·∫•u h√¨nh Chi ti·∫øt Multi-DataSource trong Spring Boot 3</h1>
<p>ƒê·ªÉ d√πng ƒë∆∞·ª£c t·ª´ 2 Database tr·ªü l√™n, b·∫°n c·∫ßn th·ª±c hi·ªán 3 b∆∞·ªõc: Khai b√°o c·∫•u h√¨nh, vi·∫øt l·ªõp Java Config ri√™ng cho t·ª´ng DB v√† chia package cho Entity/Repository.</p>
<h3>1. C·∫•u h√¨nh Properties (<code>application.yml</code>)</h3>
<p>Ch√∫ng ta s·∫Ω ƒë·ªãnh nghƒ©a hai ngu·ªìn d·ªØ li·ªáu: m·ªôt cho <strong>Order</strong> (MySQL) v√† m·ªôt cho <strong>Inventory</strong> (PostgreSQL).</p>
<pre><code class="language-yaml">spring:
  datasource:
    # Database th·ª© nh·∫•t (Primary)
    orders:
      jdbc-url: jdbc:mysql://localhost:3306/db_orders
      username: root
      password: password
      driver-class-name: com.mysql.cj.jdbc.Driver
    # Database th·ª© hai
    inventory:
      jdbc-url: jdbc:postgresql://localhost:5432/db_inventory
      username: postgres
      password: password
      driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
</code></pre>
<hr>
<h3>2. Java Configuration (Ph·∫ßn quan tr·ªçng nh·∫•t)</h3>
<p>B·∫°n c·∫ßn t·∫°o c√°c l·ªõp Config ri√™ng bi·ªát ƒë·ªÉ ch·ªâ ƒë·ªãnh: &quot;Repository ·ªü package n√†o th√¨ ƒëi v·ªõi Database n√†o&quot;.</p>
<h4>A. C·∫•u h√¨nh Database 1 (Orders - Primary)</h4>
<pre><code class="language-java">@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(
    basePackages = &quot;com.example.repository.orders&quot;, // Ch·ªâ qu√©t repository trong package n√†y
    entityManagerFactoryRef = &quot;ordersEntityManagerFactory&quot;,
    transactionManagerRef = &quot;ordersTransactionManager&quot;
)
public class OrdersDbConfig {

    @Primary
    @Bean(name = &quot;ordersDataSource&quot;)
    @ConfigurationProperties(&quot;spring.datasource.orders&quot;)
    public DataSource dataSource() {
        return DataSourceBuilder.create().build();
    }

    @Primary
    @Bean(name = &quot;ordersEntityManagerFactory&quot;)
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(
            EntityManagerFactoryBuilder builder, @Qualifier(&quot;ordersDataSource&quot;) DataSource dataSource) {
        return builder
                .dataSource(dataSource)
                .packages(&quot;com.example.entity.orders&quot;) // Ch·ªâ qu√©t Entity trong package n√†y
                .persistenceUnit(&quot;orders&quot;)
                .build();
    }

    @Primary
    @Bean(name = &quot;ordersTransactionManager&quot;)
    public PlatformTransactionManager transactionManager(
            @Qualifier(&quot;ordersEntityManagerFactory&quot;) EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }
}
</code></pre>
<h4>B. C·∫•u h√¨nh Database 2 (Inventory)</h4>
<p>C·∫•u h√¨nh t∆∞∆°ng t·ª± nh∆∞ng <strong>kh√¥ng c√≥</strong> <code>@Primary</code> v√† tr·ªè v√†o package kh√°c.</p>
<pre><code class="language-java">@Configuration
@EnableJpaRepositories(
    basePackages = &quot;com.example.repository.inventory&quot;,
    entityManagerFactoryRef = &quot;inventoryEntityManagerFactory&quot;,
    transactionManagerRef = &quot;inventoryTransactionManager&quot;
)
public class InventoryDbConfig {

    @Bean(name = &quot;inventoryDataSource&quot;)
    @ConfigurationProperties(&quot;spring.datasource.inventory&quot;)
    public DataSource dataSource() {
        return DataSourceBuilder.create().build();
    }

    @Bean(name = &quot;inventoryEntityManagerFactory&quot;)
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(
            EntityManagerFactoryBuilder builder, @Qualifier(&quot;inventoryDataSource&quot;) DataSource dataSource) {
        return builder
                .dataSource(dataSource)
                .packages(&quot;com.example.entity.inventory&quot;)
                .persistenceUnit(&quot;inventory&quot;)
                .build();
    }

    @Bean(name = &quot;inventoryTransactionManager&quot;)
    public PlatformTransactionManager transactionManager(
            @Qualifier(&quot;inventoryEntityManagerFactory&quot;) EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }
}
</code></pre>
<hr>
<h3>3. T·ªï ch·ª©c th∆∞ m·ª•c (Project Structure)</h3>
<p>ƒê√¢y l√† ch√¨a kh√≥a ƒë·ªÉ Spring kh√¥ng b·ªã l·∫´n l·ªôn gi·ªØa c√°c DB:</p>
<pre><code class="language-text">src/main/java/com/example/
 ‚îú‚îÄ‚îÄ config/
 ‚îÇ    ‚îú‚îÄ‚îÄ OrdersDbConfig.java
 ‚îÇ    ‚îî‚îÄ‚îÄ InventoryDbConfig.java
 ‚îú‚îÄ‚îÄ entity/
 ‚îÇ    ‚îú‚îÄ‚îÄ orders/       &lt;-- Entity cho DB Orders
 ‚îÇ    ‚îî‚îÄ‚îÄ inventory/    &lt;-- Entity cho DB Inventory
 ‚îî‚îÄ‚îÄ repository/
      ‚îú‚îÄ‚îÄ orders/       &lt;-- Repository cho DB Orders
      ‚îî‚îÄ‚îÄ inventory/    &lt;-- Repository cho DB Inventory
</code></pre>
<hr>
<h3>4. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: T√°ch bi·ªát d·ªØ li·ªáu nh·∫°y c·∫£m</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n l√†m ·ª©ng d·ª•ng Fintech. Th√¥ng tin c√° nh√¢n (KYC) ph·∫£i l∆∞u ·ªü m·ªôt DB c√≥ m√£ h√≥a c·ª±c m·∫°nh, c√≤n l·ªãch s·ª≠ giao d·ªãch l∆∞u ·ªü DB kh√°c ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô ƒë·ªçc.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D√πng Multi-DataSource. Khi l∆∞u User, b·∫°n g·ªçi <code>KycRepository</code>. Khi l∆∞u giao d·ªãch, b·∫°n g·ªçi <code>TransactionRepository</code>. Spring s·∫Ω t·ª± ƒë·ªông m·ªü ƒë√∫ng k·∫øt n·ªëi t∆∞∆°ng ·ª©ng.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: T√≠ch h·ª£p h·ªá th·ªëng c≈© (Legacy System)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n vi·∫øt m·ªôt Service m·ªõi b·∫±ng Spring Boot nh∆∞ng ph·∫£i ƒë·ªçc d·ªØ li·ªáu User t·ª´ m·ªôt DB Oracle &quot;c·ªï ƒë·∫°i&quot; c·ªßa c√¥ng ty, ƒë·ªìng th·ªùi l∆∞u d·ªØ li·ªáu m·ªõi v√†o PostgreSQL.</li>
<li><strong>Gi·∫£i ph√°p:</strong> C·∫•u h√¨nh DB Oracle l√† <code>Secondary</code> (ch·ªâ ƒë·ªçc) v√† PostgreSQL l√† <code>Primary</code>. B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng JOIN d·ªØ li·ªáu ·ªü t·∫ßng Java Service sau khi l·∫•y t·ª´ 2 Repository kh√°c nhau.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: CQRS ƒë∆°n gi·∫£n (Command Query Responsibility Segregation)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> DB ch√≠nh b·ªã ch·∫≠m do qu√° nhi·ªÅu ng∆∞·ªùi v√†o xem b√°o c√°o.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·∫°n t·∫°o m·ªôt DB b·∫£n sao (Read-only Replica). Trong Spring Boot, b·∫°n c·∫•u h√¨nh 2 DataSource tr·ªè v√†o 2 DB n√†y. C√°c h√†m <code>get...</code> s·∫Ω d√πng <code>ReadOnlyRepository</code>, c√°c h√†m <code>save/update</code> d√πng <code>WriteRepository</code>.</li>
</ul>
<hr>
<p><strong>Ghi ch√∫ cho Dev Frontend:</strong><br>Vi·ªác c·∫•u h√¨nh n√†y gi·ªëng nh∆∞ b·∫°n ƒëang thi·∫øt l·∫≠p nhi·ªÅu <strong>Base URL</strong> kh√°c nhau trong Axios cho t·ª´ng lo·∫°i d·ªØ li·ªáu v·∫≠y. ƒêi·ªÉm kh√°c bi·ªát l√† ·ªü Backend, vi·ªác &quot;ch·ªçn URL n√†o&quot; ƒë∆∞·ª£c th·ª±c hi·ªán d·ª±a tr√™n package c·ªßa code thay v√¨ chu·ªói string trong code.</p>
<hr>
<p>Ti·∫øp n·ªëi ch·ªß ƒë·ªÅ Multi-tenancy, ch√∫ng ta s·∫Ω ƒëi s√¢u v√†o <strong>AbstractRoutingDataSource</strong>. ƒê√¢y l√† gi·∫£i ph√°p &quot;t·ªëi th∆∞·ª£ng&quot; khi b·∫°n kh√¥ng mu·ªën (ho·∫∑c kh√¥ng th·ªÉ) c·∫•u h√¨nh c·ª©ng t·ª´ng Database m·ªôt.</p>
<p>N·∫øu ·ªü Frontend b·∫°n d√πng <strong>Environment Variables</strong> ƒë·ªÉ ƒë·ªïi API URL, th√¨ ·ªü Backend, ch√∫ng ta d√πng <strong>RoutingDataSource</strong> ƒë·ªÉ ƒë·ªïi &quot;ƒë·∫ßu d√¢y&quot; k·∫øt n·ªëi Database ngay khi code ƒëang ch·∫°y.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 3.2: ƒêi·ªÅu h∆∞·ªõng Database ƒë·ªông v·ªõi AbstractRoutingDataSource</h1>
<h3>1. L√Ω thuy·∫øt: C∆° ch·∫ø &quot;T·ªïng ƒë√†i vi√™n&quot;</h3>
<p>H√£y t∆∞·ªüng t∆∞·ª£ng <code>AbstractRoutingDataSource</code> nh∆∞ m·ªôt t·ªïng ƒë√†i ƒëi·ªán tho·∫°i. Khi m·ªôt c√¢u l·ªánh SQL (Request) g·ªçi ƒë·∫øn, t·ªïng ƒë√†i vi√™n s·∫Ω h·ªèi: &quot;Anh l√† ai?&quot;. D·ª±a tr√™n c√¢u tr·∫£ l·ªùi, h·ªç s·∫Ω c·∫Øm d√¢y v√†o ƒë√∫ng ·ªï c·∫Øm Database c·ªßa ng∆∞·ªùi ƒë√≥.</p>
<p><strong>Quy tr√¨nh 3 b∆∞·ªõc:</strong></p>
<ol>
<li><strong>X√°c ƒë·ªãnh (Identification):</strong> L·∫•y <code>tenantId</code> t·ª´ Request (Header, Token, ho·∫∑c Domain).</li>
<li><strong>L∆∞u tr·ªØ (Storage):</strong> C·∫•t <code>tenantId</code> v√†o <code>ThreadLocal</code> ƒë·ªÉ m·ªçi t·∫ßng code (Service, Repository) ƒë·ªÅu bi·∫øt ƒëang ph·ª•c v·ª• ai.</li>
<li><strong>ƒêi·ªÅu h∆∞·ªõng (Routing):</strong> <code>AbstractRoutingDataSource</code> nh√¨n v√†o <code>ThreadLocal</code> v√† tr·∫£ v·ªÅ k·∫øt n·ªëi DB t∆∞∆°ng ·ª©ng.</li>
</ol>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. B·ªô l∆∞u tr·ªØ ng·ªØ c·∫£nh (TenantContext)</h4>
<p>S·ª≠ d·ª•ng <code>ThreadLocal</code> ƒë·ªÉ ƒë·∫£m b·∫£o th√¥ng tin kh√°ch h√†ng kh√¥ng b·ªã &quot;l·∫´n&quot; gi·ªØa c√°c Request ch·∫°y song song.</p>
<pre><code class="language-java">public class TenantContext {
    private static final ThreadLocal&lt;String&gt; currentTenant = new ThreadLocal&lt;&gt;();

    public static void setTenantId(String tenantId) {
        currentTenant.set(tenantId);
    }

    public static String getTenantId() {
        return currentTenant.get();
    }

    public static void clear() {
        currentTenant.remove();
    }
}
</code></pre>
<h4>B. L·ªõp ƒëi·ªÅu h∆∞·ªõng (RoutingDataSource)</h4>
<p>L·ªõp n√†y ghi ƒë√® logic ch·ªçn &quot;Key&quot; ƒë·ªÉ t√¨m Database.</p>
<pre><code class="language-java">import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;

public class TenantRoutingDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        // Spring s·∫Ω g·ªçi h√†m n√†y m·ªói khi c·∫ßn k·∫øt n·ªëi DB
        return TenantContext.getTenantId();
    }
}
</code></pre>
<h4>C. C·∫•u h√¨nh Bean (Configuration)</h4>
<p>B·∫°n c·∫ßn m·ªôt Map ƒë·ªÉ ch·ª©a danh s√°ch c√°c Database.</p>
<pre><code class="language-java">@Configuration
public class DataSourceConfig {

    @Bean
    public DataSource dataSource() {
        TenantRoutingDataSource routingDataSource = new TenantRoutingDataSource();

        // 1. T·∫°o danh s√°ch c√°c DB th·ª±c t·∫ø
        Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;&gt;();
        targetDataSources.put(&quot;TENANT_A&quot;, createDataSource(&quot;jdbc:mysql://localhost:3306/db_a&quot;));
        targetDataSources.put(&quot;TENANT_B&quot;, createDataSource(&quot;jdbc:mysql://localhost:3306/db_b&quot;));

        routingDataSource.setTargetDataSources(targetDataSources);
        
        // 2. DB m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t√¨m th·∫•y tenantId
        routingDataSource.setDefaultTargetDataSource(createDataSource(&quot;jdbc:mysql://localhost:3306/db_default&quot;));

        return routingDataSource;
    }

    private DataSource createDataSource(String url) {
        return DataSourceBuilder.create()
                .url(url)
                .username(&quot;root&quot;)
                .password(&quot;password&quot;)
                .build();
    }
}
</code></pre>
<h4>D. L·∫•y Tenant ID t·ª´ Request (Interceptor)</h4>
<p>ƒê√¢y l√† n∆°i b·∫°n &quot;b·∫Øt&quot; th√¥ng tin t·ª´ Frontend.</p>
<pre><code class="language-java">@Component
public class TenantInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String tenantId = request.getHeader(&quot;X-Tenant-ID&quot;);
        TenantContext.setTenantId(tenantId);
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        TenantContext.clear(); // B·∫Øt bu·ªôc ph·∫£i x√≥a ƒë·ªÉ tr√°nh r√≤ r·ªâ d·ªØ li·ªáu (Security Risk)
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: H·ªá th·ªëng SaaS b√°n h√†ng cho c√°c Shop</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> M·ªói Shop (Tenant) c√≥ h√†ng tri·ªáu ƒë∆°n h√†ng. N·∫øu l∆∞u chung m·ªôt DB s·∫Ω c·ª±c k·ª≥ ch·∫≠m v√† kh√≥ backup ri√™ng l·∫ª cho t·ª´ng kh√°ch.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Khi ch·ªß Shop A ƒëƒÉng nh·∫≠p, Frontend g·ª≠i Header <code>X-Tenant-ID: shop_a</code>. Backend t·ª± ƒë·ªông l√°i to√†n b·ªô query v√†o DB c·ªßa Shop A. Khi Shop B ƒëƒÉng nh·∫≠p, d·ªØ li·ªáu l·∫°i ƒë∆∞·ª£c l√°i sang DB c·ªßa Shop B.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: T√°ch bi·ªát m√¥i tr∆∞·ªùng Demo v√† Real</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën kh√°ch h√†ng d√πng th·ª≠ (Demo) tr√™n d·ªØ li·ªáu th·∫≠t nh∆∞ng kh√¥ng mu·ªën h·ªç l√†m h·ªèng d·ªØ li·ªáu ƒëang ch·∫°y (Production).</li>
<li><strong>Gi·∫£i ph√°p:</strong> D·ª±a v√†o User Role. N·∫øu Role l√† <code>GUEST</code>, RoutingDataSource s·∫Ω tr·ªè v√†o <code>db_sandbox</code>. N·∫øu Role l√† <code>ADMIN</code>, n√≥ s·∫Ω tr·ªè v√†o <code>db_production</code>.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: H·ªá th·ªëng ƒëa qu·ªëc gia (Data Residency)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Lu·∫≠t ph√°p y√™u c·∫ßu d·ªØ li·ªáu ng∆∞·ªùi d√πng EU ph·∫£i l∆∞u t·∫°i m√°y ch·ªß EU, d·ªØ li·ªáu M·ªπ l∆∞u t·∫°i M·ªπ.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D·ª±a v√†o IP ho·∫∑c ƒë·ªãa ch·ªâ email c·ªßa User khi ƒëƒÉng nh·∫≠p. RoutingDataSource s·∫Ω ƒëi·ªÅu h∆∞·ªõng k·∫øt n·ªëi t·ªõi c·ª•m Database v·∫≠t l√Ω ƒë·∫∑t t·∫°i v√πng l√£nh th·ªï t∆∞∆°ng ·ª©ng.</li>
</ul>
<hr>
<h3>L∆∞u √Ω &quot;s∆∞∆°ng m√°u&quot; cho Dev Frontend chuy·ªÉn h·ªá:</h3>
<ol>
<li><strong>Connection Pool:</strong> M·ªói Database trong Map s·∫Ω chi·∫øm m·ªôt l∆∞·ª£ng k·∫øt n·ªëi nh·∫•t ƒë·ªãnh. ƒê·ª´ng m·ªü qu√° nhi·ªÅu DB c√πng l√∫c k·∫ªo treo server.</li>
<li><strong>Transaction:</strong> Vi·ªác chuy·ªÉn ƒë·ªïi DB ph·∫£i x·∫£y ra <strong>tr∆∞·ªõc</strong> khi m·ªôt <code>@Transactional</code> b·∫Øt ƒë·∫ßu. N·∫øu ƒë√£ v√†o trong Transaction r·ªìi m√† b·∫°n ƒë·ªïi <code>TenantContext</code>, n√≥ s·∫Ω kh√¥ng c√≥ t√°c d·ª•ng.</li>
<li><strong>Liquibase/Flyway:</strong> Vi·ªác c·∫≠p nh·∫≠t c·∫•u tr√∫c b·∫£ng (Migration) cho 100 DB c√πng l√∫c l√† m·ªôt th·ª≠ th√°ch l·ªõn. B·∫°n s·∫Ω c·∫ßn vi·∫øt script ƒë·ªÉ l·∫∑p qua danh s√°ch DB v√† ch·∫°y migration cho t·ª´ng c√°i.</li>
</ol>
<hr>

          </article>

          <!-- Navigation Footer (Next/Prev) -->
          <div class="mt-12 pt-8 border-t border-gray-200 flex justify-between">
            <a href="topic02.html" class="text-indigo-600 font-medium hover:text-indigo-800">‚Üê Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)</a><a href="topic04.html" class="text-indigo-600 font-medium hover:text-indigo-800">Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch ‚Üí</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div
      onclick="toggleSidebar()"
      id="overlay"
      class="fixed inset-0 bg-black/50 z-10 lg:hidden hidden"
      style="display: none"
    ></div>
    <script>
      // Simple overlay logic
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      // Sync overlay with sidebar state check if needed, but for "simplest" just toggle visibility in CSS or JS.
      // Actually, let's keep it simple.
    </script>
  </body>
</html>
