<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading</title>
    <!-- Tailwind CSS via CDN for simplicity and reliability -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            onclick="toggleSidebar()"
            class="lg:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <a
            href="index.html"
            class="ml-3 lg:ml-0 text-xl font-bold text-gray-900 tracking-tight"
          >
            <span class="text-indigo-600">Spring Boot</span> for Frontend Devs
          </a>
        </div>
        <!-- Optional Top Links -->
        <div class="hidden md:flex space-x-4">
          <a
            href="https://github.com/simplesoft-duongdt3/chu-duong-courses"
            target="_blank"
            class="text-gray-500 hover:text-gray-900 transition font-medium"
            >GitHub</a
          >
        </div>
      </div>
    </header>

    <div class="flex-1 max-w-7xl w-full mx-auto flex items-start">
      <!-- Sidebar Navigation -->
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="fixed inset-0 z-50 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-0 lg:w-64 lg:h-[calc(100vh-4rem)] lg:bg-transparent lg:border-r lg:border-gray-200 lg:sticky lg:top-16 overflow-y-auto"
      >
        <div class="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 mb-2">
            <span class="font-bold text-gray-900">Menu</span>
            <button onclick="toggleSidebar()" class="p-2 -mr-2 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-1">
          <div class="mb-4">
            <p
              class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
            >
              Ch∆∞∆°ng tr√¨nh h·ªçc
            </p>
            <a href="index.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot for Frontend Devs
        </a>
<a href="topic01.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain
        </a>
<a href="topic02.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)
        </a>
<a href="topic03.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate
        </a>
<a href="topic04.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch
        </a>
<a href="topic05.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling
        </a>
<a href="topic06.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)
        </a>
<a href="topic07.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator)
        </a>
<a href="topic08.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration
        </a>
<a href="topic09.html" class="block px-2 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading
        </a>
<a href="topic10.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database
        </a>
<a href="topic11.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 11: External API Call & Backend For Frontend (BFF)
        </a>
<a href="topic_best_practices.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot 3 Best Practices (The Pro Checklist)
        </a>
<a href="topic_black_holes.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging
        </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-4 sm:p-6 lg:padding-8">
        <div class="max-w-4xl mx-auto">
          <article
            class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-indigo-600 hover:prose-a:text-indigo-500 prose-img:rounded-xl shadow-none"
          >
            <h1>Ch·ªß ƒë·ªÅ 9: Concurrency &amp; Multi-threading</h1>
<p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi m·ªôt trong nh·ªØng ch·ªß ƒë·ªÅ &quot;kh√≥ nh·∫±n&quot; nh·∫•t nh∆∞ng c≈©ng quy·ªÅn nƒÉng nh·∫•t c·ªßa Java Backend.</p>
<p>N·∫øu ·ªü Frontend (JavaScript), b·∫°n s·ªëng trong th·∫ø gi·ªõi <strong>Single-threaded</strong> (ƒë∆°n lu·ªìng) v·ªõi <strong>Event Loop</strong>, n∆°i m·ªçi th·ª© d∆∞·ªùng nh∆∞ ch·∫°y c√πng l√∫c nh∆∞ng th·ª±c ch·∫•t ch·ªâ c√≥ m·ªôt vi·ªác ƒë∆∞·ª£c x·ª≠ l√Ω t·∫°i m·ªôt th·ªùi ƒëi·ªÉm. Th√¨ ·ªü Spring Boot, b·∫°n b∆∞·ªõc v√†o th·∫ø gi·ªõi <strong>Multi-threading</strong> (ƒëa lu·ªìng). M·ªôt bi·∫øn s·ªë c√≥ th·ªÉ b·ªã h√†ng ngh√¨n &quot;ng∆∞·ªùi&quot; (thread) c√πng l√∫c nh√†o v√†o thay ƒë·ªïi.</p>
<hr>
<h3>1. L√Ω thuy·∫øt: Thread-per-request vs Event Loop</h3>
<ul>
<li><strong>M√¥ h√¨nh c·ªßa Spring Boot (Tomcat):</strong> M·ªói Request t·ª´ Frontend g·ª≠i l√™n s·∫Ω ƒë∆∞·ª£c &quot;giao kho√°n&quot; cho m·ªôt Thread ri√™ng bi·ªát t·ª´ <strong>Thread Pool</strong>. N·∫øu c√≥ 200 request c√πng l√∫c, s·∫Ω c√≥ 200 thread ch·∫°y song song.</li>
<li><strong>V·∫•n ƒë·ªÅ Thread-safety:</strong> V√¨ c√°c Service trong Spring m·∫∑c ƒë·ªãnh l√† <strong>Singleton</strong> (d√πng chung 1 instance duy nh·∫•t), n√™n n·∫øu b·∫°n khai b√°o m·ªôt bi·∫øn &quot;global&quot; trong Service, t·∫•t c·∫£ c√°c Thread s·∫Ω d√πng chung bi·∫øn ƒë√≥. ƒê√¢y l√† n∆°i th·∫£m h·ªça b·∫Øt ƒë·∫ßu n·∫øu b·∫°n kh√¥ng ki·ªÉm so√°t ƒë∆∞·ª£c vi·ªác tranh ch·∫•p d·ªØ li·ªáu (Race Condition).</li>
<li><strong>Virtual Threads (Java 21 + Spring Boot 3.2+):</strong> ƒê√¢y l√† cu·ªôc c√°ch m·∫°ng gi√∫p Java c√≥ th·ªÉ x·ª≠ l√Ω h√†ng tri·ªáu request ƒë·ªìng th·ªùi m√† kh√¥ng t·ªën nhi·ªÅu RAM nh∆∞ Thread truy·ªÅn th·ªëng (Platform Threads).</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. Race Condition - Sai l·∫ßm kinh ƒëi·ªÉn c·ªßa Dev Frontend</h4>
<p>Trong React, b·∫°n d√πng <code>useState</code> r·∫•t an to√†n. Trong Spring, bi·∫øn instance l√† &quot;c·ªßa chung&quot;.</p>
<pre><code class="language-java">@Service
public class CounterService {
    private int count = 0; // BI·∫æN N√ÄY C·ª∞C K·ª≤ NGUY HI·ªÇM TRONG SINGLETON BEAN

    public int increment() {
        return ++count; // N·∫øu 2 thread c√πng ch·∫°y d√≤ng n√†y, k·∫øt qu·∫£ s·∫Ω sai l·ªách!
    }
    
    // GI·∫¢I PH√ÅP: D√πng Thread-safe classes
    private AtomicInteger safeCount = new AtomicInteger(0);

    public int safeIncrement() {
        return safeCount.incrementAndGet(); // ƒê·∫£m b·∫£o lu√¥n ƒë√∫ng d√π bao nhi√™u lu·ªìng g·ªçi
    }
}
</code></pre>
<h4>B. X·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô v·ªõi <code>@Async</code></h4>
<p>Gi·ªëng nh∆∞ b·∫°n ƒë·∫©y m·ªôt vi·ªác v√†o <code>Web Worker</code> ho·∫∑c ch·∫°y m·ªôt <code>Promise</code> m√† kh√¥ng <code>await</code>.</p>
<pre><code class="language-java">@Configuration
@EnableAsync // B·∫≠t t√≠nh nƒÉng ch·∫°y ng·∫ßm
public class AsyncConfig {
    @Bean
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix(&quot;MyAsync-&quot;);
        executor.initialize();
        return executor;
    }
}

@Service
@Slf4j
public class EmailService {
    @Async // H√†m n√†y s·∫Ω ch·∫°y ·ªü thread kh√°c, kh√¥ng b·∫Øt user ch·ªù
    public void sendHeavyEmail(String target) {
        log.info(&quot;ƒêang g·ª≠i email cho {} t·∫°i thread: {}&quot;, target, Thread.currentThread().getName());
        // Gi·∫£ l·∫≠p t·ªën 5 gi√¢y
        Thread.sleep(5000); 
        log.info(&quot;ƒê√£ g·ª≠i xong!&quot;);
    }
}
</code></pre>
<h4>C. B·∫≠t Virtual Threads (Spring Boot 3.2+)</h4>
<p>Ch·ªâ c·∫ßn 1 d√≤ng c·∫•u h√¨nh ƒë·ªÉ bi·∫øn app c·ªßa b·∫°n th√†nh &quot;si√™u nh√¢n&quot; x·ª≠ l√Ω ƒë·ªìng th·ªùi.</p>
<pre><code class="language-yaml">spring:
  threads:
    virtual:
      enabled: true
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Xu·∫•t b√°o c√°o Excel ngh√¨n trang</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User nh·∫•n n√∫t &quot;Export&quot;. N·∫øu ch·∫°y b√¨nh th∆∞·ªùng, API s·∫Ω xoay v√≤ng ch·ªù 1 ph√∫t m·ªõi xong. Tr√¨nh duy·ªát c√≥ th·ªÉ b·ªã Timeout (504).</li>
<li><strong>Gi·∫£i ph√°p:</strong> Khi nh·∫≠n y√™u c·∫ßu, Backend l∆∞u tr·∫°ng th√°i &quot;Processing&quot; v√†o DB v√† b·∫Øn ngay m√£ <code>202 Accepted</code> v·ªÅ cho Frontend. ƒê·ªìng th·ªùi, d√πng <code>@Async</code> ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫°o file ·ªü m·ªôt lu·ªìng ng·∫ßm. Khi xong, g·ª≠i th√¥ng b√°o (Socket ho·∫∑c Push) cho Frontend.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: C·∫≠p nh·∫≠t s·ªë d∆∞ kho h√†ng (Flash Sale)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> 1000 ng∆∞·ªùi c√πng nh·∫•n mua 1 m√≥n h√†ng cu·ªëi c√πng.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Kh√¥ng d√πng bi·∫øn <code>int</code> b√¨nh th∆∞·ªùng. B·∫°n ph·∫£i d√πng <strong>Pessimistic Locking</strong> (Kh√≥a ·ªü c·∫•p Database) ho·∫∑c <strong>Optimistic Locking</strong> (D√πng version) ƒë·ªÉ ƒë·∫£m b·∫£o t·∫°i m·ªôt th·ªùi ƒëi·ªÉm ch·ªâ c√≥ 1 ng∆∞·ªùi mua th√†nh c√¥ng, nh·ªØng ng∆∞·ªùi c√≤n l·∫°i s·∫Ω nh·∫≠n l·ªói &quot;H·∫øt h√†ng&quot; m·ªôt c√°ch ch√≠nh x√°c.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: G·ªçi nhi·ªÅu API b√™n th·ª© ba c√πng l√∫c (Aggregator)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n c·∫ßn th√¥ng tin t·ª´ 3 b√™n: T·ªâ gi√°, Th·ªùi ti·∫øt, v√† Gi√° v√†ng ƒë·ªÉ hi·ªÉn th·ªã Dashboard. N·∫øu g·ªçi tu·∫ßn t·ª±, t·ªïng th·ªùi gian l√† .</li>
<li><strong>Gi·∫£i ph√°p:</strong> D√πng <code>CompletableFuture</code> (gi·ªëng nh∆∞ <code>Promise.all</code> c·ªßa JS) ƒë·ªÉ g·ªçi c·∫£ 3 API c√πng l√∫c. T·ªïng th·ªùi gian ch·ªâ b·∫±ng th·∫±ng l√¢u nh·∫•t ().</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh t∆∞ duy lu·ªìng</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>Frontend (JS)</th>
<th>Backend (Spring Boot)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>B·∫£n ch·∫•t lu·ªìng</strong></td>
<td>ƒê∆°n lu·ªìng, kh√¥ng bao gi·ªù lo tranh ch·∫•p bi·∫øn.</td>
<td>ƒêa lu·ªìng, bi·∫øn global l√† &quot;t·ª≠ ƒë·ªãa&quot;.</td>
</tr>
<tr>
<td><strong>X·ª≠ l√Ω l√¢u</strong></td>
<td>D√πng Web Workers ho·∫∑c Async/Await.</td>
<td>D√πng <code>@Async</code>, Thread Pool ho·∫∑c Virtual Threads.</td>
</tr>
<tr>
<td><strong>S·ª± c·ªë th∆∞·ªùng g·∫∑p</strong></td>
<td>UI b·ªã ƒë√≥ng bƒÉng (Main thread b·ªã block).</td>
<td>H·ªá th·ªëng h·∫øt Thread (Thread starvation) ho·∫∑c sai l·ªách d·ªØ li·ªáu.</td>
</tr>
<tr>
<td><strong>ƒê·ªô ∆∞u ti√™n</strong></td>
<td>Ph·∫£n h·ªìi m∆∞·ª£t m√† cho 1 User.</td>
<td>Ph·∫£n h·ªìi ch√≠nh x√°c cho h√†ng tri·ªáu User.</td>
</tr>
</tbody></table>
<hr>
<p><strong>L·ªùi khuy√™n t·ª´ &quot;h·∫≠u ph∆∞∆°ng&quot;:</strong> ƒê·ª´ng bao gi·ªù l·∫°m d·ª•ng t·∫°o Thread m·ªõi b·∫±ng <code>new Thread().start()</code>. H√£y lu√¥n d√πng <strong>Thread Pool</strong> (ExecutorService) ƒë·ªÉ qu·∫£n l√Ω t√†i nguy√™n. Vi·ªác t·∫°o m·ªôt Thread trong Java truy·ªÅn th·ªëng r·∫•t t·ªën k√©m (kho·∫£ng <strong>1MB</strong> RAM m·ªói thread), n√™n n·∫øu t·∫°o v√¥ t·ªôi v·∫°, server s·∫Ω &quot;bay m√†u&quot; v√¨ <code>OutOfMemoryError</code> r·∫•t nhanh.</p>
<hr>
<p>Ch√†o b·∫°n! Vi·ªác n·∫Øm v·ªØng <code>CompletableFuture</code> l√† b∆∞·ªõc n√¢ng c·∫•p c·ª±c k·ª≥ quan tr·ªçng ƒë·ªëi v·ªõi m·ªôt Backend dev. N·∫øu ·ªü Frontend b·∫°n c√≥ <code>Promise.all()</code> ƒë·ªÉ th·ª±c hi·ªán nhi·ªÅu request c√πng l√∫c, th√¨ trong Java, <code>CompletableFuture</code> ch√≠nh l√† &quot;v≈© kh√≠&quot; t∆∞∆°ng ƒë∆∞∆°ng ƒë·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu nƒÉng v√† gi·∫£m ƒë·ªô tr·ªÖ (latency).</p>
<p>D∆∞·ªõi ƒë√¢y l√† chi ti·∫øt v·ªÅ c√°ch d√πng <code>CompletableFuture</code> trong Spring Boot 3.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 8.1: CompletableFuture - Song song h√≥a t√°c v·ª•</h1>
<h3>1. L√Ω thuy·∫øt: Bridge t·ª´ JS Promise sang Java CompletableFuture</h3>
<p>H√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n c·∫ßn l·∫•y d·ªØ li·ªáu t·ª´ 3 ngu·ªìn kh√°c nhau. N·∫øu ch·∫°y tu·∫ßn t·ª± (Sequential), t·ªïng th·ªùi gian s·∫Ω l√† t·ªïng c·ªßa 3 request. N·∫øu ch·∫°y song song (Parallel), t·ªïng th·ªùi gian ch·ªâ b·∫±ng request l√¢u nh·∫•t.</p>
<table>
<thead>
<tr>
<th>JavaScript (Frontend)</th>
<th>Java (Spring Boot)</th>
<th>√ù nghƒ©a</th>
</tr>
</thead>
<tbody><tr>
<td><code>new Promise((res, rej) =&gt; ...)</code></td>
<td><code>CompletableFuture.supplyAsync(() -&gt; ...)</code></td>
<td>T·∫°o m·ªôt t√°c v·ª• ch·∫°y ng·∫ßm.</td>
</tr>
<tr>
<td><code>.then(data =&gt; ...)</code></td>
<td><code>.thenApply(data -&gt; ...)</code></td>
<td>X·ª≠ l√Ω d·ªØ li·ªáu sau khi xong.</td>
</tr>
<tr>
<td><code>Promise.all([p1, p2])</code></td>
<td><code>CompletableFuture.allOf(f1, f2)</code></td>
<td>ƒê·ª£i t·∫•t c·∫£ ho√†n th√†nh.</td>
</tr>
<tr>
<td><code>.catch(err =&gt; ...)</code></td>
<td><code>.exceptionally(ex -&gt; ...)</code></td>
<td>X·ª≠ l√Ω l·ªói.</td>
</tr>
</tbody></table>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. C·∫•u h√¨nh Thread Pool (Executor)</h4>
<p>ƒê·ªÉ <code>CompletableFuture</code> ho·∫°t ƒë·ªông hi·ªáu qu·∫£, b·∫°n n√™n ƒë·ªãnh nghƒ©a m·ªôt <code>ThreadPool</code> ri√™ng thay v√¨ d√πng chung <code>ForkJoinPool</code> m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng.</p>
<pre><code class="language-java">@Configuration
public class AsyncConfig {
    @Bean(name = &quot;apiExecutor&quot;)
    public Executor apiExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix(&quot;API-Thread-&quot;);
        executor.initialize();
        return executor;
    }
}
</code></pre>
<h4>B. Code tri·ªÉn khai g·ªçi song song 3 API</h4>
<p>Gi·∫£ s·ª≠ b·∫°n c·∫ßn x√¢y d·ª±ng m·ªôt Dashboard t·ªïng h·ª£p th√¥ng tin.</p>
<pre><code class="language-java">@Service
@RequiredArgsConstructor
public class DashboardService {

    private final ExternalApiService apiService; // Gi·∫£ ƒë·ªãnh service g·ªçi API ngo√†i
    private final Executor apiExecutor;

    public DashboardDTO getFullDashboard() {
        // 1. Kh·ªüi ch·∫°y 3 t√°c v·ª• song song
        CompletableFuture&lt;Double&gt; exchangeRateFuture = CompletableFuture.supplyAsync(
            () -&gt; apiService.getExchangeRate(), apiExecutor);

        CompletableFuture&lt;String&gt; weatherFuture = CompletableFuture.supplyAsync(
            () -&gt; apiService.getWeather(), apiExecutor);

        CompletableFuture&lt;Integer&gt; goldPriceFuture = CompletableFuture.supplyAsync(
            () -&gt; apiService.getGoldPrice(), apiExecutor);

        // 2. Ch·ªù c·∫£ 3 th·∫±ng xong (Gi·ªëng Promise.all)
        CompletableFuture.allOf(exchangeRateFuture, weatherFuture, goldPriceFuture).join();

        // 3. Thu th·∫≠p k·∫øt qu·∫£
        try {
            return new DashboardDTO(
                exchangeRateFuture.get(),
                weatherFuture.get(),
                goldPriceFuture.get()
            );
        } catch (Exception e) {
            throw new RuntimeException(&quot;L·ªói khi t·ªïng h·ª£p d·ªØ li·ªáu&quot;);
        }
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: &quot;Enrichment&quot; D·ªØ li·ªáu (B·ªï sung th√¥ng tin)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Khi user xem chi ti·∫øt ƒë∆°n h√†ng, b·∫°n c·∫ßn: Th√¥ng tin ƒë∆°n h√†ng (t·ª´ DB1), Th√¥ng tin v·∫≠n chuy·ªÉn (t·ª´ API Giao h√†ng), v√† Th√¥ng tin khuy·∫øn m√£i (t·ª´ DB2).</li>
<li><strong>Gi·∫£i ph√°p:</strong> Thay v√¨ g·ªçi tu·∫ßn t·ª± t·ªën 1.5 gi√¢y, b·∫°n b·∫Øn c·∫£ 3 request c√πng l√∫c. Th·ªùi gian ph·∫£n h·ªìi gi·∫£m xu·ªëng c√≤n 0.6 gi√¢y (b·∫±ng request l√¢u nh·∫•t).</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: X·ª≠ l√Ω l·ªói t·ª´ng ph·∫ßn (Resilience)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n g·ªçi 3 API, nh∆∞ng API &quot;Th·ªùi ti·∫øt&quot; b·ªã s·∫≠p. B·∫°n kh√¥ng mu·ªën c·∫£ Dashboard b·ªã l·ªói theo.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D√πng <code>.exceptionally()</code> ƒë·ªÉ tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu API ƒë√≥ l·ªói.</li>
</ul>
<pre><code class="language-java">CompletableFuture&lt;String&gt; weatherFuture = CompletableFuture.supplyAsync(() -&gt; apiService.getWeather())
    .exceptionally(ex -&gt; &quot;D·ªØ li·ªáu th·ªùi ti·∫øt t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng&quot;);
</code></pre>
<p><strong>T√¨nh hu·ªëng 3: G·ª≠i th√¥ng b√°o ƒëa k√™nh (Multi-channel Notification)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Khi c√≥ ƒë∆°n h√†ng m·ªõi, b·∫°n c·∫ßn g·ª≠i ƒë·ªìng th·ªùi Email, SMS v√† Push Notification.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·∫°n kh√¥ng th·ªÉ b·∫Øt User ch·ªù g·ª≠i xong c·∫£ 3 c√°i m·ªõi hi·ªán &quot;Th√†nh c√¥ng&quot;. B·∫°n d√πng <code>CompletableFuture.runAsync()</code> ƒë·ªÉ ƒë·∫©y c·∫£ 3 vi·ªác n√†y ra c√°c lu·ªìng ch·∫°y ng·∫ßm v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ cho User ngay l·∫≠p t·ª©c.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh &quot;Wait&quot; vs &quot;Non-wait&quot;</h3>
<table>
<thead>
<tr>
<th>Ph∆∞∆°ng th·ª©c</th>
<th>√ù nghƒ©a</th>
<th>Frontend t∆∞∆°ng ·ª©ng</th>
</tr>
</thead>
<tbody><tr>
<td><code>.join()</code> / <code>.get()</code></td>
<td>Ch·ªù cho ƒë·∫øn khi c√≥ k·∫øt qu·∫£ (Blocking).</td>
<td><code>await promise</code></td>
</tr>
<tr>
<td><code>.thenAccept()</code></td>
<td>Khi xong th√¨ l√†m g√¨ ƒë√≥ (Non-blocking).</td>
<td><code>.then(data =&gt; ...)</code></td>
</tr>
<tr>
<td><code>.anyOf()</code></td>
<td>Ch·ªâ c·∫ßn 1 th·∫±ng nhanh nh·∫•t xong l√† ƒë∆∞·ª£c.</td>
<td><code>Promise.race()</code></td>
</tr>
</tbody></table>
<hr>
<p><strong>M·∫πo nh·ªè cho b·∫°n:</strong> Trong Spring Boot 3, n·∫øu b·∫°n s·ª≠ d·ª•ng <strong>Virtual Threads</strong> (Java 21), vi·ªác d√πng <code>CompletableFuture</code> th·∫≠m ch√≠ c√≤n &quot;kh·ªßng&quot; h∆°n v√¨ n√≥ kh√¥ng l√†m t·ªën t√†i nguy√™n Thread th·∫≠t c·ªßa h·ªá ƒëi·ªÅu h√†nh.</p>
<hr>
<p><strong>Virtual Threads</strong> (Project Loom)</p>
<p>ƒê√∫ng l√† Virtual Threads gi√∫p ch√∫ng ta x·ª≠ l√Ω h√†ng tri·ªáu request m√† kh√¥ng t·ªën nhi·ªÅu RAM, nh∆∞ng n√≥ <strong>kh√¥ng ph·∫£i l√† chi·∫øc ƒë≈©a th·∫ßn</strong>. N·∫øu s·ª≠ d·ª•ng sai c√°ch, b·∫°n s·∫Ω g·∫∑p nh·ªØng l·ªói c·ª±c k·ª≥ kh√≥ ch·ªãu m√† h·ªá th·ªëng d√πng Thread truy·ªÅn th·ªëng kh√¥ng bao gi·ªù g·∫∑p ph·∫£i.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 8.2: Nh·ªØng &quot;C·∫°m b·∫´y&quot; khi s·ª≠ d·ª•ng Virtual Threads</h1>
<p>Trong Spring Boot 3.2+, vi·ªác b·∫≠t Virtual Threads r·∫•t d·ªÖ (<code>spring.threads.virtual.enabled=true</code>), nh∆∞ng d∆∞·ªõi ƒë√¢y l√† nh·ªØng v·∫•n ƒë·ªÅ b·∫°n ph·∫£i ƒë·ªëi m·∫∑t.</p>
<h3>1. L√Ω thuy·∫øt: Hi·ªán t∆∞·ª£ng &quot;Pinning&quot; (B·ªã gƒÉm lu·ªìng)</h3>
<p>Virtual Thread (VT) ch·∫°y tr√™n m·ªôt lu·ªìng th·∫≠t c·ªßa h·ªá ƒëi·ªÅu h√†nh g·ªçi l√† <strong>Carrier Thread</strong>.</p>
<ul>
<li><strong>B√¨nh th∆∞·ªùng:</strong> Khi VT g·∫∑p m·ªôt t√°c v·ª• ch·ªù (nh∆∞ g·ªçi API, ƒë·ªçc DB), n√≥ s·∫Ω t·ª± ƒë·ªông &quot;nh∆∞·ªùng gh·∫ø&quot; cho VT kh√°c ch·∫°y tr√™n Carrier Thread ƒë√≥.</li>
<li><strong>V·∫•n ƒë·ªÅ (Pinning):</strong> N·∫øu b·∫°n th·ª±c hi·ªán t√°c v·ª• ch·ªù ƒë√≥ b√™n trong m·ªôt kh·ªëi <strong><code>synchronized</code></strong> ho·∫∑c g·ªçi code <strong>Native</strong> (C/C++), VT s·∫Ω b·ªã &quot;d√≠nh ch·∫∑t&quot; v√†o Carrier Thread.</li>
<li><strong>H·∫≠u qu·∫£:</strong> Carrier Thread b·ªã chi·∫øm d·ª•ng ho√†n to√†n, kh√¥ng th·ªÉ ph·ª•c v·ª• c√°c VT kh√°c. N·∫øu t·∫•t c·∫£ Carrier Threads ƒë·ªÅu b·ªã &quot;pin&quot;, h·ªá th·ªëng c·ªßa b·∫°n s·∫Ω b·ªã treo (Deadlock) d√π CPU v·∫´n ƒëang r·∫£nh.</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. Code g√¢y l·ªói Pinning (S·ª≠ d·ª•ng <code>synchronized</code>)</h4>
<p>ƒê√¢y l√† l·ªói c·ª±c k·ª≥ ph·ªï bi·∫øn v√¨ nhi·ªÅu th∆∞ vi·ªán c≈© v·∫´n d√πng t·ª´ kh√≥a n√†y.</p>
<pre><code class="language-java">@Service
public class LegacyService {
    private final Object lock = new Object();

    // L·ªñI: Khi ch·∫°y v·ªõi Virtual Thread, h√†m n√†y s·∫Ω g√¢y &#39;Pinning&#39;
    public void processData() {
        synchronized(lock) { 
            // Th·ª±c hi·ªán I/O b√™n trong synchronized l√† &#39;t·ª≠ ƒë·ªãa&#39;
            callExternalApi(); 
        }
    }
    
    // GI·∫¢I PH√ÅP: Thay th·∫ø b·∫±ng ReentrantLock
    private final ReentrantLock reentrantLock = new ReentrantLock();

    public void safeProcessData() {
        reentrantLock.lock();
        try {
            callExternalApi(); // Virtual Thread c√≥ th·ªÉ &#39;nh∆∞·ªùng gh·∫ø&#39; an to√†n ·ªü ƒë√¢y
        } finally {
            reentrantLock.unlock();
        }
    }
}
</code></pre>
<h4>B. C·∫•u h√¨nh ki·ªÉm tra Pinning</h4>
<p>B·∫°n c√≥ th·ªÉ y√™u c·∫ßu JVM c·∫£nh b√°o khi c√≥ hi·ªán t∆∞·ª£ng Pinning x·∫£y ra b·∫±ng c√°ch th√™m tham s·ªë khi ch·∫°y App:</p>
<pre><code class="language-bash">-Djdk.tracePinnedThreads=full
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: &quot;Ngh·∫Ωn c·ªï chai&quot; t·∫°i Database Connection Pool</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n t·ª± tin b·∫≠t Virtual Threads ƒë·ªÉ x·ª≠ l√Ω 10,000 request ƒë·ªìng th·ªùi. Nh∆∞ng <code>HikariCP</code> (DB Pool) c·ªßa b·∫°n ch·ªâ c·∫•u h√¨nh c√≥ 10 k·∫øt n·ªëi.</li>
<li><strong>H·∫≠u qu·∫£:</strong> 10 lu·ªìng l·∫•y ƒë∆∞·ª£c k·∫øt n·ªëi, 9,990 lu·ªìng c√≤n l·∫°i s·∫Ω ƒë·ª©ng x·∫øp h√†ng ch·ªù. Virtual Threads gi√∫p b·∫°n &quot;m·ªü c·ª≠a&quot; cho nhi·ªÅu ng∆∞·ªùi v√†o nh√†, nh∆∞ng &quot;nh√† v·ªá sinh&quot; (Database) c·ªßa b·∫°n v·∫´n ch·ªâ c√≥ b·∫•y nhi√™u ƒë√≥ ch·ªó. H·ªá th·ªëng s·∫Ω b√°o l·ªói <code>Connection is not available</code> h√†ng lo·∫°t.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: L·∫°m d·ª•ng ThreadLocal (Memory Leak)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> ·ªû Frontend/App, b·∫°n th∆∞·ªùng l∆∞u d·ªØ li·ªáu t·∫°m v√†o bi·∫øn to√†n c·ª•c. ·ªû Backend, dev th∆∞·ªùng d√πng <code>ThreadLocal</code> ƒë·ªÉ l∆∞u th√¥ng tin User.</li>
<li><strong>H·∫≠u qu·∫£:</strong> Virtual Threads ƒë∆∞·ª£c t·∫°o v√† h·ªßy c·ª±c nhanh v·ªõi s·ªë l∆∞·ª£ng l·ªõn. N·∫øu b·∫°n l∆∞u c√°c Object n·∫∑ng v√†o <code>ThreadLocal</code>, b·ªô nh·ªõ RAM s·∫Ω b·ªã ng·ªën kh·ªßng khi·∫øp v√¨ m·ªói VT trong s·ªë h√†ng tri·ªáu lu·ªìng ƒë·ªÅu gi·ªØ m·ªôt b·∫£n sao d·ªØ li·ªáu ƒë√≥.</li>
<li><strong>Gi·∫£i ph√°p:</strong> S·ª≠ d·ª•ng <strong>Scoped Values</strong> (T√≠nh nƒÉng m·ªõi c·ªßa Java 21) ƒë·ªÉ thay th·∫ø <code>ThreadLocal</code>.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Th∆∞ vi·ªán b√™n th·ª© ba ch∆∞a t∆∞∆°ng th√≠ch</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n d√πng m·ªôt th∆∞ vi·ªán JDBC c≈© ho·∫∑c SDK c≈© c·ªßa m·ªôt b√™n cung c·∫•p thanh to√°n.</li>
<li><strong>H·∫≠u qu·∫£:</strong> B√™n trong th∆∞ vi·ªán ƒë√≥ d√πng r·∫•t nhi·ªÅu <code>synchronized</code>. Khi b·∫°n b·∫≠t Virtual Threads, to√†n b·ªô h·ªá th·ªëng ch·∫≠m l·∫°i m·ªôt c√°ch kh√≥ hi·ªÉu d√π b·∫°n ƒë√£ t·ªëi ∆∞u code c·ªßa m√¨nh.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Ph·∫£i ki·ªÉm tra (Profile) h·ªá th·ªëng th∆∞·ªùng xuy√™n ƒë·ªÉ ph√°t hi·ªán c√°c th∆∞ vi·ªán g√¢y ngh·∫Ωn.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh r·ªßi ro</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>Platform Thread (C≈©)</th>
<th>Virtual Thread (M·ªõi)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>S·ªë l∆∞·ª£ng</strong></td>
<td>Gi·ªõi h·∫°n (v√†i trƒÉm/ngh√¨n)</td>
<td>G·∫ßn nh∆∞ v√¥ h·∫°n (tri·ªáu)</td>
</tr>
<tr>
<td><strong>Chi ph√≠ t·∫°o</strong></td>
<td>R·∫•t ƒë·∫Øt (1MB/thread)</td>
<td>R·∫•t r·∫ª (v√†i KB)</td>
</tr>
<tr>
<td><strong>Nguy c∆° l·ªõn nh·∫•t</strong></td>
<td>H·∫øt RAM (OutOfMemory)</td>
<td><strong>Pinning</strong> &amp; <strong>Resource Exhaustion</strong></td>
</tr>
<tr>
<td><strong>T·ª´ kh√≥a ki√™ng k·ªã</strong></td>
<td>Kh√¥ng c√≥</td>
<td><code>synchronized</code></td>
</tr>
</tbody></table>
<hr>
<h3>T√≥m t·∫Øt cho &quot;D√¢n Frontend&quot; chuy·ªÉn h·ªá:</h3>
<p>H√£y t∆∞·ªüng t∆∞·ª£ng <strong>Platform Threads</strong> l√† nh·ªØng chi·∫øc <strong>xe Bus</strong> c·ªìng k·ªÅnh (√≠t xe, t·ªën xƒÉng). <strong>Virtual Threads</strong> l√† nh·ªØng chi·∫øc <strong>xe m√°y</strong> (nh·∫π, c·ª±c nhi·ªÅu).</p>
<ul>
<li>N·∫øu ƒë∆∞·ªùng t·∫Øc (Database ch·∫≠m), xe m√°y v·∫´n t·∫Øc nh∆∞ xe bus.</li>
<li>N·∫øu b·∫°n b·∫Øt xe m√°y ch·∫°y v√†o l√†n ƒë∆∞·ªùng c·ªßa xe bus (kh·ªëi <code>synchronized</code>), b·∫°n s·∫Ω l√†m h·ªèng c·∫£ h·ªá th·ªëng giao th√¥ng.</li>
</ul>
<p><strong>B·∫°n th·∫•y sao v·ªÅ Virtual Threads?</strong> N·∫øu b·∫°n ƒëang b·∫Øt ƒë·∫ßu m·ªôt d·ª± √°n m·ªõi ho√†n to√†n v·ªõi Spring Boot 3.2+, l·ªùi khuy√™n l√† h√£y b·∫≠t n√≥ l√™n, nh∆∞ng h√£y tr√°nh xa <code>synchronized</code> v√† ki·ªÉm so√°t k·ªπ c√°c Pool t√†i nguy√™n (DB, Redis).</p>

          </article>

          <!-- Navigation Footer (Next/Prev) -->
          <div class="mt-12 pt-8 border-t border-gray-200 flex justify-between">
            <a href="topic08.html" class="text-indigo-600 font-medium hover:text-indigo-800">‚Üê Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration</a><a href="topic10.html" class="text-indigo-600 font-medium hover:text-indigo-800">Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database ‚Üí</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div
      onclick="toggleSidebar()"
      id="overlay"
      class="fixed inset-0 bg-black/50 z-10 lg:hidden hidden"
      style="display: none"
    ></div>
    <script>
      // Simple overlay logic
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      // Sync overlay with sidebar state check if needed, but for "simplest" just toggle visibility in CSS or JS.
      // Actually, let's keep it simple.
    </script>
  </body>
</html>
