<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling</title>
    <!-- Tailwind CSS via CDN for simplicity and reliability -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            onclick="toggleSidebar()"
            class="lg:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <a
            href="index.html"
            class="ml-3 lg:ml-0 text-xl font-bold text-gray-900 tracking-tight"
          >
            <span class="text-indigo-600">Spring Boot</span> for Frontend Devs
          </a>
        </div>
        <!-- Optional Top Links -->
        <div class="hidden md:flex space-x-4">
          <a
            href="https://github.com/simplesoft-duongdt3/chu-duong-courses"
            target="_blank"
            class="text-gray-500 hover:text-gray-900 transition font-medium"
            >GitHub</a
          >
        </div>
      </div>
    </header>

    <div class="flex-1 max-w-7xl w-full mx-auto flex items-start">
      <!-- Sidebar Navigation -->
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="fixed inset-0 z-50 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-0 lg:w-64 lg:h-[calc(100vh-4rem)] lg:bg-transparent lg:border-r lg:border-gray-200 lg:sticky lg:top-16 overflow-y-auto"
      >
        <div class="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 mb-2">
            <span class="font-bold text-gray-900">Menu</span>
            <button onclick="toggleSidebar()" class="p-2 -mr-2 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-1">
          <div class="mb-4">
            <p
              class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
            >
              Ch∆∞∆°ng tr√¨nh h·ªçc
            </p>
            <a href="index.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot for Frontend Devs
        </a>
<a href="topic01.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain
        </a>
<a href="topic02.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)
        </a>
<a href="topic03.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate
        </a>
<a href="topic04.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch
        </a>
<a href="topic05.html" class="block px-2 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling
        </a>
<a href="topic06.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)
        </a>
<a href="topic07.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator)
        </a>
<a href="topic08.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration
        </a>
<a href="topic09.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading
        </a>
<a href="topic10.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database
        </a>
<a href="topic11.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 11: External API Call & Backend For Frontend (BFF)
        </a>
<a href="topic_black_holes.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging
        </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-4 sm:p-6 lg:padding-8">
        <div class="max-w-4xl mx-auto">
          <article
            class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-indigo-600 hover:prose-a:text-indigo-500 prose-img:rounded-xl shadow-none"
          >
            <p>N·∫øu ·ªü Frontend, b·∫°n th∆∞·ªùng x·ª≠ l√Ω l·ªói b·∫±ng <code>try-catch</code> quanh c√°c h√†m g·ªçi API ho·∫∑c d√πng Axios Interceptors ƒë·ªÉ b·∫Øt m√£ 400, 500 r·ªìi hi·ªÉn th·ªã Toast Message, th√¨ ·ªü Backend, ch√∫ng ta c·∫ßn m·ªôt &quot;t·∫•m l∆∞·ªõi&quot; kh·ªïng l·ªì ƒë·ªÉ b·∫Øt m·ªçi sai s√≥t tr∆∞·ªõc khi ch√∫ng bi·∫øn th√†nh nh·ªØng d√≤ng log Java lo·∫±ng ngo·∫±ng g·ª≠i v·ªÅ cho ng∆∞·ªùi d√πng.</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 5: Validation &amp; Global Exception Handling</h1>
<p>Trong Spring Boot 3, m·ª•c ti√™u c·ªßa ch√∫ng ta l√†: <strong>D·ªØ li·ªáu v√†o ph·∫£i s·∫°ch, d·ªØ li·ªáu ra (l·ªói) ph·∫£i ƒë·∫πp.</strong></p>
<h3>1. L√Ω thuy·∫øt: T·∫ßng ph√≤ng ng·ª± v√† T·∫ßng x·ª≠ l√Ω</h3>
<ul>
<li><strong>Bean Validation (Jakarta Validation):</strong> S·ª≠ d·ª•ng c√°c Annotation nh∆∞ <code>@NotNull</code>, <code>@Size</code>, <code>@Min</code>, <code>@Email</code> tr·ª±c ti·∫øp tr√™n c√°c DTO. ƒê√¢y l√† t·∫ßng ph√≤ng ng·ª± ƒë·∫ßu ti√™n ngay t·∫°i Controller.</li>
<li><strong>@RestControllerAdvice:</strong> M·ªôt &quot;Interceptor ƒë·∫∑c bi·ªát&quot; chuy√™n ƒëi nh·∫∑t c√°c Exception b·ªã n√©m ra t·ª´ b·∫•t k·ª≥ ƒë√¢u (Controller, Service, Repository).</li>
<li><strong>Error Response DTO:</strong> Thay v√¨ tr·∫£ v·ªÅ l·ªói m·∫∑c ƒë·ªãnh c·ªßa Spring (th∆∞·ªùng thi·∫øu th√¥ng tin ho·∫∑c qu√° th√¥), ch√∫ng ta ƒë·ªãnh nghƒ©a m·ªôt c·∫•u tr√∫c JSON th·ªëng nh·∫•t ƒë·ªÉ Frontend d·ªÖ d√†ng x·ª≠ l√Ω (v√≠ d·ª•: lu√¥n c√≥ <code>code</code>, <code>message</code>, v√† <code>timestamp</code>).</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. ƒê·ªãnh nghƒ©a DTO v·ªõi Validation</h4>
<p>ƒê·ª´ng bao gi·ªù tin d·ªØ li·ªáu t·ª´ Frontend g·ª≠i l√™n, d√π b·∫°n ƒë√£ check ·ªü ƒë√≥ r·ªìi!</p>
<pre><code class="language-java">public record UserRegistrationDTO(
    @NotBlank(message = &quot;Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng&quot;)
    @Size(min = 3, max = 20, message = &quot;Username ph·∫£i t·ª´ 3-20 k√Ω t·ª±&quot;)
    String username,

    @Email(message = &quot;Email kh√¥ng h·ª£p l·ªá&quot;)
    String email,

    @Min(value = 18, message = &quot;B·∫°n ph·∫£i tr√™n 18 tu·ªïi&quot;)
    int age
) {}
</code></pre>
<h4>B. Controller nh·∫≠n d·ªØ li·ªáu</h4>
<p>S·ª≠ d·ª•ng Annotation <code>@Valid</code> ƒë·ªÉ k√≠ch ho·∫°t b·ªô ki·ªÉm tra.</p>
<pre><code class="language-java">@PostMapping(&quot;/register&quot;)
public ResponseEntity&lt;String&gt; register(@Valid @RequestBody UserRegistrationDTO dto) {
    return ResponseEntity.ok(&quot;ƒêƒÉng k√Ω th√†nh c√¥ng!&quot;);
}
</code></pre>
<h4>C. Global Exception Handler (T·∫•m l∆∞·ªõi b·∫£o hi·ªÉm)</h4>
<pre><code class="language-java">@RestControllerAdvice
public class GlobalExceptionHandler {

    // 1. B·∫Øt l·ªói Validation (400 Bad Request)
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleValidationExceptions(MethodArgumentNotValidException ex) {
        Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();
        ex.getBindingResult().getFieldErrors().forEach(error -&gt; 
            errors.put(error.getField(), error.getDefaultMessage()));
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errors);
    }

    // 2. B·∫Øt l·ªói logic nghi·ªáp v·ª• t·ª± ƒë·ªãnh nghƒ©a
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleBusinessException(BusinessException ex) {
        ErrorResponse error = new ErrorResponse(&quot;BIZ_ERR&quot;, ex.getMessage());
        return ResponseEntity.status(HttpStatus.UNPROCESSABLE_ENTITY).body(error);
    }

    // 3. B·∫Øt m·ªçi l·ªói kh√¥ng mong mu·ªën (500 Internal Server Error)
    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleAllExceptions(Exception ex) {
        // Ghi log l·ªói t·∫°i ƒë√¢y ƒë·ªÉ admin ki·ªÉm tra
        ErrorResponse error = new ErrorResponse(&quot;SYS_ERR&quot;, &quot;H·ªá th·ªëng ƒëang b·∫≠n, vui l√≤ng th·ª≠ l·∫°i sau&quot;);
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Hi·ªÉn th·ªã l·ªói chi ti·∫øt tr√™n Form Frontend</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Frontend c·∫ßn bi·∫øt ch√≠nh x√°c field n√†o b·ªã l·ªói ƒë·ªÉ t√¥ ƒë·ªè (v√≠ d·ª•: <code>email</code> kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng).</li>
<li><strong>Gi·∫£i ph√°p:</strong> Backend tr·∫£ v·ªÅ m·ªôt Map c√°c l·ªói validation v·ªõi HTTP 400. Frontend ch·ªâ c·∫ßn loop qua c√°i Map n√†y ƒë·ªÉ hi·ªÉn th·ªã message t∆∞∆°ng ·ª©ng ngay d∆∞·ªõi c√°c √¥ Input.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: X·ª≠ l√Ω l·ªói &quot;B·∫£n ghi ƒë√£ t·ªìn t·∫°i&quot; (Conflict)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User ƒëƒÉng k√Ω v·ªõi Email ƒë√£ c√≥ trong h·ªá th·ªëng.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Trong Service, b·∫°n check DB, n·∫øu t·ªìn t·∫°i th√¨ <code>throw new BusinessException(&quot;Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng&quot;)</code>. Global Handler s·∫Ω b·∫Øt ƒë∆∞·ª£c v√† tr·∫£ v·ªÅ JSON chu·∫©n thay v√¨ l√†m s·∫≠p lu·ªìng x·ª≠ l√Ω.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: B·∫£o m·∫≠t th√¥ng tin h·ªá th·ªëng (Information Leakage)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Khi DB b·ªã s·∫≠p, Spring m·∫∑c ƒë·ªãnh c√≥ th·ªÉ tr·∫£ v·ªÅ c·∫£ m·ªôt ƒëo·∫°n StackTrace d√†i d·∫±ng d·∫∑c, l·ªô t√™n b·∫£ng, t√™n c·ªôt v√† logic code.</li>
<li><strong>Gi·∫£i ph√°p:</strong> S·ª≠ d·ª•ng c√°i &quot;l∆∞·ªõi&quot; <code>ExceptionHandler(Exception.class)</code> ƒë·ªÉ ·∫©n ƒëi c√°c chi ti·∫øt k·ªπ thu·∫≠t v√† ch·ªâ tr·∫£ v·ªÅ m·ªôt th√¥ng b√°o th√¢n thi·ªán: &quot;Something went wrong&quot;.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh &quot;T∆∞ duy b·∫Øt l·ªói&quot;</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>Frontend</th>
<th>Backend (Spring Boot)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>M·ª•c ƒë√≠ch ch√≠nh</strong></td>
<td>Tr·∫£i nghi·ªám ng∆∞·ªùi d√πng (UX)</td>
<td>T√≠nh to√†n v·∫πn d·ªØ li·ªáu &amp; B·∫£o m·∫≠t</td>
</tr>
<tr>
<td><strong>C√¥ng c·ª•</strong></td>
<td><code>if/else</code>, <code>try-catch</code>, <code>Yup/Zod</code></td>
<td><code>Jakarta Validation</code>, <code>@RestControllerAdvice</code></td>
</tr>
<tr>
<td><strong>K·∫øt qu·∫£ tr·∫£ v·ªÅ</strong></td>
<td>Toast, Alert, Red Border</td>
<td>JSON Object + HTTP Status Code</td>
</tr>
<tr>
<td><strong>Ph·∫°m vi</strong></td>
<td>T·ª´ng Component / Page</td>
<td>To√†n b·ªô Application</td>
</tr>
</tbody></table>
<hr>
<blockquote>
<p><strong>M·∫πo nh·ªè:</strong> ƒê·ª´ng c·ªë b·∫Øt l·ªói trong t·ª´ng h√†m Controller. H√£y c·ª© ƒë·ªÉ n√≥ &quot;n√©m&quot; (throw) tho·∫£i m√°i, v√¨ ch√∫ng ta ƒë√£ c√≥ <code>@RestControllerAdvice</code> lo li·ªáu m·ªçi th·ª© ·ªü m·ªôt n∆°i t·∫≠p trung r·ªìi. Code c·ªßa b·∫°n s·∫Ω c·ª±c k·ª≥ s·∫°ch s·∫Ω!</p>
</blockquote>
<hr>
<p>Vi·ªác t·∫°o ra m·ªôt <strong>Custom Exception</strong> ri√™ng kh√¥ng ch·ªâ gi√∫p code c·ªßa b·∫°n &quot;s·∫°ch&quot; h∆°n m√† c√≤n gi√∫p Frontend x·ª≠ l√Ω logic c·ª±c k·ª≥ nh√†n. Thay v√¨ ch·ªâ nh·∫≠n v·ªÅ m√£ 500 chung chung, Frontend s·∫Ω nh·∫≠n ƒë∆∞·ª£c c√°c <strong>Error Code</strong> c·ª• th·ªÉ ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng th√¥ng b√°o ho·∫∑c th·ª±c hi·ªán h∆∞·ªõng x·ª≠ l√Ω ri√™ng (v√≠ d·ª•: code <code>TOKEN_EXPIRED</code> th√¨ t·ª± ƒë·ªông ƒë√° user ra trang Login).</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 5.1: X√¢y d·ª±ng H·ªá th·ªëng Custom Exception chu·∫©n Enterprise</h1>
<h3>1. L√Ω thuy·∫øt: T·∫°i sao ph·∫£i &quot;t·ª± ch·∫ø&quot; Exception?</h3>
<p>N·∫øu b·∫°n ch·ªâ d√πng c√°c Exception c√≥ s·∫µn c·ªßa Java (nh∆∞ <code>IllegalArgumentException</code>), b·∫°n s·∫Ω g·∫∑p 2 v·∫•n ƒë·ªÅ:</p>
<ol>
<li><strong>Thi·∫øu ng·ªØ c·∫£nh:</strong> Kh√¥ng ph√¢n bi·ªát ƒë∆∞·ª£c l·ªói n√†y l√† do logic nghi·ªáp v·ª• hay do h·ªá th·ªëng.</li>
<li><strong>Kh√≥ b·∫Øt l·ªói t·∫≠p trung:</strong> Trong <code>@RestControllerAdvice</code>, b·∫°n s·∫Ω ph·∫£i vi·∫øt r·∫•t nhi·ªÅu h√†m <code>handle</code> cho t·ª´ng lo·∫°i Exception nh·ªè l·∫ª.</li>
</ol>
<p><strong>Gi·∫£i ph√°p:</strong> T·∫°o m·ªôt l·ªõp cha duy nh·∫•t (v√≠ d·ª•: <code>AppException</code>) ch·ª©a th√¥ng tin v·ªÅ <strong>ErrorCode</strong> v√† <strong>HTTP Status</strong>.</p>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. ƒê·ªãnh nghƒ©a Danh m·ª•c l·ªói (ErrorCode Enum)</h4>
<p>ƒê√¢y l√† &quot;b·∫£ng m√£&quot; d√πng chung gi·ªØa Backend v√† Frontend.</p>
<pre><code class="language-java">public enum ErrorCode {
    USER_EXISTED(&quot;USER_001&quot;, &quot;User ƒë√£ t·ªìn t·∫°i&quot;, HttpStatus.BAD_REQUEST),
    USER_NOT_FOUND(&quot;USER_002&quot;, &quot;Kh√¥ng t√¨m th·∫•y User&quot;, HttpStatus.NOT_FOUND),
    INSUFFICIENT_BALANCE(&quot;WALLET_001&quot;, &quot;S·ªë d∆∞ kh√¥ng ƒë·ªß&quot;, HttpStatus.PAYMENT_REQUIRED),
    UNCATEGORIZED_EXCEPTION(&quot;SYS_999&quot;, &quot;L·ªói kh√¥ng x√°c ƒë·ªãnh&quot;, HttpStatus.INTERNAL_SERVER_ERROR);

    private final String code;
    private final String message;
    private final HttpStatus statusCode;

    ErrorCode(String code, String message, HttpStatus statusCode) {
        this.code = code;
        this.message = message;
        this.statusCode = statusCode;
    }
    // Getters...
}
</code></pre>
<h4>B. T·∫°o l·ªõp Exception t√πy ch·ªânh</h4>
<p>L·ªõp n√†y s·∫Ω k·∫ø th·ª´a <code>RuntimeException</code> ƒë·ªÉ kh√¥ng b·∫Øt bu·ªôc ph·∫£i <code>try-catch</code> kh·∫Øp n∆°i.</p>
<pre><code class="language-java">@Getter
public class AppException extends RuntimeException {
    private final ErrorCode errorCode;

    public AppException(ErrorCode errorCode) {
        super(errorCode.getMessage());
        this.errorCode = errorCode;
    }
}
</code></pre>
<h4>C. C·∫•u h√¨nh Global Handler ƒë·ªÉ &quot;ƒë·ªçc&quot; Custom Exception</h4>
<p>L√∫c n√†y, c√°i &quot;l∆∞·ªõi&quot; c·ªßa b·∫°n s·∫Ω c·ª±c k·ª≥ g·ªçn g√†ng.</p>
<pre><code class="language-java">@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(AppException.class)
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; handleAppException(AppException ex) {
        ErrorCode errorCode = ex.getErrorCode();
        
        ApiResponse&lt;Object&gt; response = new ApiResponse&lt;&gt;();
        response.setCode(errorCode.getCode());
        response.setMessage(errorCode.getMessage());

        return ResponseEntity
                .status(errorCode.getStatusCode())
                .body(response);
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: X·ª≠ l√Ω s·ªë d∆∞ v√≠ (Fintech App)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Khi user nh·∫•n &quot;Thanh to√°n&quot;, s·ªë d∆∞ trong v√≠ kh√¥ng ƒë·ªß.</li>
<li><strong>Code x·ª≠ l√Ω:</strong> ```java<br>if (balance &lt; price) throw new AppException(ErrorCode.INSUFFICIENT_BALANCE);</li>
</ul>
<pre><code>
</code></pre>
<ul>
<li><strong>K·∫øt qu·∫£:</strong> Frontend nh·∫≠n ƒë∆∞·ª£c JSON <code>{&quot;code&quot;: &quot;WALLET_001&quot;, &quot;message&quot;: &quot;S·ªë d∆∞ kh√¥ng ƒë·ªß&quot;}</code> v·ªõi HTTP <code>402</code>. Frontend ch·ªâ c·∫ßn check <code>if (code === &#39;WALLET_001&#39;)</code> ƒë·ªÉ hi·ªán n√∫t &quot;N·∫°p ti·ªÅn ngay&quot;.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: T√¨m ki·∫øm d·ªØ li·ªáu (Resource Mapping)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User c·ªë t√¨nh thay ƒë·ªïi ID tr√™n URL ƒë·ªÉ truy c·∫≠p v√†o m·ªôt s·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i.</li>
<li><strong>Code x·ª≠ l√Ω:</strong></li>
</ul>
<pre><code class="language-java">Product product = repo.findById(id).orElseThrow(() -&gt; new AppException(ErrorCode.PRODUCT_NOT_FOUND));
</code></pre>
<ul>
<li><strong>K·∫øt qu·∫£:</strong> Tr·∫£ v·ªÅ HTTP <code>404</code>. Frontend s·∫Ω t·ª± ƒë·ªông redirect sang trang &quot;404 Not Found&quot; xinh x·∫Øn thay v√¨ hi·ªán trang tr·∫Øng.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: ƒêƒÉng k√Ω th√†nh vi√™n (Duplicate Entry)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Hai ng∆∞·ªùi c√πng nh·∫•n ƒëƒÉng k√Ω v·ªõi m·ªôt email t·∫°i c√πng m·ªôt th·ªùi ƒëi·ªÉm.</li>
<li><strong>Code x·ª≠ l√Ω:</strong> Trong t·∫ßng Service, tr∆∞·ªõc khi l∆∞u, b·∫°n check <code>existsByEmail</code>. N·∫øu c√≥, <code>throw new AppException(ErrorCode.USER_EXISTED)</code>.</li>
<li><strong>K·∫øt qu·∫£:</strong> Frontend nh·∫≠n l·ªói v√† th√¥ng b√°o ngay t·∫°i √¥ nh·∫≠p li·ªáu: &quot;Email n√†y ƒë√£ c√≥ ng∆∞·ªùi s·ª≠ d·ª•ng&quot;.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh &quot;Tr∆∞·ªõc v√† Sau&quot; khi d√πng Custom Exception</h3>
<table>
<thead>
<tr>
<th>Ti√™u ch√≠</th>
<th>C√°ch l√†m truy·ªÅn th·ªëng</th>
<th>C√°ch l√†m Custom Exception</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Code trong Service</strong></td>
<td><code>throw new RuntimeException(&quot;L·ªói r·ªìi&quot;)</code></td>
<td><code>throw new AppException(ErrorCode.XY_Z)</code></td>
</tr>
<tr>
<td><strong>Th√¥ng tin tr·∫£ v·ªÅ</strong></td>
<td>String message th√¥ s∆°</td>
<td>Object g·ªìm Code, Message, Metadata</td>
</tr>
<tr>
<td><strong>Ph√≠a Frontend</strong></td>
<td>Kh√≥ b·∫Øt l·ªói theo lo·∫°i (ph·∫£i so kh·ªõp chu·ªói)</td>
<td>B·∫Øt l·ªói c·ª±c nhanh qua m√£ Code ƒë·ªãnh s·∫µn</td>
</tr>
<tr>
<td><strong>Maintainability</strong></td>
<td>Ph·∫£i ƒëi s·ª≠a t·ª´ng ch·ªó <code>throw</code></td>
<td>Ch·ªâ c·∫ßn s·ª≠a b·∫£n tin l·ªói t·∫°i m·ªôt file Enum duy nh·∫•t</td>
</tr>
</tbody></table>
<hr>
<p><strong>G·ª£i √Ω cho b·∫°n:</strong> Trong c√°c d·ª± √°n th·ª±c t·∫ø, ng∆∞·ªùi ta th∆∞·ªùng ƒë√≠nh k√®m th√™m m·ªôt tr∆∞·ªùng <code>details</code> ki·ªÉu Map ho·∫∑c List v√†o <code>AppException</code> ƒë·ªÉ ch·ª©a c√°c th√¥ng tin b·ªï sung (v√≠ d·ª•: danh s√°ch c√°c field b·ªã l·ªói validation).</p>
<hr>
<h1>Ch·ªß ƒë·ªÅ 5.2: H·ª£p nh·∫•t Validation v√† Custom Exception</h1>
<p>M·ª•c ti√™u c·ªßa ch√∫ng ta l√† d√π l·ªói g√¨ x·∫£y ra, Frontend lu√¥n nh·∫≠n ƒë∆∞·ª£c:</p>
<pre><code class="language-json">{
  &quot;code&quot;: &quot;ERROR_CODE&quot;,
  &quot;message&quot;: &quot;Th√¥ng b√°o ch√≠nh&quot;,
  &quot;details&quot;: { &quot;field&quot;: &quot;l·ªói chi ti·∫øt&quot; } 
}
</code></pre>
<h3>1. L√Ω thuy·∫øt: C∆° ch·∫ø chuy·ªÉn ƒë·ªïi (Mapping)</h3>
<p>Khi b·ªô l·ªçc <code>@Valid</code> ph√°t hi·ªán d·ªØ li·ªáu sai, n√≥ s·∫Ω n√©m ra <code>MethodArgumentNotValidException</code>. Nhi·ªám v·ª• c·ªßa ch√∫ng ta l√†:</p>
<ol>
<li>B·∫Øt l·∫•y Exception n√†y trong <code>GlobalExceptionHandler</code>.</li>
<li>Tr√≠ch xu·∫•t danh s√°ch c√°c field b·ªã l·ªói v√† message t∆∞∆°ng ·ª©ng.</li>
<li>ƒê√≥ng g√≥i ch√∫ng v√†o c√πng m·ªôt ƒë·ªãnh d·∫°ng m√† <code>AppException</code> ƒëang d√πng.</li>
</ol>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. C·∫≠p nh·∫≠t ErrorCode Enum</h4>
<p>Th√™m m·ªôt m√£ d√†nh ri√™ng cho vi·ªác sai d·ªØ li·ªáu ƒë·∫ßu v√†o.</p>
<pre><code class="language-java">public enum ErrorCode {
    INVALID_INPUT(&quot;VAL_001&quot;, &quot;D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá&quot;, HttpStatus.BAD_REQUEST),
    // ... c√°c code kh√°c
}
</code></pre>
<h4>B. C·∫•u h√¨nh ApiResponse DTO (Generic)</h4>
<p>C·∫•u tr√∫c n√†y s·∫Ω ch·ª©a c·∫£ d·ªØ li·ªáu th√†nh c√¥ng v√† th√¥ng tin l·ªói.</p>
<pre><code class="language-java">@Getter @Setter
@JsonInclude(JsonInclude.Include.NON_NULL) // Ch·ªâ hi·ªán c√°c tr∆∞·ªùng kh√¥ng null
public class ApiResponse&lt;T&gt; {
    private String code = &quot;SUCCESS&quot;; // M·∫∑c ƒë·ªãnh l√† th√†nh c√¥ng
    private String message;
    private T result;
    private Map&lt;String, String&gt; details; // N∆°i ch·ª©a l·ªói validation chi ti·∫øt
}
</code></pre>
<h4>C. X·ª≠ l√Ω t·∫°i GlobalExceptionHandler</h4>
<p>ƒê√¢y l√† n∆°i &quot;h·ª£p nh·∫•t&quot; hai d√≤ng l·ªói v·ªÅ c√πng m·ªôt ƒë·ªãnh d·∫°ng.</p>
<pre><code class="language-java">@RestControllerAdvice
public class GlobalExceptionHandler {

    // 1. X·ª≠ l√Ω l·ªói nghi·ªáp v·ª• (Custom Exception ƒë√£ l√†m ·ªü ph·∫ßn tr∆∞·ªõc)
    @ExceptionHandler(AppException.class)
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; handleAppException(AppException ex) {
        ApiResponse&lt;Object&gt; response = new ApiResponse&lt;&gt;();
        response.setCode(ex.getErrorCode().getCode());
        response.setMessage(ex.getMessage());
        return ResponseEntity.status(ex.getErrorCode().getStatusCode()).body(response);
    }

    // 2. X·ª≠ l√Ω l·ªói Validation (H·ª£p nh·∫•t v√†o ƒë√¢y)
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; handleValidation(MethodArgumentNotValidException ex) {
        Map&lt;String, String&gt; details = new HashMap&lt;&gt;();
        
        // Tr√≠ch xu·∫•t t·ª´ng field b·ªã l·ªói
        ex.getBindingResult().getFieldErrors().forEach(error -&gt; 
            details.put(error.getField(), error.getDefaultMessage())
        );

        ApiResponse&lt;Object&gt; response = new ApiResponse&lt;&gt;();
        response.setCode(ErrorCode.INVALID_INPUT.getCode());
        response.setMessage(ErrorCode.INVALID_INPUT.getMessage());
        response.setDetails(details); // G·∫Øn danh s√°ch l·ªói v√†o ƒë√¢y

        return ResponseEntity.badRequest().body(response);
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Form ƒêƒÉng k√Ω ph·ª©c t·∫°p</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> User nh·∫≠p thi·∫øu Email, Password qu√° ng·∫Øn v√† Age l√† s·ªë √¢m.</li>
<li><strong>K·∫øt qu·∫£:</strong> Frontend nh·∫≠n ƒë∆∞·ª£c JSON:</li>
</ul>
<pre><code class="language-json">{
  &quot;code&quot;: &quot;VAL_001&quot;,
  &quot;message&quot;: &quot;D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá&quot;,
  &quot;details&quot;: {
    &quot;email&quot;: &quot;Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng&quot;,
    &quot;password&quot;: &quot;Password ph·∫£i t·ª´ 8 k√Ω t·ª±&quot;,
    &quot;age&quot;: &quot;Tu·ªïi kh√¥ng ƒë∆∞·ª£c l√† s·ªë √¢m&quot;
  }
}
</code></pre>
<ul>
<li><strong>Frontend X·ª≠ l√Ω:</strong> Ch·ªâ c·∫ßn m·ªôt h√†m <code>mapping</code> duy nh·∫•t ƒë·ªÉ hi·ªÉn th·ªã l·ªói l√™n c√°c input t∆∞∆°ng ·ª©ng.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: Thay ƒë·ªïi ng√¥n ng·ªØ l·ªói (i18n)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën message trong <code>details</code> t·ª± ƒë·ªông ƒë·ªïi sang ti·∫øng Anh ho·∫∑c ti·∫øng Vi·ªát.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·∫°n kh√¥ng c·∫ßn s·ª≠a Handler. Ch·ªâ c·∫ßn t·∫°o c√°c file <code>messages.properties</code> v√† <code>messages_vi.properties</code>. Spring Validation s·∫Ω t·ª± ƒë·ªông l·∫•y message theo ng√¥n ng·ªØ c·ªßa Request v√† ƒë∆∞a v√†o <code>details</code>.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: L·ªói l·ªìng nhau (Nested Objects)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n g·ª≠i l√™n m·ªôt Order c√≥ danh s√°ch nhi·ªÅu <code>OrderItem</code>. M·ªôt item trong ƒë√≥ b·ªã sai gi√°.</li>
<li><strong>Gi·∫£i ph√°p:</strong> B·ªô Handler tr√™n v·∫´n s·∫Ω b·∫Øt ƒë∆∞·ª£c v√† tr·∫£ v·ªÅ <code>details</code> d·∫°ng: <code>&quot;items[0].price&quot;: &quot;Gi√° kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n 0&quot;</code>. Frontend v·∫´n bi·∫øt ch√≠nh x√°c d√≤ng n√†o trong b·∫£ng b·ªã l·ªói.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh cho Dev Frontend</h3>
<table>
<thead>
<tr>
<th>Ti√™u ch√≠</th>
<th>Tr∆∞·ªõc khi h·ª£p nh·∫•t</th>
<th>Sau khi h·ª£p nh·∫•t</th>
</tr>
</thead>
<tbody><tr>
<td><strong>C·∫•u tr√∫c JSON</strong></td>
<td>L√∫c th√¨ m·∫£ng, l√∫c th√¨ object</td>
<td>Lu√¥n lu√¥n l√† m·ªôt chu·∫©n duy nh·∫•t</td>
</tr>
<tr>
<td><strong>Code ph√≠a Frontend</strong></td>
<td>Vi·∫øt nhi·ªÅu <code>if/else</code> cho t·ª´ng lo·∫°i l·ªói</td>
<td>D√πng m·ªôt b·ªô Parser duy nh·∫•t cho m·ªçi API</td>
</tr>
<tr>
<td><strong>Th√¥ng tin chi ti·∫øt</strong></td>
<td>Th∆∞·ªùng ch·ªâ c√≥ message chung</td>
<td>Bi·∫øt ch√≠nh x√°c l·ªói ·ªü ƒë√¢u (field-level)</td>
</tr>
<tr>
<td><strong>ƒê·ªô chuy√™n nghi·ªáp</strong></td>
<td>Gi·ªëng ƒë·ªì √°n sinh vi√™n</td>
<td>ƒê·∫°t chu·∫©n Enterprise/Production</td>
</tr>
</tbody></table>
<hr>
<p><strong>L·ªùi khuy√™n:</strong> Vi·ªác tr·∫£ v·ªÅ <code>details</code> l√† m·ªôt Map r·∫•t ti·ªán cho Web, nh∆∞ng n·∫øu b·∫°n l√†m cho App Mobile, ƒë√¥i khi h·ªç th√≠ch m·ªôt <code>List</code> c√°c Object l·ªói h∆°n. B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng thay ƒë·ªïi ki·ªÉu d·ªØ li·ªáu c·ªßa <code>details</code> trong <code>ApiResponse</code> ƒë·ªÉ ph√π h·ª£p v·ªõi team Frontend c·ªßa m√¨nh.</p>

          </article>

          <!-- Navigation Footer (Next/Prev) -->
          <div class="mt-12 pt-8 border-t border-gray-200 flex justify-between">
            <a href="topic04.html" class="text-indigo-600 font-medium hover:text-indigo-800">‚Üê Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch</a><a href="topic06.html" class="text-indigo-600 font-medium hover:text-indigo-800">Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication) ‚Üí</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div
      onclick="toggleSidebar()"
      id="overlay"
      class="fixed inset-0 bg-black/50 z-10 lg:hidden hidden"
      style="display: none"
    ></div>
    <script>
      // Simple overlay logic
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      // Sync overlay with sidebar state check if needed, but for "simplest" just toggle visibility in CSS or JS.
      // Actually, let's keep it simple.
    </script>
  </body>
</html>
