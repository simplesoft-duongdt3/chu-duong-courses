<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain</title>
    <!-- Tailwind CSS via CDN for simplicity and reliability -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            onclick="toggleSidebar()"
            class="lg:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <a
            href="index.html"
            class="ml-3 lg:ml-0 text-xl font-bold text-gray-900 tracking-tight"
          >
            <span class="text-indigo-600">Spring Boot</span> for Frontend Devs
          </a>
        </div>
        <!-- Optional Top Links -->
        <div class="hidden md:flex space-x-4">
          <a
            href="https://github.com/simplesoft-duongdt3/chu-duong-courses"
            target="_blank"
            class="text-gray-500 hover:text-gray-900 transition font-medium"
            >GitHub</a
          >
        </div>
      </div>
    </header>

    <div class="flex-1 max-w-7xl w-full mx-auto flex items-start">
      <!-- Sidebar Navigation -->
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="fixed inset-0 z-50 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-0 lg:w-64 lg:h-[calc(100vh-4rem)] lg:bg-transparent lg:border-r lg:border-gray-200 lg:sticky lg:top-16 overflow-y-auto"
      >
        <div class="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 mb-2">
            <span class="font-bold text-gray-900">Menu</span>
            <button onclick="toggleSidebar()" class="p-2 -mr-2 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-1">
          <div class="mb-4">
            <p
              class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
            >
              Ch∆∞∆°ng tr√¨nh h·ªçc
            </p>
            <a href="index.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Spring Boot for Frontend Devs
        </a>
<a href="topic01.html" class="block px-2 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 1: Request-Response Cycle & The Middleware Chain
        </a>
<a href="topic02.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI)
        </a>
<a href="topic03.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 3: Persistence v·ªõi Spring Data JPA & Hibernate
        </a>
<a href="topic04.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 4: Transaction Management - Qu·∫£n l√Ω giao d·ªãch
        </a>
<a href="topic05.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 5: Validation & Global Exception Handling
        </a>
<a href="topic06.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 6: Spring Security & JWT (Stateless Authentication)
        </a>
<a href="topic07.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 7: Logging & Monitoring (Actuator)
        </a>
<a href="topic08.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 8: üìò C·∫©m Nang To√†n T·∫≠p: JPA Relationships & Migration
        </a>
<a href="topic09.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 9: Concurrency & Multi-threading
        </a>
<a href="topic10.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 10: Audit Log - Camera gi√°m s√°t Database
        </a>
<a href="topic11.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            Ch·ªß ƒë·ªÅ 11: External API Call & Backend For Frontend (BFF)
        </a>
<a href="topic_black_holes.html" class="block px-2 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 group flex items-center">
            üõ°Ô∏è Spring Boot 3 Survival Guide: 12 "Black Holes" & Deep Debugging
        </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-4 sm:p-6 lg:padding-8">
        <div class="max-w-4xl mx-auto">
          <article
            class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-indigo-600 hover:prose-a:text-indigo-500 prose-img:rounded-xl shadow-none"
          >
            <h1>Ch·ªß ƒë·ªÅ 1: Request-Response Cycle &amp; The Middleware Chain</h1>
<p>Trong Frontend (nh∆∞ React/Vue), b·∫°n ch·ªâ quan t√¢m ƒë·∫øn vi·ªác g·ª≠i Request qua <code>axios</code> v√† nh·∫≠n v·ªÅ JSON. Nh∆∞ng trong Spring Boot, m·ªôt Request ph·∫£i ƒëi qua m·ªôt &quot;ƒë∆∞·ªùng ·ªëng&quot; (pipeline) v·ªõi nhi·ªÅu ch·ªët ch·∫∑n tr∆∞·ªõc khi ƒë·∫øn ƒë∆∞·ª£c logic c·ªßa b·∫°n.</p>
<h3>1. L√Ω thuy·∫øt: Lu·ªìng ƒëi c·ªßa m·ªôt Request</h3>
<p>Khi m·ªôt request HTTP g·ª≠i ƒë·∫øn Spring Boot 3, n√≥ tr·∫£i qua c√°c b∆∞·ªõc sau:</p>
<ol>
<li><strong>Filter (Servlet Filter):</strong> L√† l·ªõp b·∫£o v·ªá ngo√†i c√πng (n·∫±m ·ªü t·∫ßng Servlet Container nh∆∞ Tomcat). N√≥ can thi·ªáp v√†o Request tr∆∞·ªõc c·∫£ khi Spring MVC nh·∫≠n di·ªán ƒë∆∞·ª£c ƒë√≥ l√† g√¨. Th∆∞·ªùng d√πng cho: B·∫£o m·∫≠t (Security), Logging th√¥, CORS.</li>
<li><strong>DispatcherServlet:</strong> &quot;Tr√°i tim&quot; c·ªßa Spring. N√≥ ti·∫øp nh·∫≠n request v√† h·ªèi <strong>Handler Mapping</strong> xem: &quot;C√°i URL n√†y th√¨ th·∫±ng Controller n√†o x·ª≠ l√Ω?&quot;.</li>
<li><strong>Interceptor (HandlerInterceptor):</strong> N·∫±m trong t·∫ßm ki·ªÉm so√°t c·ªßa Spring MVC. N√≥ c√≥ th·ªÉ can thi·ªáp tr∆∞·ªõc (<code>preHandle</code>) v√† sau (<code>postHandle</code>) khi Controller ch·∫°y. Th∆∞·ªùng d√πng cho: Check quy·ªÅn h·∫°n (Authorization), ki·ªÉm tra Header.</li>
<li><strong>Controller:</strong> N∆°i b·∫°n ƒë·ªãnh nghƒ©a API. N√≥ ch·ªâ n√™n l√†m nhi·ªám v·ª• ƒëi·ªÅu h∆∞·ªõng.</li>
<li><strong>Service &amp; Repository:</strong> N∆°i x·ª≠ l√Ω logic v√† DB.</li>
<li><strong>Message Converter:</strong> Chuy·ªÉn ƒë·ªïi Object Java th√†nh JSON (th∆∞·ªùng d√πng th∆∞ vi·ªán Jackson) ƒë·ªÉ tr·∫£ v·ªÅ cho Frontend.</li>
</ol>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. T·∫°o m·ªôt Interceptor ƒë·ªÉ log th·ªùi gian x·ª≠ l√Ω API</h4>
<p>ƒê√¢y l√† th·ª© m√† Dev Frontend r·∫•t c·∫ßn ƒë·ªÉ debug xem t·∫°i sao API ch·∫°y ch·∫≠m.</p>
<pre><code class="language-java">// 1. ƒê·ªãnh nghƒ©a Interceptor
@Component
public class ExecutionTimeInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        long startTime = System.currentTimeMillis();
        request.setAttribute(&quot;startTime&quot;, startTime);
        return true; // Cho ph√©p request ƒëi ti·∫øp
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) {
        long startTime = (long) request.getAttribute(&quot;startTime&quot;);
        long endTime = System.currentTimeMillis();
        System.out.println(&quot;API &quot; + request.getRequestURI() + &quot; processed in: &quot; + (endTime - startTime) + &quot;ms&quot;);
    }
}
</code></pre>
<h4>B. C·∫•u h√¨nh (Configuration)</h4>
<p>ƒê·ªÉ Spring &quot;bi·∫øt&quot; v√† s·ª≠ d·ª•ng Interceptor tr√™n, b·∫°n ph·∫£i ƒëƒÉng k√Ω n√≥.</p>
<pre><code class="language-java">@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private ExecutionTimeInterceptor executionTimeInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // √Åp d·ª•ng cho t·∫•t c·∫£ c√°c API b·∫Øt ƒë·∫ßu b·∫±ng /api/
        registry.addInterceptor(executionTimeInterceptor).addPathPatterns(&quot;/api/**&quot;);
    }
}
</code></pre>
<h4>C. Controller m·∫´u</h4>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;/api&quot;)
public class ProductController {

    @GetMapping(&quot;/products&quot;)
    public ResponseEntity&lt;List&lt;String&gt;&gt; getProducts() {
        return ResponseEntity.ok(List.of(&quot;iPhone 15&quot;, &quot;Macbook M3&quot;, &quot;iPad Pro&quot;));
    }
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Ki·ªÉm tra &quot;App-Version&quot; t·ª´ Mobile/Frontend</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën t·∫•t c·∫£ c√°c request t·ª´ App ph·∫£i ƒë√≠nh k√®m Header <code>X-App-Version</code>. N·∫øu kh√¥ng c√≥ ho·∫∑c phi√™n b·∫£n qu√° c≈©, Backend s·∫Ω t·ª´ ch·ªëi ngay l·∫≠p t·ª©c ƒë·ªÉ tr√°nh l·ªói logic.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Vi·∫øt m·ªôt <strong>Interceptor</strong>. N·∫øu Header thi·∫øu, tr·∫£ v·ªÅ <code>400 Bad Request</code> ho·∫∑c <code>426 Upgrade Required</code> ngay t·∫°i <code>preHandle</code>, kh√¥ng c·∫ßn ƒë·ªÉ request ch·∫°y v√†o t·∫≠n Controller t·ªën t√†i nguy√™n.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: X·ª≠ l√Ω ƒëa ng√¥n ng·ªØ (Internationalization - i18n)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Frontend g·ª≠i Header <code>Accept-Language: vi</code>. B·∫°n mu·ªën to√†n b·ªô th√¥ng b√°o l·ªói tr·∫£ v·ªÅ ph·∫£i l√† ti·∫øng Vi·ªát.</li>
<li><strong>Gi·∫£i ph√°p:</strong> S·ª≠ d·ª•ng <code>LocaleChangeInterceptor</code>. N√≥ s·∫Ω t·ª± ƒë·ªông b·∫Øt Header n√†y, set v√†o <code>LocaleContextHolder</code>. Khi ƒë√≥, ·ªü b·∫•t k·ª≥ t·∫ßng n√†o (Service/Controller), b·∫°n ch·ªâ c·∫ßn g·ªçi <code>messageSource.getMessage(...)</code> l√† c√≥ ƒë√∫ng ng√¥n ng·ªØ user c·∫ßn.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Tracking User Activity (Audit Log)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> S·∫øp mu·ªën bi·∫øt User ID n√†o ƒë√£ g·ªçi API n√†o, v√†o l√∫c n√†o ƒë·ªÉ th·ªëng k√™ h√†nh vi.</li>
<li><strong>Gi·∫£i ph√°p:</strong> S·ª≠ d·ª•ng <strong>Filter</strong> (v√¨ n√≥ b·∫Øt ƒë∆∞·ª£c c·∫£ nh·ªØng request l·ªói ho·∫∑c request kh√¥ng t·ªìn t·∫°i - 404). T·∫°i Filter, b·∫°n l·∫•y <code>Principal</code> (User hi·ªán t·∫°i) t·ª´ <code>SecurityContext</code> v√† l∆∞u th√¥ng tin Request URL v√†o database ho·∫∑c ƒë·∫©y v√†o Kafka/Logstash.</li>
</ul>
<hr>
<p>ƒê·ªÉ ti·∫øp n·ªëi ch·ªß ƒë·ªÅ <strong>Request-Response Cycle</strong>, ch√∫ng ta s·∫Ω ƒëi s√¢u v√†o hai &quot;√¥ng tr√πm&quot; ƒë·ª©ng ·ªü ti·ªÅn tuy·∫øn c·ªßa Spring Boot: <strong>Filter</strong> v√† <strong>DispatcherServlet</strong>.</p>
<p>N·∫øu b·∫°n t·ª´ Frontend chuy·ªÉn qua:</p>
<ul>
<li><strong>Filter</strong> gi·ªëng nh∆∞ m·ªôt c√°i Proxy ho·∫∑c Middleware ·ªü t·∫ßng th·∫•p nh·∫•t (nh∆∞ Nginx hay Cloudflare Rules).</li>
<li><strong>DispatcherServlet</strong> gi·ªëng nh∆∞ b·ªô Router trung t√¢m (nh∆∞ React Router nh∆∞ng ·ªü ph√≠a Server) c√≥ nhi·ªám v·ª• t√¨m xem Component n√†o s·∫Ω x·ª≠ l√Ω URL n√†y.</li>
</ul>
<hr>
<h1>Ch·ªß ƒë·ªÅ 1 (Ti·∫øp theo): Filter &amp; DispatcherServlet</h1>
<h3>1. L√Ω thuy·∫øt: Ai m·∫°nh h∆°n ai?</h3>
<ul>
<li><p><strong>Filter (Servlet Filter):</strong></p>
</li>
<li><p>N·∫±m ngo√†i c√πng, thu·ªôc v·ªÅ <strong>Servlet Container</strong> (Tomcat).</p>
</li>
<li><p>N√≥ kh√¥ng bi·∫øt g√¨ v·ªÅ c√°c Controller c·ªßa Spring. N√≥ ch·ªâ th·∫•y m·ªôt &quot;c·ª•c&quot; HTTP Request th√¥.</p>
</li>
<li><p>Ph√π h·ª£p cho c√°c t√°c v·ª• &quot;vƒ© m√¥&quot;: B·∫£o m·∫≠t (Spring Security th·ª±c ch·∫•t l√† m·ªôt chu·ªói Filter), n√©n d·ªØ li·ªáu (Gzip), Log IP kh√°ch truy c·∫≠p.</p>
</li>
<li><p><strong>DispatcherServlet:</strong></p>
</li>
<li><p>L√† m·ªôt <strong>Servlet</strong> duy nh·∫•t, ƒë√≥ng vai tr√≤ &quot;Front Controller&quot;.</p>
</li>
<li><p>N√≥ l√† c·∫ßu n·ªëi gi·ªØa HTTP th√¥ v√† th·∫ø gi·ªõi Object-Oriented c·ªßa Spring.</p>
</li>
<li><p>N√≥ s·∫Ω h·ªèi <code>HandlerMapping</code> ƒë·ªÉ t√¨m Controller v√† <code>HandlerAdapter</code> ƒë·ªÉ th·ª±c thi Controller ƒë√≥.</p>
</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh</h3>
<h4>A. Filter: G·∫Øn &quot;Trace-ID&quot; v√†o m·ªçi Request</h4>
<p>ƒê·ªÉ debug h·ªá th·ªëng l·ªõn, ta c·∫ßn m·ªôt m√£ ƒë·ªãnh danh (Trace-ID) xuy√™n su·ªët t·ª´ Request t·ªõi Log.</p>
<pre><code class="language-java">import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletResponse;
import org.slf4j.MDC;
import org.springframework.stereotype.Component;
import java.io.IOException;
import java.util.UUID;

@Component
public class TraceIdFilter implements Filter {
    
    private static final String TRACE_ID_HEADER = &quot;X-Trace-Id&quot;;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) 
            throws IOException, ServletException {
        
        // 1. T·∫°o m·ªôt m√£ ID ng·∫´u nhi√™n
        String traceId = UUID.randomUUID().toString();
        
        // 2. G·∫Øn v√†o MDC (Mapped Diagnostic Context) ƒë·ªÉ m·ªçi d√≤ng Log sau n√†y ƒë·ªÅu c√≥ ID n√†y
        MDC.put(&quot;traceId&quot;, traceId);
        
        // 3. G·∫Øn v√†o Header c·ªßa Response tr·∫£ v·ªÅ cho Frontend d·ªÖ ki·ªÉm tra
        HttpServletResponse httpServletResponse = (HttpServletResponse) response;
        httpServletResponse.setHeader(TRACE_ID_HEADER, traceId);

        try {
            // Cho ph√©p request ƒëi ti·∫øp v√†o DispatcherServlet
            chain.doFilter(request, response);
        } finally {
            // X√≥a sau khi xong ƒë·ªÉ tr√°nh memory leak trong ThreadPool
            MDC.remove(&quot;traceId&quot;);
        }
    }
}
</code></pre>
<h4>B. DispatcherServlet: C·∫•u h√¨nh t√πy ch·ªânh</h4>
<p>Th∆∞·ªùng b·∫°n kh√¥ng vi·∫øt code cho <code>DispatcherServlet</code> v√¨ Spring Boot ƒë√£ l√†m s·∫µn. Tuy nhi√™n, b·∫°n s·∫Ω c·∫ßn c·∫•u h√¨nh n√≥ qua file <code>application.properties</code> ƒë·ªÉ ki·ªÉm so√°t c√°c t√¨nh hu·ªëng ƒë·∫∑c bi·ªát.</p>
<pre><code class="language-properties"># V√≠ d·ª•: N·∫øu kh√¥ng t√¨m th·∫•y Controller n√†o kh·ªõp v·ªõi URL, 
# thay v√¨ hi·ªán trang 404 m·∫∑c ƒë·ªãnh, h√£y n√©m ra m·ªôt Exception ƒë·ªÉ ta x·ª≠ l√Ω Global.
spring.mvc.throw-exception-if-no-handler-found=true
spring.web.resources.add-mappings=false
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: Ch·ªëng t·∫•n c√¥ng Brute Force / Rate Limiting (T·∫ßng Filter)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën ch·∫∑n ngay c√°c IP g·ª≠i 1000 request/gi√¢y tr∆∞·ªõc khi n√≥ l√†m treo Database.</li>
<li><strong>Gi·∫£i ph√°p:</strong> D√πng <strong>Filter</strong>. V√¨ Filter ch·∫°y tr∆∞·ªõc khi v√†o Spring MVC, b·∫°n c√≥ th·ªÉ check IP trong Redis, n·∫øu v∆∞·ª£t qu√° gi·ªõi h·∫°n, tr·∫£ v·ªÅ <code>429 Too Many Requests</code> ngay l·∫≠p t·ª©c. ƒêi·ªÅu n√†y b·∫£o v·ªá CPU c·ªßa server kh√¥ng ph·∫£i ch·∫°y c√°c logic ph·ª©c t·∫°p trong Controller.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: X·ª≠ l√Ω file Upload qu√° l·ªõn (T·∫ßng DispatcherServlet)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> Frontend g·ª≠i m·ªôt file 1GB l√™n trong khi b·∫°n ch·ªâ cho ph√©p 10MB.</li>
<li><strong>Gi·∫£i ph√°p:</strong> <code>DispatcherServlet</code> s·ª≠ d·ª•ng <code>MultipartResolver</code> ƒë·ªÉ parse file. B·∫°n c·∫•u h√¨nh trong <code>application.properties</code>. Khi file qu√° l·ªõn, <code>DispatcherServlet</code> s·∫Ω n√©m l·ªói <code>MaxUploadSizeExceededException</code> tr∆∞·ªõc c·∫£ khi n√≥ t√¨m th·∫•y Service c·ªßa b·∫°n.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 3: Centralized Error Handling (S·ª± k·∫øt h·ª£p)</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n mu·ªën m·ªçi l·ªói (404, 500, Validate l·ªói) ƒë·ªÅu tr·∫£ v·ªÅ m·ªôt format JSON chung cho App d·ªÖ ƒë·ªçc: <code>{&quot;code&quot;: &quot;ERR_001&quot;, &quot;message&quot;: &quot;...&quot;}</code>.</li>
<li><strong>Gi·∫£i ph√°p:</strong> <code>DispatcherServlet</code> s·∫Ω chuy·ªÉn h∆∞·ªõng m·ªçi Exception v·ªÅ m·ªôt <code>@RestControllerAdvice</code>. T·∫°i ƒë√¢y, b·∫°n &quot;t√∫m&quot; c·ªï t·∫•t c·∫£ c√°c l·ªói x·∫£y ra trong lu·ªìng ƒë·ªÉ format l·∫°i JSON tr∆∞·ªõc khi g·ª≠i v·ªÅ cho Frontend.</li>
</ul>
<hr>
<h3>T√≥m t·∫Øt so s√°nh cho Dev Frontend</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>Filter (V√≤ng ngo√†i)</th>
<th>DispatcherServlet (V√≤ng trong)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Bi·∫øt v·ªÅ User?</strong></td>
<td>Ch∆∞a (Tr·ª´ khi b·∫°n parse Token th·ªß c√¥ng)</td>
<td>C√≥ (ƒê√£ c√≥ th√¥ng tin SecurityContext)</td>
</tr>
<tr>
<td><strong>Bi·∫øt v·ªÅ Controller?</strong></td>
<td>Kh√¥ng</td>
<td>C√≥ (Bi·∫øt r√µ method n√†o s·∫Øp ch·∫°y)</td>
</tr>
<tr>
<td><strong>Tr·∫£ v·ªÅ JSON?</strong></td>
<td>Ph·∫£i d√πng <code>ObjectMapper</code> vi·∫øt tay</td>
<td>Ch·ªâ c·∫ßn <code>return Object</code> l√† xong</td>
</tr>
<tr>
<td><strong>N√™n d√πng khi n√†o?</strong></td>
<td>CORS, Log IP, Auth th√¥, N√©n ·∫£nh</td>
<td>Validation, Business Logic, Format Data</td>
</tr>
</tbody></table>
<hr>
<h1>Ch·ªß ƒë·ªÅ 1.2: B·∫£o m·∫≠t t·∫ßng giao ti·∫øp - CORS &amp; CSRF</h1>
<h3>1. Gi·∫£i th√≠ch chi ti·∫øt c√°c thu·∫≠t ng·ªØ</h3>
<h4><strong>CORS (Cross-Origin Resource Sharing)</strong></h4>
<ul>
<li><p><strong>N√≥ l√† g√¨?</strong> L√† m·ªôt c∆° ch·∫ø b·∫£o m·∫≠t c·ªßa <strong>Tr√¨nh duy·ªát</strong> (kh√¥ng ph·∫£i c·ªßa Server). N√≥ ngƒÉn ch·∫∑n c√°c trang web t·∫£i t√†i nguy√™n t·ª´ m·ªôt &quot;Origin&quot; kh√°c v·ªõi Origin c·ªßa ch√≠nh n√≥.</p>
</li>
<li><p><strong>Origin l√† g√¨?</strong> G·ªìm 3 th√†nh ph·∫ßn: <code>Protocol</code> + <code>Domain</code> + <code>Port</code>.</p>
</li>
<li><p>V√≠ d·ª•: <code>http://localhost:3000</code> (React) v√† <code>http://localhost:8080</code> (Spring Boot) l√† <strong>kh√°c Origin</strong> v√¨ l·ªách Port.</p>
</li>
<li><p><strong>C∆° ch·∫ø ho·∫°t ƒë·ªông:</strong> Khi b·∫°n g·ªçi API kh√°c Origin, tr√¨nh duy·ªát s·∫Ω g·ª≠i m·ªôt request &quot;nh√°p&quot; g·ªçi l√† <strong>Preflight Request</strong> (ph∆∞∆°ng th·ª©c <code>OPTIONS</code>) ƒë·ªÉ h·ªèi Server: &quot;T√¥i l√† th·∫±ng <code>localhost:3000</code>, t√¥i c√≥ ƒë∆∞·ª£c ph√©p l·∫•y data kh√¥ng?&quot;. N·∫øu Server kh√¥ng tr·∫£ l·ªùi ƒë√∫ng c√°c Header cho ph√©p, tr√¨nh duy·ªát s·∫Ω ch·∫∑n k·∫øt qu·∫£ API ƒë√≥ l·∫°i.</p>
</li>
</ul>
<h4><strong>CSRF (Cross-Site Request Forgery)</strong></h4>
<ul>
<li><strong>N√≥ l√† g√¨?</strong> &quot;T·∫•n c√¥ng gi·∫£ m·∫°o y√™u c·∫ßu ch√©o trang&quot;. ƒê√¢y l√† k·ªãch b·∫£n k·∫ª x·∫•u l·ª£i d·ª•ng vi·ªác b·∫°n ƒë√£ ƒëƒÉng nh·∫≠p v√†o m·ªôt trang web (v√≠ d·ª•: <code>nganhang.com</code>) v√† d√πng cookie c·ªßa b·∫°n ƒë·ªÉ g·ª≠i y√™u c·∫ßu b·∫•t h·ª£p ph√°p t·ª´ m·ªôt trang web kh√°c.</li>
<li><strong>V√≠ d·ª•:</strong> B·∫°n ƒëang ƒëƒÉng nh·∫≠p ng√¢n h√†ng, sau ƒë√≥ b·∫•m v√†o m·ªôt link &quot;Tr√∫ng th∆∞·ªüng&quot; ·ªü trang web l·∫°. Trang web ƒë√≥ ch·∫°y ng·∫ßm m·ªôt ƒëo·∫°n code g·ª≠i request <code>POST</code> t·ªõi <code>nganhang.com/transfer?amount=1000</code> ƒë·ªÉ chuy·ªÉn ti·ªÅn. V√¨ tr√¨nh duy·ªát t·ª± ƒë·ªông ƒë√≠nh k√®m Cookie c·ªßa b·∫°n, ng√¢n h√†ng t∆∞·ªüng ƒë√≥ l√† b·∫°n th·∫≠t.</li>
<li><strong>C√°ch ch·ªëng:</strong> Server c·∫•p cho Frontend m·ªôt c√°i &quot;m·∫≠t m√£&quot; g·ªçi l√† <strong>CSRF Token</strong>. M·ªói khi g·ª≠i request thay ƒë·ªïi d·ªØ li·ªáu (POST, PUT, DELETE), Frontend ph·∫£i g·ª≠i k√®m Token n√†y. K·∫ª x·∫•u ·ªü trang web kh√°c s·∫Ω kh√¥ng th·ªÉ bi·∫øt Token n√†y ƒë·ªÉ gi·∫£ m·∫°o.</li>
</ul>
<hr>
<h3>2. V√≠ d·ª• Code &amp; C·∫•u h√¨nh trong Spring Boot 3</h3>
<p>Trong Spring Boot 3, c·∫•u h√¨nh b·∫£o m·∫≠t n·∫±m t·∫≠p trung ·ªü t·∫ßng <strong>Spring Security</strong>.</p>
<h4><strong>C·∫•u h√¨nh CORS (Cho ph√©p Frontend truy c·∫≠p)</strong></h4>
<p>B·∫°n c√≥ th·ªÉ c·∫•u h√¨nh global trong m·ªôt Bean <code>SecurityFilterChain</code>.</p>
<pre><code class="language-java">@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .cors(cors -&gt; cors.configurationSource(request -&gt; {
                CorsConfiguration config = new CorsConfiguration();
                config.setAllowedOrigins(List.of(&quot;http://localhost:3000&quot;)); // Ch·ªâ cho ph√©p React
                config.setAllowedMethods(List.of(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;));
                config.setAllowedHeaders(List.of(&quot;*&quot;));
                config.setAllowCredentials(true); // Quan tr·ªçng n·∫øu d√πng Cookie/Auth Header
                return config;
            }))
            // ... c√°c c·∫•u h√¨nh kh√°c
        return http.build();
    }
}
</code></pre>
<h4><strong>C·∫•u h√¨nh CSRF</strong></h4>
<p>Th√¥ng th∆∞·ªùng, n·∫øu b·∫°n l√†m API cho Mobile ho·∫∑c d√πng Token (JWT) l∆∞u trong LocalStorage thay v√¨ Cookie, b·∫°n c√≥ th·ªÉ t·∫Øt CSRF (v√¨ JWT kh√¥ng t·ª± ƒë·ªông ƒë√≠nh k√®m nh∆∞ Cookie n√™n kh√¥ng s·ª£ CSRF).</p>
<pre><code class="language-java">@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .csrf(csrf -&gt; csrf.disable()) // T·∫Øt n·∫øu d√πng JWT/Stateless API
        // .csrf(csrf -&gt; csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())) // B·∫≠t n·∫øu d√πng Cookie/Session
    return http.build();
}
</code></pre>
<hr>
<h3>3. T√¨nh hu·ªëng th·ª±c t·∫ø (Real-world Scenarios)</h3>
<p><strong>T√¨nh hu·ªëng 1: L·ªói &quot;CORS error&quot; khi v·ª´a m·ªõi Deploy</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> ·ªû m√°y local, b·∫°n c·∫•u h√¨nh <code>allowedOrigins(&quot;*&quot;)</code> n√™n ch·∫°y ngon. Khi l√™n Production, b·∫°n ƒë·ªïi domain Backend th√†nh <code>api.myapp.com</code> v√† Frontend th√†nh <code>myapp.com</code>. Tr√¨nh duy·ªát l·∫≠p t·ª©c ch·∫∑n API.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Ph·∫£i li·ªát k√™ ch√≠nh x√°c domain Production v√†o danh s√°ch <code>AllowedOrigins</code>. ƒê·ª´ng d√πng <code>*</code> ·ªü Production v√¨ n√≥ c·ª±c k·ª≥ k√©m b·∫£o m·∫≠t.</li>
</ul>
<p><strong>T√¨nh hu·ªëng 2: T·∫°i sao GET ch·∫°y ƒë∆∞·ª£c m√† POST/PUT l·∫°i b·ªã l·ªói 403?</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> ƒê√¢y l√† d·∫•u hi·ªáu c·ªßa vi·ªác <strong>CSRF ƒëang b·∫≠t</strong>. Theo m·∫∑c ƒë·ªãnh c·ªßa Spring Security, c√°c ph∆∞∆°ng th·ª©c &quot;ƒë·ªçc&quot; (GET, HEAD, OPTIONS) kh√¥ng c·∫ßn Token, nh∆∞ng c√°c ph∆∞∆°ng th·ª©c &quot;ghi&quot; (POST, PUT, DELETE) b·∫Øt bu·ªôc ph·∫£i c√≥ CSRF Token.</li>
<li><strong>Gi·∫£i ph√°p:</strong> 1. N·∫øu d√πng Cookie: Frontend ph·∫£i l·∫•y Token t·ª´ Cookie v√† g·ª≠i ng∆∞·ª£c l√™n Header <code>X-XSRF-TOKEN</code>.</li>
</ul>
<ol start="2">
<li>N·∫øu d√πng JWT: T·∫Øt CSRF trong config v√¨ JWT b·∫£n ch·∫•t ƒë√£ ch·ªëng ƒë∆∞·ª£c CSRF (do k·∫ª t·∫•n c√¥ng kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c JWT trong LocalStorage c·ªßa b·∫°n).</li>
</ol>
<p><strong>T√¨nh hu·ªëng 3: Mobile App kh√¥ng b·ªã l·ªói CORS nh∆∞ng Web App th√¨ c√≥</strong></p>
<ul>
<li><strong>V·∫•n ƒë·ªÅ:</strong> B·∫°n ph√°t tri·ªÉn m·ªôt ·ª©ng d·ª•ng Mobile (Flutter/React Native) g·ªçi API b√¨nh th∆∞·ªùng, nh∆∞ng khi l√†m b·∫£n Web th√¨ b·ªã l·ªói CORS.</li>
<li><strong>Gi·∫£i ph√°p:</strong> Hi·ªÉu r·∫±ng <strong>CORS l√† lu·∫≠t c·ªßa Tr√¨nh duy·ªát</strong>. Mobile App kh√¥ng ch·∫°y tr√™n tr√¨nh duy·ªát n√™n n√≥ kh√¥ng quan t√¢m ƒë·∫øn c√°c Header CORS. ƒêi·ªÅu n√†y gi·∫£i th√≠ch t·∫°i sao c√πng m·ªôt API m√† Web l·ªói c√≤n Mobile th√¨ kh√¥ng. ƒê·ª´ng v√¨ th·∫•y Mobile ch·∫°y ƒë∆∞·ª£c m√† nghƒ© Backend ƒë√£ ·ªïn.</li>
</ul>
<hr>
<h3>B·∫£ng so s√°nh nhanh</h3>
<table>
<thead>
<tr>
<th>ƒê·∫∑c ƒëi·ªÉm</th>
<th>CORS</th>
<th>CSRF</th>
</tr>
</thead>
<tbody><tr>
<td><strong>B·∫£n ch·∫•t</strong></td>
<td>Cho ph√©p chia s·∫ª t√†i nguy√™n</td>
<td>NgƒÉn ch·∫∑n gi·∫£ m·∫°o y√™u c·∫ßu</td>
</tr>
<tr>
<td><strong>ƒê·ªëi t∆∞·ª£ng th·ª±c thi</strong></td>
<td>Tr√¨nh duy·ªát (Browser)</td>
<td>Server (Spring Security)</td>
</tr>
<tr>
<td><strong>D·∫•u hi·ªáu l·ªói</strong></td>
<td>Console hi·ªán &quot;Blocked by CORS policy&quot;</td>
<td>API tr·∫£ v·ªÅ 403 Forbidden</td>
</tr>
<tr>
<td><strong>C√°ch x·ª≠ l√Ω ph·ªï bi·∫øn</strong></td>
<td>Th√™m Header <code>Access-Control-Allow-Origin</code></td>
<td>D√πng CSRF Token ho·∫∑c d√πng JWT (Stateless)</td>
</tr>
</tbody></table>
<hr>

          </article>

          <!-- Navigation Footer (Next/Prev) -->
          <div class="mt-12 pt-8 border-t border-gray-200 flex justify-between">
            <a href="index.html" class="text-indigo-600 font-medium hover:text-indigo-800">‚Üê Spring Boot for Frontend Devs</a><a href="topic02.html" class="text-indigo-600 font-medium hover:text-indigo-800">Ch·ªß ƒë·ªÅ 2: IoC Container & Dependency Injection (DI) ‚Üí</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div
      onclick="toggleSidebar()"
      id="overlay"
      class="fixed inset-0 bg-black/50 z-10 lg:hidden hidden"
      style="display: none"
    ></div>
    <script>
      // Simple overlay logic
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      // Sync overlay with sidebar state check if needed, but for "simplest" just toggle visibility in CSS or JS.
      // Actually, let's keep it simple.
    </script>
  </body>
</html>
